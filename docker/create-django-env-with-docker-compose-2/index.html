<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Docker Compose で Django 環境をつくろう その2/fuminote</title>
<link rel="shortcut icon" href="../../assets/icons/favicon.ico">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Griffy">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link rel="stylesheet" href="../../assets/css/style.css?20190603">
</head>
<body>
    <div class="container">
      <div class="header"><header class="item item-header"><h1>
    <a href="../../">
      <img class="logo" src="../../assets/images/inuu.png" alt="犬"></a>
  </h1>
  <nav class="nav"><ul>
<li class="nav-category"><a href="../../">HOME</a></li>
    </ul></nav><iframe src="../../tags/" class="tags-frame"></iframe>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-docker"><time class="date" datetime="2019-05-01 00:00:00+09:00">
      2019-05-01 Wed
    </time><div class="title">Docker Compose で Django 環境をつくろう その2</div>
    <div class="category">
      <a href="../../tags/docker/">
          docker
      </a>
    </div>
    <div class="text">
      <div>
<details><summary>目次</summary><div class="contents topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id11">リファレンス・参考サイト書籍</a></li>
<li>
<a class="reference internal" href="#id3" id="id12">つくりかた</a><ul>
<li><a class="reference internal" href="#id4" id="id13">構成</a></li>
<li><a class="reference internal" href="#id5" id="id14">設定ファイル</a></li>
<li><a class="reference internal" href="#id6" id="id15">起動</a></li>
</ul>
</li>
<li>
<a class="reference internal" href="#id7" id="id16">つかいかた</a><ul>
<li><a class="reference internal" href="#app" id="id17">app コンテナ</a></li>
<li><a class="reference internal" href="#mysql-postgresql" id="id18">MySQL, PostgreSQL コンテナ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8" id="id19">感想</a></li>
<li>
<a class="reference internal" href="#id9" id="id20">その他</a><ul>
<li>
<a class="reference internal" href="#id10" id="id21">Python 公式イメージのルーツ</a><ul>
<li><a class="reference internal" href="#docker-hub" id="id22">Docker Hub</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</details><div class="section" id="id2">
<h2><a class="toc-backref" href="#id11">リファレンス・参考サイト書籍</a></h2>
<p>ありがとうございました</p>
<ul>
<li>
<p class="first">Python プロフェッショナルプログラミング第３版 &gt; 01-01 Python のセットアップ</p>
</li>
<li>
<p class="first"><a class="reference external" href="https://hub.docker.com/_/ubuntu">ubuntu Docker Official Images</a></p>
<ul class="simple">
<li>
<tt class="docutils literal">en_US.utf8</tt> を <tt class="docutils literal"><span class="pre">apt-get</span></tt> するくだりを参考にした<ul>
<li>Ubuntu イメージにはデフォルトで <tt class="docutils literal">C</tt>, <tt class="docutils literal"><span class="pre">C.UTF-8</span></tt>, and <tt class="docutils literal">POSIX</tt> locales が含まれている、これで UTF-8 locale を使うほとんどのひとには十分なはずだけれども、</li>
<li>足りない場合は、<tt class="docutils literal">locales</tt> package からインストールしてね</li>
</ul>
</li>
</ul>
</li>
<li>
<p class="first"><a class="reference external" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Best practices for writing Dockerfiles</a></p>
<ul>
<li>
<p class="first"><tt class="docutils literal">RUN</tt> で <tt class="docutils literal"><span class="pre">apt-get</span></tt> するときはこうすると良さそう</p>
<ul class="simple">
<li>
<tt class="docutils literal"><span class="pre">apt-get</span> upgrade</tt> , <tt class="docutils literal"><span class="pre">dist-upgrade</span></tt> するのは避けよう</li>
<li>
<tt class="docutils literal"><span class="pre">apt-get</span> update &amp;&amp; <span class="pre">apt-get</span> install <span class="pre">-y</span></tt> はセットでやろう<ul>
<li>こうすると、 latest package versions が install できる</li>
<li>このテクニックは、 <tt class="docutils literal">cache busting</tt> として知られているらしい</li>
</ul>
</li>
<li>packages はアルファベット順に並べる<ul>
<li>重複に気づけるし、後から足したり減らしたりするのが容易になるから</li>
</ul>
</li>
<li>最後に <tt class="docutils literal">rm <span class="pre">-rf</span> /var/lib/apt/lists/*</tt> して apt キャッシュを clean up すると、 image size を減らせる</li>
</ul>
</li>
<li>
<p class="first">良い見本</p>
<pre class="code docker"><a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-1"></a><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-2"></a>    aufs-tools <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-3"></a>    automake <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-4"></a>    build-essential <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-5"></a>    curl <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-6"></a>    dpkg-sig <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-7"></a>    libcap-dev <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-8"></a>    libsqlite3-dev <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-9"></a>    mercurial <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-10"></a>    reprepro <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-11"></a>    ruby1.9.1 <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-12"></a>    ruby1.9.1-dev <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-13"></a>    <span class="nv">s3cmd</span><span class="o">=</span><span class="m">1</span>.1.* <span class="se">\</span>
<a name="rest_code_eab151bfeea94e8bbfa4fd44a3d5564e-14"></a> <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
</pre>
</li>
</ul>
</li>
<li>
<p class="first"><a class="reference external" href="https://docs.docker.com/develop/dev-best-practices/">Docker development best practices</a></p>
<ul>
<li>
<p class="first"><tt class="docutils literal">RUN</tt> で <tt class="docutils literal"><span class="pre">apt-get</span></tt> するときはこうすると良さそう</p>
<ul>
<li>
<p class="first">2行で書くより、1行で書く</p>
</li>
<li>
<p class="first">1行で書くと、イメージを小さくできる ( <tt class="docutils literal">layers</tt> がなんのことなのかはよくわからない)</p>
</li>
<li>
<p class="first"><cite>The first creates two layers in the image, while the second only creates one.</cite></p>
<pre class="code docker"><a name="rest_code_5574dfde3476419f9dd2dbc0aa795a9d-1"></a><span class="k">RUN</span> apt-get -y update
<a name="rest_code_5574dfde3476419f9dd2dbc0aa795a9d-2"></a><span class="k">RUN</span> apt-get install -y python
</pre>
<pre class="code docker"><a name="rest_code_246cc4b471fd48e1a0fdcac4f0848fa3-1"></a><span class="k">RUN</span> apt-get -y update <span class="o">&amp;&amp;</span> apt-get install -y python
</pre>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p class="first"><a class="reference external" href="https://github.com/righ/djample/">くろのて勉強会 &gt; DRF勉強会 (全6回) &gt; djample</a></p>
</li>
<li>
<p class="first">現場で使える Django の教科書 &gt; D: Docker でラクラク開発</p>
</li>
<li>
<p class="first"><a class="reference external" href="https://qiita.com/yagince/items/deba267f789604643bab">Docker Ubuntu18.04でtzdataをinstallするときにtimezoneの選択をしないでinstallする</a></p>
<ul class="simple">
<li>途中で何も尋ねてほしくないときは、 <tt class="docutils literal">ENV DEBIAN_FRONTEND=noninteractive</tt> すると良さそう</li>
</ul>
</li>
<li>
<p class="first"><a class="reference external" href="https://stackoverflow.com/questions/27022373/python3-importerror-no-module-named-ctypes-when-using-value-from-module-mul/48045929">ModuleNotFoundError: No module named '_ctypes' の解決方法</a></p>
<ul class="simple">
<li>事前に <tt class="docutils literal"><span class="pre">libffi-dev</span></tt> パッケージのインストールが必要</li>
</ul>
</li>
<li>
<p class="first"><a class="reference external" href="https://www.t3a.jp/blog/infrastructure/set-timezone/">[Linux]タイムゾーン(Timezone)をUTCから日本標準時(JST)に変更する</a></p>
<ul class="simple">
<li>シンボリックリンクを張り替える</li>
<li><tt class="docutils literal">ln <span class="pre">-sf</span> /usr/share/zoneinfo/Asia/Tokyo /etc/localtime</tt></li>
</ul>
</li>
<li>
<p class="first"><a class="reference external" href="https://docs.python.org/ja/3/using/unix.html#building-python">2.2. Python のビルド</a></p>
<ul class="simple">
<li>
<tt class="docutils literal">make install</tt> の代わりに <tt class="docutils literal">make altinstall</tt> 推奨</li>
<li>
<cite>警告 make install は python3 バイナリを上書きまたはリンクを破壊してしまうかもしれません。そのため、make install の代わりに exec_prefix/bin/pythonversion のみインストールする make altinstall が推奨されています。</cite> だそうです。</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id12">つくりかた</a></h2>
<p>実際には、 PostgreSQL か MySQL かどちらか使うほうのみを生きとする。</p>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id13">構成</a></h3>
<pre class="code bash"><a name="rest_code_3c43283c3b954bc5aea2ced288a263b9-1"></a>$ tree fufufu
<a name="rest_code_3c43283c3b954bc5aea2ced288a263b9-2"></a>fufufu
<a name="rest_code_3c43283c3b954bc5aea2ced288a263b9-3"></a>├── Dockerfile-app        <span class="c1"># 1. Django プロジェクト作るよう Dockerfile</span>
<a name="rest_code_3c43283c3b954bc5aea2ced288a263b9-4"></a>├── Dockerfile-mysql      <span class="c1"># 2. MySQL よう Dockerfile</span>
<a name="rest_code_3c43283c3b954bc5aea2ced288a263b9-5"></a>├── Dockerfile-postgres   <span class="c1"># 3. PostgreSQL よう Dockerfile</span>
<a name="rest_code_3c43283c3b954bc5aea2ced288a263b9-6"></a>├── docker-compose.yml    <span class="c1"># 4. Composeファイル</span>
<a name="rest_code_3c43283c3b954bc5aea2ced288a263b9-7"></a>└── requirements.txt      <span class="c1"># 5. requirements.txt</span>
</pre>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id14">設定ファイル</a></h3>
<ol class="arabic">
<li>
<p class="first"><tt class="docutils literal"><span class="pre">Dockerfile-app</span></tt> : Django プロジェクトを入れるコンテナ</p>
<blockquote>
<pre class="code docker"><a name="rest_code_1e9b81d267bd4b1eae795b807241687c-1"></a><span class="k">FROM</span><span class="s"> ubuntu:18.04</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-2"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-3"></a><span class="c"># インストール中に何も尋ねてくるな</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-4"></a><span class="k">ENV</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-5"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-6"></a><span class="c"># Python の環境変数を設定</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-7"></a><span class="c"># stdout, stderr のバッファを無効に</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-8"></a><span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-9"></a><span class="c"># ソースモジュールのインポート時に .pyc ファイルを作成しない</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-10"></a><span class="k">ENV</span> PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-11"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-12"></a><span class="c"># locales をインストールして設定する</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-13"></a><span class="k">RUN</span> apt-get clean <span class="o">&amp;&amp;</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y locales <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-14"></a>    <span class="o">&amp;&amp;</span> localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-15"></a><span class="k">ENV</span> LANG en_US.UTF-8
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-16"></a><span class="k">ENV</span> LANGUAGE en_US:en
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-17"></a><span class="k">ENV</span> LC_ALL en_US.UTF-8
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-18"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-19"></a><span class="c"># タイムゾーンに JST を設定</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-20"></a><span class="k">RUN</span> ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-21"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-22"></a><span class="c"># Python ビルドに必要な deb パッケージのインストール</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-23"></a><span class="c"># `libffi-dev`: 3.6 では不要 (?) 、3.7 では必要</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-24"></a><span class="k">RUN</span> apt-get clean <span class="o">&amp;&amp;</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-25"></a>    build-essential <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-26"></a>    python3-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-27"></a>    libsqlite3-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-28"></a>    libreadline6-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-29"></a>    libgdbm-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-30"></a>    zlib1g-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-31"></a>    libbz2-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-32"></a>    sqlite3 <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-33"></a>    tk-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-34"></a>    zip <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-35"></a>    libssl-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-36"></a>    libffi-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-37"></a>    wget <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-38"></a> <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-39"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-40"></a><span class="c"># Python をソースファイルからビルドしてインストール</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-41"></a><span class="c"># `make altinstall`: `make install` の代わりに推奨</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-42"></a><span class="k">RUN</span> wget https://www.python.org/ftp/python/3.7.3/Python-3.7.3.tgz <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-43"></a>    <span class="o">&amp;&amp;</span> tar xf Python-3.7.3.tgz <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-44"></a>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> Python-3.7.3 <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-45"></a>    <span class="o">&amp;&amp;</span> ./configure --prefix<span class="o">=</span>/opt/python3.7.3 <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-46"></a>    <span class="o">&amp;&amp;</span> make <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-47"></a>    <span class="o">&amp;&amp;</span> make altinstall
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-48"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-49"></a><span class="c"># Python のシンボリックリンクを作成</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-50"></a><span class="k">RUN</span> ln -s /opt/python3.7.3/bin/python3.7 /usr/local/bin/python
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-51"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-52"></a><span class="c"># pip のシンボリックリンクを作成</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-53"></a><span class="k">RUN</span> ln -s /opt/python3.7.3/bin/pip3.7 /usr/local/bin/pip
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-54"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-55"></a><span class="c"># pip をアップグレード</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-56"></a><span class="k">RUN</span> pip install -U pip
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-57"></a>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-58"></a><span class="c"># mysqlclient のインストールに必要なので、インストールしておく</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-59"></a><span class="k">RUN</span> apt-get clean <span class="o">&amp;&amp;</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-60"></a>    default-libmysqlclient-dev <span class="se">\</span>
<a name="rest_code_1e9b81d267bd4b1eae795b807241687c-61"></a> <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
</pre>
</blockquote>
</li>
<li>
<p class="first"><tt class="docutils literal"><span class="pre">Dockerfile-mysql</span></tt> : MySQL を入れるコンテナ</p>
<blockquote>
<pre class="code docker"><a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-1"></a><span class="k">FROM</span><span class="s"> mysql:latest</span>
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-2"></a>
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-3"></a><span class="c"># locales をインストールして設定する</span>
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-4"></a><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y locales <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span class="se">\</span>
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-5"></a>    <span class="o">&amp;&amp;</span> localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-6"></a><span class="k">ENV</span> LANG en_US.UTF-8
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-7"></a><span class="k">ENV</span> LANGUAGE en_US:en
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-8"></a><span class="k">ENV</span> LC_ALL en_US.UTF-8
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-9"></a>
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-10"></a><span class="c"># タイムゾーンに JST を設定</span>
<a name="rest_code_83fbafeeabdf4b83bdf92a54f1509da6-11"></a><span class="k">RUN</span> ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
</pre>
</blockquote>
</li>
<li>
<p class="first"><tt class="docutils literal"><span class="pre">Dockerfile-postgres</span></tt> : PostgreSQL を入れるコンテナ</p>
<blockquote>
<pre class="code docker"><a name="rest_code_da5fc9d45995429598132efb5963b00d-1"></a><span class="k">FROM</span><span class="s"> postgres:latest</span>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-2"></a>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-3"></a><span class="c">## locales をインストールして設定する (PostgreSQL の場合は、公式イメージで実行済み)</span>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-4"></a><span class="c">## https://github.com/docker-library/postgres/blob/85aadc08c347cd20f199902c4b8b4f736341c3b8/11/Dockerfile</span>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-5"></a><span class="c">#RUN apt-get update &amp;&amp; apt-get install -y locales &amp;&amp; rm -rf /var/lib/apt/lists/* \</span>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-6"></a><span class="c">#  &amp;&amp; localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8</span>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-7"></a><span class="c">#ENV LANG en_US.UTF-8</span>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-8"></a><span class="k">ENV</span> LANGUAGE en_US:en
<a name="rest_code_da5fc9d45995429598132efb5963b00d-9"></a><span class="k">ENV</span> LC_ALL en_US.UTF-8
<a name="rest_code_da5fc9d45995429598132efb5963b00d-10"></a>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-11"></a><span class="c"># タイムゾーンに JST を設定</span>
<a name="rest_code_da5fc9d45995429598132efb5963b00d-12"></a><span class="k">RUN</span> ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
</pre>
</blockquote>
</li>
<li>
<p class="first"><tt class="docutils literal"><span class="pre">docker-compose.yml</span></tt> : Composeファイル</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_0a890d58fe274d13a8ac788eca44deba-1"></a><span class="nt">version</span><span class="p">:</span> <span class="s">'3'</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-2"></a>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-3"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-4"></a>  <span class="nt">app</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-5"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu_app</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-6"></a>    <span class="nt">build</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-7"></a>      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-8"></a>      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile-app</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-9"></a>    <span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-10"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">.:/fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-11"></a>    <span class="nt">working_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-12"></a>    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash -c "pip install -r requirements.txt &amp;&amp; bash"</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-13"></a>    <span class="nt">ports</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-14"></a>      <span class="p p-Indicator">-</span> <span class="s">"8000:8000"</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-15"></a>    <span class="nt">tty</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>  <span class="c1"># 起動し続ける</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-16"></a>    <span class="nt">depends_on</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-17"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-18"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-19"></a>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-20"></a>  <span class="nt">mysql</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-21"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu_mysql</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-22"></a>    <span class="nt">build</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-23"></a>      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-24"></a>      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile-mysql</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-25"></a>    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">--character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-26"></a>    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-27"></a>    <span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-28"></a>      <span class="p p-Indicator">-</span> <span class="s">"mysql-data:/var/lib/mysql"</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-29"></a>    <span class="nt">environment</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-30"></a>      <span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-31"></a>      <span class="nt">MYSQL_DATABASE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-32"></a>      <span class="nt">MYSQL_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-33"></a>      <span class="nt">MYSQL_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-34"></a>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-35"></a>  <span class="nt">postgres</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-36"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu_postgres</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-37"></a>    <span class="nt">build</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-38"></a>      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-39"></a>      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile-postgres</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-40"></a>    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-41"></a>    <span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-42"></a>      <span class="p p-Indicator">-</span> <span class="s">"postgres-data:/var/lib/postgresql/data"</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-43"></a>    <span class="nt">environment</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-44"></a>      <span class="nt">POSTGRES_DB</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-45"></a>      <span class="nt">POSTGRES_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-46"></a>      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fufufu</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-47"></a>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-48"></a><span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-49"></a>  <span class="nt">mysql-data</span><span class="p">:</span>
<a name="rest_code_0a890d58fe274d13a8ac788eca44deba-50"></a>  <span class="nt">postgres-data</span><span class="p">:</span>
</pre>
</blockquote>
</li>
<li>
<p class="first"><tt class="docutils literal">requirements.txt</tt> : requirements.txt</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_534e45675f364f72a9a0328835a9d686-1"></a><span class="l l-Scalar l-Scalar-Plain">Django&gt;=2.1</span>
<a name="rest_code_534e45675f364f72a9a0328835a9d686-2"></a><span class="l l-Scalar l-Scalar-Plain">mysqlclient</span>  <span class="c1"># MySQL のドライバー</span>
<a name="rest_code_534e45675f364f72a9a0328835a9d686-3"></a><span class="l l-Scalar l-Scalar-Plain">psycopg2-binary</span>  <span class="c1"># PostgreSQL のドライバー</span>
</pre>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id15">起動</a></h3>
<pre class="code bash"><a name="rest_code_0b7631a91c3f4142905eb468618f669d-1"></a>$ docker-compose up
<a name="rest_code_0b7631a91c3f4142905eb468618f669d-2"></a><span class="c1"># 再度 image ビルドからやり直したい</span>
<a name="rest_code_0b7631a91c3f4142905eb468618f669d-3"></a>$ docker-compose up --build
</pre>
</div>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id16">つかいかた</a></h2>
<div class="section" id="app">
<h3><a class="toc-backref" href="#id17">app コンテナ</a></h3>
<pre class="code bash"><a name="rest_code_7ddacb473b764373a5ede86d83eedbb2-1"></a><span class="c1"># Django プロジェクトのコンテナに入る</span>
<a name="rest_code_7ddacb473b764373a5ede86d83eedbb2-2"></a>$ docker container <span class="nb">exec</span> -it fufufu_app bash
<a name="rest_code_7ddacb473b764373a5ede86d83eedbb2-3"></a><span class="c1"># Django プロジェクトを作成する</span>
<a name="rest_code_7ddacb473b764373a5ede86d83eedbb2-4"></a>$ <span class="nb">cd</span> /fufufu
<a name="rest_code_7ddacb473b764373a5ede86d83eedbb2-5"></a>$ /opt/python3.7.3/lib/python3.7/site-packages/django/bin/django-admin.py startproject config .
<a name="rest_code_7ddacb473b764373a5ede86d83eedbb2-6"></a><span class="c1"># runserver する ( settings.py の ``ALLOWED_HOSTS`` に ``'0.0.0.0'`` を書いておかないと ``DisallowedHost`` になります)</span>
<a name="rest_code_7ddacb473b764373a5ede86d83eedbb2-7"></a>$ python manage.py runserver <span class="m">0</span>.0.0.0:8000
</pre>
</div>
<div class="section" id="mysql-postgresql">
<h3><a class="toc-backref" href="#id18">MySQL, PostgreSQL コンテナ</a></h3>
<pre class="code bash"><a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-1"></a><span class="c1"># MySQL のコンテナに入る</span>
<a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-2"></a>$ docker container <span class="nb">exec</span> -it fufufu_mysql bash
<a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-3"></a><span class="c1"># MySQL に入る</span>
<a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-4"></a>$ mysql -u fufufu -D fufufu -p
<a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-5"></a>
<a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-6"></a><span class="c1"># PostgreSQL のコンテナに入る</span>
<a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-7"></a>$ docker container <span class="nb">exec</span> -it fufufu_postgres bash
<a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-8"></a><span class="c1"># PostgreSQL に入る</span>
<a name="rest_code_c855796f9a4c4b378e9072c70f2c535d-9"></a>$ psql -U fufufu fufufu
</pre>
</div>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id19">感想</a></h2>
<ul class="simple">
<li>
<tt class="docutils literal">Python をソースファイルからビルドしてインストール</tt> するのは時間がかかる</li>
<li>Django プロジェクトを作成するのに、venv を作らず、<ul>
<li>
<tt class="docutils literal"><span class="pre">/opt/python3.7.3/lib/python3.7/site-packages/django/bin/django-admin.py</span> startproject config .</tt> じゃなくて、 <tt class="docutils literal"><span class="pre">django-admin.py</span> startproject config .</tt> できる方法ないのだろうか...</li>
<li>手動で <tt class="docutils literal"><span class="pre">/opt/python3.7.3/lib/python3.7/site-packages/django/bin/</span></tt> に PATH を通せばできるけどそうじゃなくて自動でやってくれないのかな...</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id20">その他</a></h2>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id21">Python 公式イメージのルーツ</a></h3>
<p>python:latest, python:3 =&gt; buildpack-deps:stretch =&gt; debian:stretch</p>
<ul class="simple">
<li>ubuntu は Debian-based ということだけれど、 Debian と ubuntu はどんな風に違うんだろうなあ</li>
<li>MySQL, PostgreSQL の公式イメージも Debian (debian:stretch-slim) だった</li>
</ul>
<div class="section" id="docker-hub">
<h4><a class="toc-backref" href="#id22">Docker Hub</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://hub.docker.com/_/python">python Docker Official Images</a></li>
<li>
<a class="reference external" href="https://hub.docker.com/_/buildpack-deps">buildpack-deps Docker Official Images</a><ul>
<li><cite>A collection of common build dependencies used for installing various modules, e.g., gems.</cite></li>
</ul>
</li>
<li><a class="reference external" href="https://hub.docker.com/_/debian">Debian Docker Official Images</a></li>
</ul>
</div>
</div>
</div>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>
</html>
