<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>GitHub Actions で deploy 時に changelog を生成してタグを打ちたい/ふみのて</title>
<link rel="shortcut icon" href="../../../assets/icons/favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Fredericka+the+Great&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Sawarabi+Mincho&amp;display=swap&amp;subset=japanese,latin-ext">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link rel="stylesheet" href="../../../assets/css/style.css?20200720">
</head>
<body>
    <div class="container">
      <div class="header"><header class="item item-header"><h1>
    <a href="../../../">
      <img class="logo" src="../../../assets/images/inuu.png" alt="犬"></a>
  </h1>
  <iframe src="../../../tags/" class="tags"></iframe>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-github"><div class="category">
      <a href="../../../tags/github/">
          github
      </a>
    </div>
    <div class="title">GitHub Actions で deploy 時に changelog を生成してタグを打ちたい</div>
    <time class="date" datetime="2021-09-20 00:00:00+09:00">
      2021-09-20 Mon
    </time><time class="date" datetime="2021-09-20 00:00:00+09:00">
        updated: 2021-09-20 Mon
        
      </time><div class="text">
      <div>
<details><summary>目次</summary><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li>
<p><a class="reference internal" href="#id1" id="id18">リファレンス・ガイド</a></p>
<ul>
<li><p><a class="reference internal" href="#github-actions" id="id19">GitHub Actions</a></p></li>
<li><p><a class="reference internal" href="#actions" id="id20">ワークフロー中で使った Actions</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#case1-push-tag" id="id21">Case1: 直接 push する、 tag は手動トリガー時に入力できる</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id22">条件</a></p></li>
<li><p><a class="reference internal" href="#workflow" id="id23">workflow</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#case2-push-tag-protected-branch" id="id24">Case2: 直接 push する、 tag は手動トリガー時に入力できる (ちょっとだけ protected branch)</a></p>
<ul>
<li><p><a class="reference internal" href="#id5" id="id25">条件</a></p></li>
<li>
<p><a class="reference internal" href="#id6" id="id26">workflow</a></p>
<ul>
<li><p><a class="reference internal" href="#id9" id="id27">ちなみに</a></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#case3-protected-branch-pr-tag-auto-bump-changelog-tag" id="id28">Case3: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがずれる)</a></p>
<ul>
<li><p><a class="reference internal" href="#id10" id="id29">条件</a></p></li>
<li>
<p><a class="reference internal" href="#id13" id="id30">workflow</a></p>
<ul>
<li><p><a class="reference internal" href="#note" id="id31">Note</a></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#case4-protected-branch-pr-tag-auto-bump-changelog-tag" id="id32">Case4: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがいっしょ!)</a></p>
<ul>
<li><p><a class="reference internal" href="#id14" id="id33">条件</a></p></li>
<li>
<p><a class="reference internal" href="#id15" id="id34">workflow</a></p>
<ul>
<li><p><a class="reference internal" href="#changelog-next-tag" id="id35">1. changelog 生成, next tag 払い出し</a></p></li>
<li><p><a class="reference internal" href="#tag-deploy" id="id36">2. tag 打ちして deploy</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id16" id="id37">その他</a></p></li>
</ul>
</li>
</ul>
</div>
</details><div class="section" id="id1">
<h2><a class="toc-backref" href="#id18">リファレンス・ガイド</a></h2>
<div class="section" id="github-actions">
<h3><a class="toc-backref" href="#id19">GitHub Actions</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.github.com/ja/actions/reference/workflow-syntax-for-github-actions">GitHub Actionsのワークフロー構文</a></p></li>
</ul>
</div>
<div class="section" id="actions">
<h3><a class="toc-backref" href="#id20">ワークフロー中で使った Actions</a></h3>
<ul class="simple">
<li><p>Checkout V2: <a class="reference external" href="https://github.com/actions/checkout">https://github.com/actions/checkout</a></p></li>
<li><p>git-auto-commit Action: <a class="reference external" href="https://github.com/stefanzweifel/git-auto-commit-action">https://github.com/stefanzweifel/git-auto-commit-action</a></p></li>
<li><p>GitHub Tag Action: <a class="reference external" href="https://github.com/mathieudutour/github-tag-action">https://github.com/mathieudutour/github-tag-action</a></p></li>
<li><p>Create Pull Request: <a class="reference external" href="https://github.com/peter-evans/create-pull-request">https://github.com/peter-evans/create-pull-request</a></p></li>
<li><p>Enable Pull Request Auto-merge: <a class="reference external" href="https://github.com/peter-evans/enable-pull-request-automerge">https://github.com/peter-evans/enable-pull-request-automerge</a></p></li>
<li><p>approve-pull-request-action: <a class="reference external" href="https://github.com/juliangruber/approve-pull-request-action">https://github.com/juliangruber/approve-pull-request-action</a></p></li>
</ul>
</div>
</div>
<div class="section" id="case1-push-tag">
<h2><a class="toc-backref" href="#id21">Case1: 直接 push する、 tag は手動トリガー時に入力できる</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id22">条件</a></h3>
<ul class="simple">
<li><p>private repository</p></li>
<li><p>changelog push 対象のブランチに、 Branch protection rules の適用なし</p></li>
</ul>
</div>
<div class="section" id="workflow">
<h3><a class="toc-backref" href="#id23">workflow</a></h3>
<ol class="arabic simple">
<li><p>ブランチを選択・タグ名を入力して、 <code class="docutils literal">Run workflow</code> (手動トリガー)</p></li>
<li><p>changelog を生成</p></li>
<li><p>ワークフローをトリガーしたブランチに、 changelog を commit &amp; push</p></li>
<li><p>changelog の commit に、入力したタグ名でタグ打ち</p></li>
<li><p>deploy</p></li>
</ol>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.github.com/ja/actions/managing-workflow-runs/manually-running-a-workflow">ワークフローの手動実行</a></p></li>
</ul>
<pre class="code yaml"><a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-1"></a><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy (Case1)</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-2"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-3"></a><span class="nt">on</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-4"></a>  <span class="nt">workflow_dispatch</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-5"></a>    <span class="c1"># 手動トリガー</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-6"></a>    <span class="nt">inputs</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-7"></a>      <span class="nt">tag-name</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-8"></a>        <span class="c1"># ここで入力したタグ名でタグを打つ</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-9"></a>        <span class="nt">description</span><span class="p">:</span> <span class="s">'Enter</span><span class="nv"> </span><span class="s">tag</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">(e.g.</span><span class="nv"> </span><span class="s">v1.2.3)'</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-10"></a>        <span class="nt">required</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-11"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-12"></a><span class="nt">env</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-13"></a>  <span class="c1"># 必要な環境変数を定義する</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-14"></a>  <span class="c1"># ここで定義した env はすべての job から参照できる</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-15"></a>  <span class="nt">AWS_REGION</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ap-northeast-1</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-16"></a>  <span class="c1"># (以下省略)</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-17"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-18"></a><span class="nt">defaults</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-19"></a>  <span class="nt">run</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-20"></a>    <span class="nt">shell</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-21"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-22"></a><span class="nt">jobs</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-23"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-24"></a>  <span class="nt">changelog</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-25"></a>    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Update CHANGELOG and create new tag</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-26"></a>    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-27"></a>    <span class="nt">outputs</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-28"></a>      <span class="c1"># job の outputs として tag を打った (changelog を commit した) コミットの hash (SHA) を設定</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-29"></a>      <span class="nt">tagged-sha</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.push-changelog-tag.outputs.commit_hash }}</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-30"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-31"></a>    <span class="nt">steps</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-32"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-33"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-34"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-35"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build services</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-36"></a>        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-37"></a>          <span class="no">cp example.env .env</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-38"></a>          <span class="no">docker-compose build --parallel</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-39"></a>        <span class="nt">env</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-40"></a>          <span class="nt">DOCKER_BUILDKIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-41"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-42"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Update CHANGELOG</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-43"></a>        <span class="c1"># root ユーザーで実行する</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-44"></a>        <span class="c1"># root で実行しないと、 towncrier が見たい dir の参照権限がなかったりして、fail する</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-45"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose run -u 0 --rm djangoapp towncrier --yes</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-46"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-47"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Stop and remove containers, networks and volumes</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-48"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose down -v</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-49"></a>        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always()</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-50"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-51"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Restore git dir owner and group</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-52"></a>        <span class="c1"># CHANGELOG は root:root で作成される</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-53"></a>        <span class="c1"># そのままだと git-auto-commit-action に失敗することがあるため元に戻す</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-54"></a>        <span class="c1"># ※これは正しい解決策なのか否かちょっと自信なし</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-55"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo chown -R runner:docker .git/objects/</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-56"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-57"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Commit, push CHANGELOG and create new tag</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-58"></a>        <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">push-changelog-tag</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-59"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stefanzweifel/git-auto-commit-action@v4</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-60"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-61"></a>          <span class="nt">commit_message</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Updated CHANGELOG</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-62"></a>          <span class="c1"># 手動トリガーで受け取ったタグ名でタグを打つ</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-63"></a>          <span class="c1"># 手動トリガー時に受け取った inputs はこんな風に参照できる</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-64"></a>          <span class="nt">tagging_message</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ github.event.inputs.tag-name }}</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-65"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-66"></a>  <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-67"></a>    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-68"></a>    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-69"></a>    <span class="c1"># changelog job が正常終了したらこの job を実行する (直列で実行する)</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-70"></a>    <span class="c1"># needs を指定しないと並列実行される</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-71"></a>    <span class="nt">needs</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-72"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">changelog</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-73"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-74"></a>    <span class="nt">steps</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-75"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-76"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-77"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-78"></a>          <span class="c1"># すべての tag も fetch する</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-79"></a>          <span class="c1"># これをつけないと (デフォルトだと) 、ワークフローをトリガーした ref/SHA のコミットひとつだけが fetch される</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-80"></a>          <span class="nt">fetch-depth</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-81"></a>          <span class="c1"># changelog job で tag を打った (changelog を commit した) コミットをチェックアウトする</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-82"></a>          <span class="c1"># ※ changelog + tag のコミットを deploy したいため</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-83"></a>          <span class="c1"># needs に指定した job の outputs はこんな風に参照できる</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-84"></a>          <span class="nt">ref</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ needs.changelog.outputs.tagged_hash }}</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-85"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-86"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Set tagged sha</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-87"></a>        <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">set-tag-sha</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-88"></a>        <span class="c1"># [確認用] チェックアウトしたブランチの最新の commit を取得</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-89"></a>        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-90"></a>          <span class="no">TAGGED_SHA=$(git log -1 --format='%H')</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-91"></a>          <span class="no">echo $TAGGED_SHA</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-92"></a>          <span class="no">echo "::set-output name=tag-sha::$TAGGED_SHA"</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-93"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-94"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo github-ref</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-95"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ github.ref }}"</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-96"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo github-sha</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-97"></a>        <span class="c1"># ワークフローをトリガーしたときの SHA</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-98"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ github.sha }}"</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-99"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo changelog-tagged_hash</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-100"></a>        <span class="c1"># changelog job で tag を打った SHA</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-101"></a>        <span class="c1"># このワークフロー中で commit したので、 github.sha より一つ進んでいる</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-102"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ needs.changelog.outputs.tagged_hash }}"</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-103"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo tag-sha</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-104"></a>        <span class="c1"># チェックアウトしたブランチの最新の commit の SHA</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-105"></a>        <span class="c1"># == changelog-tagged_hash</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-106"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ steps.set-tag-sha.outputs.tag-sha }}"</span>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-107"></a>
<a name="rest_code_748100c5b3434f1da0d0033c8369b3a7-108"></a>      <span class="c1"># あとは deploy する (省略)</span>
</pre>
</div>
</div>
<div class="section" id="case2-push-tag-protected-branch">
<h2><a class="toc-backref" href="#id24">Case2: 直接 push する、 tag は手動トリガー時に入力できる (ちょっとだけ protected branch)</a></h2>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id25">条件</a></h3>
<ul class="simple">
<li><p>private repository</p></li>
<li>
<p>changelog push 対象のブランチに、 Branch protection rules の適用あり</p>
<ul>
<li><p>Require pull request reviews before merging: OFF</p></li>
<li><p>Require status checks to pass before merging: ON</p></li>
<li><p>Include administrators: OFF</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id26">workflow</a></h3>
<p>Case1 と同じ</p>
<pre class="code yaml"><a name="rest_code_00287d705f4b4b7f8079708c5cbc97b7-1"></a><span class="nt">steps</span><span class="p">:</span>
<a name="rest_code_00287d705f4b4b7f8079708c5cbc97b7-2"></a>  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<a name="rest_code_00287d705f4b4b7f8079708c5cbc97b7-3"></a>    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<a name="rest_code_00287d705f4b4b7f8079708c5cbc97b7-4"></a>    <span class="c1"># ここだけ変える</span>
<a name="rest_code_00287d705f4b4b7f8079708c5cbc97b7-5"></a>    <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_00287d705f4b4b7f8079708c5cbc97b7-6"></a>      <span class="c1"># 管理者権限を持つユーザーで repo scope の PAT を作成し、</span>
<a name="rest_code_00287d705f4b4b7f8079708c5cbc97b7-7"></a>      <span class="c1"># GitHub Actions の secrets に登録しておく</span>
<a name="rest_code_00287d705f4b4b7f8079708c5cbc97b7-8"></a>      <span class="nt">token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.REPO_SCOPED_PAT }}</span>
</pre>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.github.com/ja/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token">個人アクセストークンを使用する</a></p></li>
<li><p><a class="reference external" href="https://docs.github.com/ja/actions/reference/encrypted-secrets">暗号化されたシークレット</a></p></li>
</ul>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id27">ちなみに</a></h4>
<p>Branch protection rules のうち、以下のいずれかもしくは両方が <code class="docutils literal">ON</code> の場合は NG です。
workflow は fail します (changelog の push に失敗する) 。</p>
<ul class="simple">
<li>
<p>Require pull request reviews before merging</p>
<ul>
<li><p>自分のローカルから push するときは、これ ON でも Include administrators が OFF なら push できるんだけれども、
なにか、PAT の権限足すといけるのかもしれない (けれどあまり強権限持たせたくない..)</p></li>
<li><p>それに、管理者だからって、自分の頭で気をつけるんじゃなくて GitHub に助けて (チェックして) もらいたい...</p></li>
</ul>
</li>
<li><p>Include administrators</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="case3-protected-branch-pr-tag-auto-bump-changelog-tag">
<h2><a class="toc-backref" href="#id28">Case3: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがずれる)</a></h2>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id29">条件</a></h3>
<ul class="simple">
<li><p>private repository</p></li>
<li>
<p>changelog push 対象のブランチに、 Branch protection rules の適用あり</p>
<ul>
<li><p>Require pull request reviews before merging: ON</p></li>
<li>
<p>Require status checks to pass before merging: ON (今回の場合は、以下の3つを指定)</p>
<ul>
<li>
<p>ci (自分のところで用意している CI)</p>
<ul>
<li><p>push イベントで起動 (branch は特に絞り込んでいません)</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/marketplace/task-list-completed">task-list-completed</a></p></li>
<li><p><a class="reference external" href="https://github.com/marketplace/actions/wip">WIP</a></p></li>
</ul>
</li>
<li><p>Include administrators: ON</p></li>
</ul>
</li>
<li>
<p>リポジトリ内のプルリクエストの自動マージを許可: ON</p>
<ul>
<li><p><a class="reference external" href="https://docs.github.com/ja/github/administering-a-repository/configuring-pull-request-merges/managing-auto-merge-for-pull-requests-in-your-repository">リポジトリ内のプルリクエストの自動マージを管理する</a></p></li>
<li><p><a class="reference external" href="https://docs.github.com/ja/github/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request">プルリクエストを自動的にマージする</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id30">workflow</a></h3>
<ol class="arabic simple">
<li>
<p>ブランチを選択して、 <code class="docutils literal">Run workflow</code> (手動トリガー)</p>
<ul class="simple">
<li><p>タグ version の bump up は自動でやってくれるので、通常の実行時はタグ名を指定しない</p></li>
<li>
<p>デフォルトが <code class="docutils literal">Patch</code> になっているので、 <code class="docutils literal">Minor</code> or <code class="docutils literal">Major</code> の version を bump up したいときは、 <code class="docutils literal">custom_tag</code> を指定する</p>
<ul>
<li><p>ちょっとまだどんな風に version up していくか見えていないので</p></li>
</ul>
</li>
</ul>
</li>
<li><p>changelog を生成</p></li>
<li>
<p>ワークフローをトリガーしたコミットにタグ打ち (タグのバージョンは自動 bump up)</p>
<ul class="simple">
<li><p>changelog の PR が merge されるのをワークフロー中で待てないので、</p></li>
<li><p>あきらめて「ワークフローをトリガーしたコミット」にタグを打つ。</p></li>
<li><p>changelog のコミットは、「タグを打ったコミット」より後の別のコミットになる。</p></li>
</ul>
</li>
<li><p>changelog を PR</p></li>
<li><p>changelog の PR の自動マージを有効化</p></li>
<li><p>changelog を PR を自動 approve</p></li>
<li><p>deploy</p></li>
</ol>
<pre class="code yaml"><a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-1"></a><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy (Case3)</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-2"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-3"></a><span class="nt">on</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-4"></a>  <span class="nt">workflow_dispatch</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-5"></a>    <span class="nt">inputs</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-6"></a>      <span class="nt">custom_tag</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-7"></a>        <span class="nt">description</span><span class="p">:</span> <span class="s">'メジャー/マイナーバージョンをインクリメントしたいときのみ指定してください</span><span class="nv"> </span><span class="s">(e.g.</span><span class="nv"> </span><span class="s">1.2.0)'</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-8"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-9"></a><span class="nt">env</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-10"></a>  <span class="nt">AWS_REGION</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ap-northeast-1</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-11"></a>  <span class="c1"># (以下省略)</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-12"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-13"></a><span class="nt">defaults</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-14"></a>  <span class="nt">run</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-15"></a>    <span class="nt">shell</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-16"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-17"></a><span class="nt">jobs</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-18"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-19"></a>  <span class="nt">changelog</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-20"></a>    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Update CHANGELOG and create new tag</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-21"></a>    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-22"></a>    <span class="nt">outputs</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-23"></a>      <span class="c1"># changelog job の outputs として version を bump したタグ名設定</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-24"></a>      <span class="nt">new_tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.create-tag.outputs.new_tag }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-25"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-26"></a>    <span class="nt">steps</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-27"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-28"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-29"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-30"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build services</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-31"></a>        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-32"></a>          <span class="no">cp example.env .env</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-33"></a>          <span class="no">docker-compose build --parallel</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-34"></a>        <span class="nt">env</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-35"></a>          <span class="nt">DOCKER_BUILDKIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-36"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-37"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Update CHANGELOG</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-38"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose run -u 0 --rm djangoapp towncrier --yes</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-39"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-40"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Stop and remove containers, networks and volumes</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-41"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose down -v</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-42"></a>        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always()</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-43"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-44"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Bump version and push tag</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-45"></a>        <span class="c1"># changelog の PR が merge されるのをワークフロー中で待てないので、</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-46"></a>        <span class="c1"># あきらめて「ワークフローをトリガーしたコミット」にタグを打つ。</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-47"></a>        <span class="c1"># changelog のコミットは、「タグを打ったコミット」より後の別のコミットになる。</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-48"></a>        <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">create-tag</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-49"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mathieudutour/github-tag-action@v5.6</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-50"></a>        <span class="c1"># main 以外のブランチで実行した場合は `v1.2.3-{branch_name}.0` のようなタグがつくため、</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-51"></a>        <span class="c1"># main ブランチの bump には影響しない。</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-52"></a>        <span class="c1"># ※ custom_tag に、 main ブランチのタグと同じ形式のタグ名を指定すると影響する</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-53"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-54"></a>          <span class="c1"># secrets.GITHUB_TOKEN は github.token と同義だそうです</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-55"></a>          <span class="nt">github_token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.GITHUB_TOKEN }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-56"></a>          <span class="c1"># 手動トリガー時に custom_tag を受け取った場合は、</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-57"></a>          <span class="c1"># 受け取ったタグ名でタグを打つ</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-58"></a>          <span class="nt">custom_tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ github.event.inputs.custom_tag }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-59"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-60"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Create Pull Request</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-61"></a>        <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cpr</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-62"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">peter-evans/create-pull-request@v3</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-63"></a>        <span class="nt">env</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-64"></a>          <span class="nt">TAG_MAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.create-tag.outputs.new_tag }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-65"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-66"></a>          <span class="nt">token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.PR_CHANGELOG_PAT }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-67"></a>          <span class="nt">branch</span><span class="p">:</span> <span class="s">'deploy/${{</span><span class="nv"> </span><span class="s">env.TAG_MAME</span><span class="nv"> </span><span class="s">}}'</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-68"></a>          <span class="nt">commit-message</span><span class="p">:</span> <span class="s">'Updated</span><span class="nv"> </span><span class="s">CHANGELOG</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">env.TAG_MAME</span><span class="nv"> </span><span class="s">}}'</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-69"></a>          <span class="nt">title</span><span class="p">:</span> <span class="s">'Update</span><span class="nv"> </span><span class="s">CHANGELOG</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">env.TAG_MAME</span><span class="nv"> </span><span class="s">}}'</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-70"></a>          <span class="c1"># どのコミットにタグを打ったかわからなくならないようにメモ↓</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-71"></a>          <span class="nt">body</span><span class="p">:</span> <span class="s">'Commit</span><span class="nv"> </span><span class="s">SHA:</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">github.sha</span><span class="nv"> </span><span class="s">}}'</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-72"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-73"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Enable Pull Request Automerge</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-74"></a>        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">steps.cpr.outputs.pull-request-operation == 'created'</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-75"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">peter-evans/enable-pull-request-automerge@v1</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-76"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-77"></a>          <span class="c1"># repo scope の PAT を作成し、</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-78"></a>          <span class="c1"># GitHub Actions の secrets に登録しておく</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-79"></a>          <span class="nt">token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.PR_CHANGELOG_PAT }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-80"></a>          <span class="nt">pull-request-number</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.cpr.outputs.pull-request-number }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-81"></a>          <span class="nt">merge-method</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">squash</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-82"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-83"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Auto approve Pull Request</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-84"></a>        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">steps.cpr.outputs.pull-request-operation == 'created'</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-85"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">juliangruber/approve-pull-request-action@v1</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-86"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-87"></a>          <span class="nt">github-token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.GITHUB_TOKEN }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-88"></a>          <span class="nt">number</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.cpr.outputs.pull-request-number }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-89"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-90"></a>  <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-91"></a>    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-92"></a>    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-93"></a>    <span class="nt">needs</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-94"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">changelog</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-95"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-96"></a>    <span class="nt">steps</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-97"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-98"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-99"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-100"></a>          <span class="c1"># changelog job で タグを打ったコミットをチェックアウトする</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-101"></a>          <span class="c1"># とはいえ、「ワークフローをトリガーしたコミット == タグを打ったコミット」なので、</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-102"></a>          <span class="c1"># 正直付けなくて良い</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-103"></a>          <span class="nt">fetch-depth</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-104"></a>          <span class="nt">ref</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ needs.changelog.outputs.new_tag }}</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-105"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-106"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Set tagged sha</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-107"></a>        <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">set-tag-sha</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-108"></a>        <span class="c1"># [確認用] チェックアウトしたブランチの最新の commit を取得</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-109"></a>        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-110"></a>          <span class="no">TAGGED_SHA=$(git log -1 --format='%H')</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-111"></a>          <span class="no">echo $TAGGED_SHA</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-112"></a>          <span class="no">echo "::set-output name=tag-sha::$TAGGED_SHA"</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-113"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-114"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo github-ref</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-115"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ github.ref }}"</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-116"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo github-sha</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-117"></a>        <span class="c1"># ワークフローをトリガーしたときの SHA</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-118"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ github.sha }}"</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-119"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo tag-sha</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-120"></a>        <span class="c1"># チェックアウトしたブランチの最新の commit の SHA</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-121"></a>        <span class="c1"># == changelog job で tag を打った SHA</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-122"></a>        <span class="c1"># == github-sha</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-123"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ steps.set-tag-sha.outputs.tag-sha }}"</span>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-124"></a>
<a name="rest_code_ab9e856fc3c844ceb51171ddee8ede56-125"></a>      <span class="c1"># あとは deploy する (省略)</span>
</pre>
<div class="section" id="note">
<h4><a class="toc-backref" href="#id31">Note</a></h4>
<ul>
<li>
<p>Create Pull Request, Enable Pull Request Automerge, Auto approve Pull Request の <code class="docutils literal">token</code>, <code class="docutils literal"><span class="pre">github-token</span></code> は、
以下のとおり指定しないとうまくいかない (<cite>Can not approve your own pull request</cite> になっちゃう)</p>
<ol class="arabic simple">
<li><p>Create Pull Request: <code class="docutils literal">secrets.PR_CHANGELOG_PAT</code></p></li>
<li><p>Enable Pull Request Automerge: <code class="docutils literal">secrets.PR_CHANGELOG_PAT</code></p></li>
<li><p>Auto approve Pull Request: <code class="docutils literal">secrets.GITHUB_TOKEN</code></p></li>
</ol>
<ul class="simple">
<li><p>※ <a class="reference external" href="https://github.com/peter-evans/enable-pull-request-automerge#example">https://github.com/peter-evans/enable-pull-request-automerge#example</a> に書いてある順番</p></li>
<li><p>例えば、1 は <code class="docutils literal">secrets.GITHUB_TOKEN</code> も指定可能ですが、そうすると、</p></li>
<li><ol class="arabic simple">
<li><p>PR つくるひと -&gt; 2. PR の自動マージ有効化するひと -&gt; 3. PR を approve するひと =&gt; 1 と 3 がいっしょになっちゃう!!</p></li>
</ol></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="case4-protected-branch-pr-tag-auto-bump-changelog-tag">
<h2><a class="toc-backref" href="#id32">Case4: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがいっしょ!)</a></h2>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id33">条件</a></h3>
<p>Case3 と同じ</p>
</div>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id34">workflow</a></h3>
<p>workflow は二本用意します</p>
<div class="section" id="changelog-next-tag">
<h4><a class="toc-backref" href="#id35">1. changelog 生成, next tag 払い出し</a></h4>
<ol class="arabic simple">
<li>
<p>ブランチを選択して、 <code class="docutils literal">Run workflow</code> (手動トリガー)</p>
<ul class="simple">
<li><p>タグ version の bump up は自動でやってくれるので、通常の実行時はタグ名を指定しない</p></li>
<li>
<p>デフォルトが <code class="docutils literal">Patch</code> になっているので、 <code class="docutils literal">Minor</code> or <code class="docutils literal">Major</code> の version を bump up したいときは、 <code class="docutils literal">custom_tag</code> を指定する</p>
<ul>
<li><p>デフォルトは変えられます</p></li>
</ul>
</li>
</ul>
</li>
<li><p>changelog を生成</p></li>
<li>
<p>bump up したタグ名 (<code class="docutils literal">next tag</code>) 払い出し</p>
<ul class="simple">
<li><p>タグ打ちはまだしない (<code class="docutils literal">dry_run: true</code>)</p></li>
</ul>
</li>
<li>
<p>changelog を PR</p>
<ul class="simple">
<li><p><code class="docutils literal">deploy</code> ラベルをつける</p></li>
<li><p>body に 3 で払い出した <code class="docutils literal">next tag</code> を書いておく</p></li>
</ul>
</li>
<li><p>changelog の PR の自動マージを有効化</p></li>
<li><p>changelog を PR を自動 approve =&gt; Automerge される</p></li>
</ol>
<pre class="code yaml"><a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-1"></a><span class="c1"># Branch protection rules が適用されているブランチであれば、</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-2"></a><span class="c1"># main 以外のブランチでも実行できます</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-3"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-4"></a><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy dev (Case4-1. changelog)</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-5"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-6"></a><span class="nt">on</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-7"></a>  <span class="nt">workflow_dispatch</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-8"></a>    <span class="nt">inputs</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-9"></a>      <span class="nt">custom_tag</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-10"></a>        <span class="nt">description</span><span class="p">:</span> <span class="s">'メジャー/マイナーバージョンをインクリメントしたいときのみ指定してください</span><span class="nv"> </span><span class="s">(e.g.</span><span class="nv"> </span><span class="s">1.2.0)'</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-11"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-12"></a><span class="nt">defaults</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-13"></a>  <span class="nt">run</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-14"></a>    <span class="nt">shell</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-15"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-16"></a><span class="nt">jobs</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-17"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-18"></a>  <span class="nt">changelog</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-19"></a>    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Update CHANGELOG</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-20"></a>    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-21"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-22"></a>    <span class="nt">steps</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-23"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-24"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-25"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-26"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Bump tag version</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-27"></a>        <span class="c1"># bump up したタグ名を払い出す</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-28"></a>        <span class="c1"># main 以外のブランチで実行した場合は `v1.2.3-{branch_name}.0` のようなタグがつくため、</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-29"></a>        <span class="c1">#  main ブランチの bump には影響しない。</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-30"></a>        <span class="c1">#  ※ custom_tag に、 main ブランチのタグと同じ形式のタグ名を指定すると影響します</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-31"></a>        <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bump-tag</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-32"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mathieudutour/github-tag-action@v5.6</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-33"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-34"></a>          <span class="nt">github_token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.GITHUB_TOKEN }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-35"></a>          <span class="nt">custom_tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ github.event.inputs.custom_tag }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-36"></a>          <span class="c1"># タグ打ちはまだしない</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-37"></a>          <span class="nt">dry_run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-38"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-39"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build services</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-40"></a>        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-41"></a>          <span class="no">cp example.env .env</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-42"></a>          <span class="no">docker-compose build --parallel</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-43"></a>        <span class="nt">env</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-44"></a>          <span class="nt">DOCKER_BUILDKIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-45"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-46"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Update CHANGELOG</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-47"></a>        <span class="nt">env</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-48"></a>          <span class="nt">TAG_MAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.bump-tag.outputs.new_tag }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-49"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose run -u 0 --rm djangoapp towncrier --yes --version=${{ env.TAG_MAME }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-50"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-51"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Stop and remove containers, networks and volumes</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-52"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose down -v</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-53"></a>        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always()</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-54"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-55"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Create Pull Request</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-56"></a>        <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cpr</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-57"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">peter-evans/create-pull-request@v3</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-58"></a>        <span class="nt">env</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-59"></a>          <span class="nt">TAG_MAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.bump-tag.outputs.new_tag }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-60"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-61"></a>          <span class="c1"># repo scope の PAT を作成し、</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-62"></a>          <span class="c1"># GitHub Actions の secrets に登録しておく</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-63"></a>          <span class="nt">token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.PR_CHANGELOG_PAT }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-64"></a>          <span class="nt">branch</span><span class="p">:</span> <span class="s">'deploy/${{</span><span class="nv"> </span><span class="s">env.TAG_MAME</span><span class="nv"> </span><span class="s">}}'</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-65"></a>          <span class="nt">commit-message</span><span class="p">:</span> <span class="s">'Updated</span><span class="nv"> </span><span class="s">CHANGELOG</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">env.TAG_MAME</span><span class="nv"> </span><span class="s">}}'</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-66"></a>          <span class="nt">title</span><span class="p">:</span> <span class="s">'Update</span><span class="nv"> </span><span class="s">CHANGELOG</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">env.TAG_MAME</span><span class="nv"> </span><span class="s">}}'</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-67"></a>          <span class="c1"># `deploy` label を付けておく</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-68"></a>          <span class="nt">labels</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy, automerge</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-69"></a>          <span class="c1"># deploy workflow でタグ打ちするので、 next tag を body に書いておく</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-70"></a>          <span class="nt">body</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ env.TAG_MAME }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-71"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-72"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Enable Pull Request Automerge</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-73"></a>        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">steps.cpr.outputs.pull-request-operation == 'created'</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-74"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">peter-evans/enable-pull-request-automerge@v1</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-75"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-76"></a>          <span class="nt">token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.PR_CHANGELOG_PAT }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-77"></a>          <span class="nt">pull-request-number</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.cpr.outputs.pull-request-number }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-78"></a>          <span class="nt">merge-method</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">squash</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-79"></a>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-80"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Auto approve Pull Request</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-81"></a>        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">steps.cpr.outputs.pull-request-operation == 'created'</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-82"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">juliangruber/approve-pull-request-action@v1</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-83"></a>        <span class="nt">with</span><span class="p">:</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-84"></a>          <span class="nt">github-token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.GITHUB_TOKEN }}</span>
<a name="rest_code_a266cf56da964601bbeccc24c9dfdbcf-85"></a>          <span class="nt">number</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ steps.cpr.outputs.pull-request-number }}</span>
</pre>
</div>
<div class="section" id="tag-deploy">
<h4><a class="toc-backref" href="#id36">2. tag 打ちして deploy</a></h4>
<ol class="arabic simple">
<li><p>PR の close イベントで起動</p></li>
<li>
<p>以下の条件に合致する場合に deploy job を実行する</p>
<ul class="simple">
<li><p>ワークフローをトリガーした PR が merge 済み、かつ、</p></li>
<li><p>ワークフローをトリガーした PR の labels に <code class="docutils literal">deploy</code> が含まれる</p></li>
</ul>
</li>
<li>
<p>changelog のコミットにタグ打ち</p>
<ul class="simple">
<li><p>タグ名には、 PR の body から取得した next tag を使用する</p></li>
</ul>
</li>
<li><p>deploy</p></li>
</ol>
<pre class="code yaml"><a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-1"></a><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy dev (Case4-2. deploy)</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-2"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-3"></a><span class="nt">on</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-4"></a>  <span class="nt">pull_request</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-5"></a>    <span class="nt">types</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">closed</span><span class="p p-Indicator">]</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-6"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-7"></a><span class="nt">env</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-8"></a>  <span class="nt">AWS_REGION</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ap-northeast-1</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-9"></a>  <span class="c1"># (以下省略)</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-10"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-11"></a><span class="nt">defaults</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-12"></a>  <span class="nt">run</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-13"></a>    <span class="nt">shell</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-14"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-15"></a><span class="nt">jobs</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-16"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-17"></a>  <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-18"></a>    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Tag and Deploy</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-19"></a>    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-20"></a>    <span class="c1"># PR が merge 済み、かつ、`deploy` label 付きの場合だけ実行</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-21"></a>    <span class="c1"># ほかのトピックブランチが merge -&gt; close されたときには、 Skip されるよ</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-22"></a>    <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">github.event.pull_request.merged == true &amp;&amp; contains(github.event.pull_request.labels.*.name, 'deploy')</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-23"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-24"></a>    <span class="nt">steps</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-25"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-26"></a>        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-27"></a>        <span class="c1"># ワークフローをトリガーした PR の マージブランチの直近のマージコミット</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-28"></a>        <span class="c1"># がチェックアウトされる</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-29"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-30"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo github-ref</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-31"></a>        <span class="c1"># ワークフローをトリガーした PR のマージブランチ</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-32"></a>        <span class="c1"># 例えば、PR のブランチが main から生えていたら、 `main` 、</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-33"></a>        <span class="c1">#  ブランチA から生えていたら `branchA`</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-34"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ github.ref }}"</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-35"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo github-sha</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-36"></a>        <span class="c1"># ワークフローをトリガーした PR の マージブランチの直近のマージコミット</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-37"></a>        <span class="c1"># == changelog の commit</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-38"></a>        <span class="c1"># (タイミングによっては違っちゃうこともあるかもしれない、頻度は低いが可能性としてはありえそう)</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-39"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ github.sha }}"</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-40"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Echo github-head-sha</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-41"></a>        <span class="c1"># PR のブランチで changelog を commit したときの commit</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-42"></a>        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo "${{ github.event.pull_request.head.sha }}"</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-43"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-44"></a>      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Push tag</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-45"></a>        <span class="nt">env</span><span class="p">:</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-46"></a>          <span class="c1"># ワークフローをトリガーした PR の body から取得した next tag</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-47"></a>          <span class="nt">TAG_MAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ github.event.pull_request.body }}</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-48"></a>          <span class="nt">COMMIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ github.sha }}</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-49"></a>        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-50"></a>          <span class="no">git tag $TAG_MAME $COMMIT</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-51"></a>          <span class="no">git push origin $TAG_MAME</span>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-52"></a>
<a name="rest_code_c771bf5de39f4a87bc6361dc13a55013-53"></a>      <span class="c1"># あとは deploy する (省略)</span>
</pre>
</div>
</div>
<div class="section" id="id16">
<h3><a class="toc-backref" href="#id37">その他</a></h3>
<ul class="simple">
<li>
<p>GitHub Actions はスケジュール実行もできる。
<code class="docutils literal">next tag</code> がデフォルトの挙動通りで良いシーンでは、夜間に定期 deploy などしても。</p>
<ul>
<li><p><a class="reference external" href="https://docs.github.com/ja/actions/reference/events-that-trigger-workflows#scheduled-events">スケジュールしたイベント</a></p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>
</html>
