<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Docker/Kubernetes 実践コンテナ開発入門 --- 3. 実用的なコンテナの構築とデプロイ/ふみのて</title>
<link rel="shortcut icon" href="../../../assets/icons/favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Fredericka+the+Great&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Sawarabi+Mincho&amp;display=swap&amp;subset=japanese,latin-ext">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link rel="stylesheet" href="../../../assets/css/style.css?20200720">
</head>
<body>
    <div class="container">
      <div class="header"><header class="item item-header"><h1>
    <a href="../../../">
      <img class="logo" src="../../../assets/images/inuu.png" alt="犬"></a>
  </h1>
  <iframe src="../../../tags/" class="tags"></iframe>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-docker"><div class="category">
      <a href="../../../tags/docker/">
          docker
      </a>
    </div>
    <div class="title">Docker/Kubernetes 実践コンテナ開発入門 --- 3. 実用的なコンテナの構築とデプロイ</div>
    <time class="date" datetime="2018-11-25 00:00:00+09:00">
      2018-11-25 Sun
    </time><time class="date" datetime="2018-11-25 00:00:00+09:00">
        updated: 2018-11-25 Sun
        
      </time><div class="text">
      <div>
<details><summary>目次</summary><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li>
<p><a class="reference internal" href="#id1" id="id20">3.1 アプリケーションとコンテナの粒度</a></p>
<ul>
<li>
<p><a class="reference internal" href="#id2" id="id21">3.1.1 1コンテナ = 1プロセス?</a></p>
<ul>
<li>
<p><a class="reference internal" href="#id3" id="id22">定期的にジョブを実行するアプリケーション</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id23">参考にしたサイト</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id24">3.1.2 1コンテナに1つの関心事</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#id6" id="id25">3.2 コンテナのポータビリティ</a></p>
<ul>
<li><p><a class="reference internal" href="#kernel" id="id26">3.2.1 Kernel・アーキテクチャの違い</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id27">3.2.2 ライブラリ・ダイナミックリンクの課題</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#docker" id="id28">3.3 Docker フレンドリなアプリケーション</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id29">3.3.1 環境変数を活用する</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#id9" id="id30">3.4 永続化データをどう扱うか</a></p>
<ul>
<li>
<p><a class="reference internal" href="#data-volume" id="id31">3.4.1 Data Volume</a></p>
<ul>
<li><p><a class="reference internal" href="#id10" id="id32">Data Volume の作成</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#id11" id="id33">3.4.2 Data Volume コンテナ</a></p>
<ul>
<li><p><a class="reference internal" href="#mysql-data-volume" id="id34">MySQL のデータを Data Volume コンテナに保持する</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id35">データのエクスポートとリストア</a></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#id13" id="id36">3.5 コンテナ配置戦略</a></p>
<ul>
<li>
<p><a class="reference internal" href="#docker-swarm" id="id37">3.5.1 Docker Swarm</a></p>
<ul>
<li><p><a class="reference internal" href="#id14" id="id38">複数の Docker ホストを用意し、 Swarm クラスタを構築する</a></p></li>
<li><p><a class="reference internal" href="#docker-push" id="id39">Docker レジストリにイメージを Push する</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#service" id="id40">3.5.2 Service</a></p></li>
<li>
<p><a class="reference internal" href="#stack" id="id41">3.5.3 Stack</a></p>
<ul>
<li><p><a class="reference internal" href="#id15" id="id42">Stack をデプロイする</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id43">デプロイされた Stack を確認する</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id44">Stack でデプロイされたコンテナを確認する</a></p></li>
<li><p><a class="reference internal" href="#visualizer" id="id45">visualizer で配置されているコンテナを可視化する</a></p></li>
<li><p><a class="reference internal" href="#id18" id="id46">Stack の削除</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#service-swarm" id="id47">3.5.4 Service を Swarm クラスタ外から利用する</a></p>
<ul>
<li><p><a class="reference internal" href="#swarm-echo-nginx-service" id="id48">Swarm クラスタ外から echo_nginx の Service にアクセスする</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id19" id="id49">Docker Swarm まとめ</a></p></li>
</ul>
</li>
</ul>
</div>
</details><div class="section" id="id1">
<h2><a class="toc-backref" href="#id20">3.1 アプリケーションとコンテナの粒度</a></h2>
<p>アプリケーションをコンテナの中にどのように配置するかを意識することが重要</p>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id21">3.1.1 1コンテナ = 1プロセス?</a></h3>
<ul class="simple">
<li><p>1コンテナ = 1プロセス を絶対条件とはしない</p></li>
<li><p>子プロセスまで意識するのは本末転倒</p></li>
</ul>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id22">定期的にジョブを実行するアプリケーション</a></h4>
<ol class="arabic">
<li>
<p>ジョブ <code class="docutils literal">task.sh</code> を作る</p>
<blockquote>
<pre class="code sh"><a name="rest_code_3da0d669a7cc4ac19cd857c9c0feec82-1"></a><span class="ch">#!/bin/sh</span>
<a name="rest_code_3da0d669a7cc4ac19cd857c9c0feec82-2"></a><span class="nb">echo</span> <span class="s2">"[`date`] Hello!"</span> &gt;&gt; /var/log/cron.log
</pre>
</blockquote>
</li>
<li>
<p>cron の定義ファイル <code class="docutils literal"><span class="pre">cron-example</span></code> を作る</p>
<blockquote>
<pre class="code sh"><a name="rest_code_443d398585e44dc3bf567034547a418f-1"></a>* * * * *       root sh /usr/local/bin/task.sh
</pre>
</blockquote>
</li>
<li>
<p>Dockerfile を作る</p>
<blockquote>
<pre class="code docker"><a name="rest_code_dbb268def4124acbb0e652f67b49c13b-1"></a><span class="c"># ubuntu:16.04 イメージをベースにイメージをビルドする</span>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-2"></a><span class="k">FROM</span><span class="s"> ubuntu:16.04</span>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-3"></a>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-4"></a><span class="c"># apt で cron をインストールする</span>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-5"></a><span class="k">RUN</span> apt update
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-6"></a><span class="k">RUN</span> apt install -y cron
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-7"></a>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-8"></a><span class="c"># task.sh と cron-example を追加する</span>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-9"></a><span class="k">COPY</span> task.sh /usr/local/bin/
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-10"></a><span class="k">COPY</span> cron-example /etc/cron.d/
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-11"></a><span class="c"># cron-example に 644 パーミッションを設定する</span>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-12"></a><span class="k">RUN</span> chmod <span class="m">0644</span> /etc/cron.d/cron-example
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-13"></a>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-14"></a><span class="c"># cron を実行</span>
<a name="rest_code_dbb268def4124acbb0e652f67b49c13b-15"></a><span class="k">CMD</span> <span class="p">[</span><span class="s2">"cron"</span><span class="p">,</span> <span class="s2">"-f"</span><span class="p">]</span>
</pre>
</blockquote>
</li>
<li>
<p>Docker イメージをビルドする</p>
<blockquote>
<pre class="code console"><a name="rest_code_3d0eb0904f354551a4edb762acd17950-1"></a><span class="gp">$</span> docker image build -t example/cronjob:latest .
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-2"></a><span class="go">Sending build context to Docker daemon  4.096kB</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-3"></a><span class="go">Step 1/7 : FROM ubuntu:16.04</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-4"></a><span class="go">16.04: Pulling from library/ubuntu</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-5"></a><span class="go">18d680d61657: Pull complete</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-6"></a><span class="go">0addb6fece63: Pull complete</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-7"></a><span class="go">78e58219b215: Pull complete</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-8"></a><span class="go">eb6959a66df2: Pull complete</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-9"></a><span class="go">Digest: sha256:76702ec53c5e7771ba3f2c4f6152c3796c142af2b3cb1a02fce66c697db24f12</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-10"></a><span class="go">Status: Downloaded newer image for ubuntu:16.04</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-11"></a><span class="go"> ---&gt; 4a689991aa24</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-12"></a><span class="go">Step 2/7 : RUN apt update</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-13"></a><span class="go"> ---&gt; Running in f1a3582eabce</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-14"></a>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-15"></a><span class="go">WARNING: apt does not have a stable CLI interface. Use with caution in scripts.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-16"></a>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-17"></a><span class="go">Get:1 http://security.ubuntu.com/ubuntu xenial-security InRelease [107 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-18"></a><span class="go">Get:2 http://archive.ubuntu.com/ubuntu xenial InRelease [247 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-19"></a><span class="go">Get:3 http://security.ubuntu.com/ubuntu xenial-security/main amd64 Packages [745 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-20"></a><span class="go">Get:4 http://archive.ubuntu.com/ubuntu xenial-updates InRelease [109 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-21"></a><span class="go">Get:5 http://archive.ubuntu.com/ubuntu xenial-backports InRelease [107 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-22"></a><span class="go">Get:6 http://archive.ubuntu.com/ubuntu xenial/main amd64 Packages [1558 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-23"></a><span class="go">Get:7 http://security.ubuntu.com/ubuntu xenial-security/restricted amd64 Packages [12.7 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-24"></a><span class="go">Get:8 http://security.ubuntu.com/ubuntu xenial-security/universe amd64 Packages [507 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-25"></a><span class="go">Get:9 http://security.ubuntu.com/ubuntu xenial-security/multiverse amd64 Packages [4027 B]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-26"></a><span class="go">Get:10 http://archive.ubuntu.com/ubuntu xenial/restricted amd64 Packages [14.1 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-27"></a><span class="go">Get:11 http://archive.ubuntu.com/ubuntu xenial/universe amd64 Packages [9827 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-28"></a><span class="go">Get:12 http://archive.ubuntu.com/ubuntu xenial/multiverse amd64 Packages [176 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-29"></a><span class="go">Get:13 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 Packages [1139 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-30"></a><span class="go">Get:14 http://archive.ubuntu.com/ubuntu xenial-updates/restricted amd64 Packages [13.1 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-31"></a><span class="go">Get:15 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 Packages [906 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-32"></a><span class="go">Get:16 http://archive.ubuntu.com/ubuntu xenial-updates/multiverse amd64 Packages [19.0 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-33"></a><span class="go">Get:17 http://archive.ubuntu.com/ubuntu xenial-backports/main amd64 Packages [7959 B]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-34"></a><span class="go">Get:18 http://archive.ubuntu.com/ubuntu xenial-backports/universe amd64 Packages [8532 B]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-35"></a><span class="go">Fetched 15.5 MB in 7s (2058 kB/s)</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-36"></a><span class="go">Reading package lists...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-37"></a><span class="go">Building dependency tree...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-38"></a><span class="go">Reading state information...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-39"></a><span class="go">8 packages can be upgraded. Run 'apt list --upgradable' to see them.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-40"></a><span class="go">Removing intermediate container f1a3582eabce</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-41"></a><span class="go"> ---&gt; 830dd5ddc59f</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-42"></a><span class="go">Step 3/7 : RUN apt install -y cron</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-43"></a><span class="go"> ---&gt; Running in 422f3c36a217</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-44"></a>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-45"></a><span class="go">WARNING: apt does not have a stable CLI interface. Use with caution in scripts.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-46"></a>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-47"></a><span class="go">Reading package lists...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-48"></a><span class="go">Building dependency tree...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-49"></a><span class="go">Reading state information...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-50"></a><span class="go">Suggested packages:</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-51"></a><span class="go">  anacron logrotate checksecurity exim4 | postfix | mail-transport-agent</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-52"></a><span class="go">The following NEW packages will be installed:</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-53"></a><span class="go">  cron</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-54"></a><span class="go">0 upgraded, 1 newly installed, 0 to remove and 8 not upgraded.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-55"></a><span class="go">Need to get 68.4 kB of archives.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-56"></a><span class="go">After this operation, 249 kB of additional disk space will be used.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-57"></a><span class="go">Get:1 http://archive.ubuntu.com/ubuntu xenial/main amd64 cron amd64 3.0pl1-128ubuntu2 [68.4 kB]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-58"></a><span class="go">debconf: delaying package configuration, since apt-utils is not installed</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-59"></a><span class="go">Fetched 68.4 kB in 1s (46.3 kB/s)</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-60"></a><span class="go">Selecting previously unselected package cron.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-61"></a><span class="go">(Reading database ... 4768 files and directories currently installed.)</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-62"></a><span class="go">Preparing to unpack .../cron_3.0pl1-128ubuntu2_amd64.deb ...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-63"></a><span class="go">Unpacking cron (3.0pl1-128ubuntu2) ...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-64"></a><span class="go">Processing triggers for systemd (229-4ubuntu21.4) ...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-65"></a><span class="go">Setting up cron (3.0pl1-128ubuntu2) ...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-66"></a><span class="go">Adding group `crontab' (GID 106) ...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-67"></a><span class="go">Done.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-68"></a><span class="go">update-rc.d: warning: start and stop actions are no longer supported; falling back to defaults</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-69"></a><span class="go">update-rc.d: warning: stop runlevel arguments (1) do not match cron Default-Stop values (none)</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-70"></a><span class="go">invoke-rc.d: could not determine current runlevel</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-71"></a><span class="go">invoke-rc.d: policy-rc.d denied execution of start.</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-72"></a><span class="go">Processing triggers for systemd (229-4ubuntu21.4) ...</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-73"></a><span class="go">Removing intermediate container 422f3c36a217</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-74"></a><span class="go"> ---&gt; 26f4442bdb46</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-75"></a><span class="go">Step 4/7 : COPY task.sh /usr/local/bin/</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-76"></a><span class="go"> ---&gt; 19ffed305de1</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-77"></a><span class="go">Step 5/7 : COPY cron-example /etc/cron.d/</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-78"></a><span class="go"> ---&gt; 5c668e8b7598</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-79"></a><span class="go">Step 6/7 : RUN chmod 0644 /etc/cron.d/cron-example</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-80"></a><span class="go"> ---&gt; Running in 359ef325d9f4</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-81"></a><span class="go">Removing intermediate container 359ef325d9f4</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-82"></a><span class="go"> ---&gt; 50c072151bea</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-83"></a><span class="go">Step 7/7 : CMD ["cron", "-f"]</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-84"></a><span class="go"> ---&gt; Running in b459df083f79</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-85"></a><span class="go">Removing intermediate container b459df083f79</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-86"></a><span class="go"> ---&gt; 83bf96fc9d27</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-87"></a><span class="go">Successfully built 83bf96fc9d27</span>
<a name="rest_code_3d0eb0904f354551a4edb762acd17950-88"></a><span class="go">Successfully tagged example/cronjob:latest</span>
</pre>
</blockquote>
</li>
</ol>
<ol class="arabic" start="4">
<li>
<p>Docker イメージを実行する</p>
<blockquote>
<pre class="code console"><a name="rest_code_65b4831838a2487db96b2a6bb0427e87-1"></a><span class="gp">$</span> docker container run -d --rm --name cronjob example/cronjob:latest
<a name="rest_code_65b4831838a2487db96b2a6bb0427e87-2"></a><span class="go">05bb3788a766a415b3d888480faf7854351f1c39317deaeeff6aef8ce9f4c9c9</span>
</pre>
</blockquote>
</li>
<li>
<p>ジョブが実行されているところを見てみる</p>
<blockquote>
<pre class="code console"><a name="rest_code_55690fe3bc7d4bbb9fbc2a4c573e3d7d-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it cronjob tail -f /var/log/cron.log
<a name="rest_code_55690fe3bc7d4bbb9fbc2a4c573e3d7d-2"></a><span class="go">tail: cannot open '/var/log/cron.log' for reading: No such file or directory</span>
<a name="rest_code_55690fe3bc7d4bbb9fbc2a4c573e3d7d-3"></a><span class="go">tail: no files remaining</span>
</pre>
</blockquote>
</li>
<li>
<p>実行されていなかった。。</p>
<blockquote>
<p>cron 自体は動いていて、</p>
<pre class="code console"><a name="rest_code_e879d1cfd8ae41ee9f564213bbe1cd13-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it cronjob sh
<a name="rest_code_e879d1cfd8ae41ee9f564213bbe1cd13-2"></a><span class="gp">#</span> /etc/init.d/cron status
<a name="rest_code_e879d1cfd8ae41ee9f564213bbe1cd13-3"></a><span class="go"> * cron is running</span>
</pre>
<p><code class="docutils literal">task.sh</code> 単体では正常動作するので、</p>
<pre class="code console"><a name="rest_code_49cb02d4bf574e239892f2cc28ee7dfe-1"></a><span class="gp">#</span> sh /usr/local/bin/task.sh
<a name="rest_code_49cb02d4bf574e239892f2cc28ee7dfe-2"></a><span class="gp">#</span> cat /var/log/cron.log
<a name="rest_code_49cb02d4bf574e239892f2cc28ee7dfe-3"></a><span class="go">[Sun Nov 18 10:20:18 UTC 2018] Hello</span>
<a name="rest_code_49cb02d4bf574e239892f2cc28ee7dfe-4"></a><span class="go">[Sun Nov 18 10:30:22 UTC 2018] Hello</span>
</pre>
<p>たぶん、 cron の設定がよくないんだと思う。</p>
<p><code class="docutils literal">/etc/crontab</code> と同じ書式で書けば良い、とのことなので、</p>
<pre class="code console"><a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-1"></a><span class="gp">#</span> cat /etc/crontab
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-2"></a><span class="gp">#</span> /etc/crontab: system-wide crontab
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-3"></a><span class="gp">#</span> Unlike any other crontab you don<span class="s1">'t have to run the `crontab'</span>
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-4"></a><span class="gp">#</span> <span class="nb">command</span> to install the new version when you edit this file
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-5"></a><span class="gp">#</span> and files in /etc/cron.d. These files also have username fields,
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-6"></a><span class="gp">#</span> that none of the other crontabs <span class="k">do</span>.
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-7"></a>
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-8"></a><span class="go">SHELL=/bin/sh</span>
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-9"></a><span class="go">PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span>
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-10"></a>
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-11"></a><span class="gp">#</span> m h dom mon dow user  <span class="nb">command</span>
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-12"></a><span class="go">17 *    * * *   root    cd / &amp;&amp; run-parts --report /etc/cron.hourly</span>
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-13"></a><span class="go">25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )</span>
<a name="rest_code_9a4203a9a7ff4641bf0fdc33347b2091-14"></a><span class="go">...</span>
</pre>
<p>まねをして、 <code class="docutils literal"><span class="pre">cron-example</span></code> を更新した</p>
<pre class="code sh"><a name="rest_code_6c9311bf72b2448e987990dd6eea6f77-1"></a><span class="nv">SHELL</span><span class="o">=</span>/bin/sh                                                      <span class="c1"># これと</span>
<a name="rest_code_6c9311bf72b2448e987990dd6eea6f77-2"></a><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin  <span class="c1"># これを追記</span>
<a name="rest_code_6c9311bf72b2448e987990dd6eea6f77-3"></a>
<a name="rest_code_6c9311bf72b2448e987990dd6eea6f77-4"></a>* *    * * *   root    sh /usr/local/bin/task.sh                   <span class="c1"># ここのスペースの空け方もそっくり同じに変えた</span>
</pre>
<p><code class="docutils literal">docker container stop</code> -&gt; 再度 <code class="docutils literal">docker image build</code> -&gt; <code class="docutils literal">docker container run</code></p>
<p>動いた.......</p>
<pre class="code console"><a name="rest_code_8206b97b7f664d5aa278e02bc0487769-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it cronjob tail -f /var/log/cron.log
<a name="rest_code_8206b97b7f664d5aa278e02bc0487769-2"></a><span class="go">[Sun Nov 18 11:24:01 UTC 2018] Hello</span>
<a name="rest_code_8206b97b7f664d5aa278e02bc0487769-3"></a><span class="go">[Sun Nov 18 11:25:01 UTC 2018] Hello</span>
<a name="rest_code_8206b97b7f664d5aa278e02bc0487769-4"></a><span class="go">[Sun Nov 18 11:26:01 UTC 2018] Hello</span>
</pre>
<p>本の見本はきっと、「そんなのわかってるよね」で省略したんだな...</p>
</blockquote>
</li>
</ol>
<div class="section" id="id4">
<h5><a class="toc-backref" href="#id23">参考にしたサイト</a></h5>
<p>ありがとうございました!!!</p>
<ul class="simple">
<li><p><a class="reference external" href="https://teratail.com/questions/62291">ubuntuでcrontabに設定した反映が実行されない</a></p></li>
<li><p><a class="reference external" href="https://www.server-memo.net/tips/etc-crontab.html">/etc/crontabと/etc/cron.d設定ファイルの書き方</a></p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id24">3.1.2 1コンテナに1つの関心事</a></h3>
<p><cite>Each container should have only one concern</cite></p>
<p>コンテナは一つの関心事だけに集中すべきだ ( <a class="reference external" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/</a> )</p>
<ul class="simple">
<li><p>1つのコンテナはある1つの役割 (ロール) や問題領域 (ドメイン) のみにフォーカスされるべきである</p></li>
<li><p>それぞれのコンテナが担うべき役割を適切に見定め、かつそれがレプリカとして複製された場合でも副作用なくスタックとして正しく動作できる状態になるか？ という考え方に基づいて設計すると良い</p></li>
</ul>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id25">3.2 コンテナのポータビリティ</a></h2>
<p>Docker の大きな利点はポータビリティ (可搬性) にある。</p>
<ul class="simple">
<li><p>アプリケーションとインフラをコンテナという単位で分離できる</p></li>
<li><p>Docker がインストールされているホストであればアプリケーションとして同じ挙動が期待できる再現性がある</p></li>
<li><p>Docker が動作する環境でさえあればホストOSも問わない</p></li>
<li><p>実行するプラットフォームが、オンプレミス環境でもクラウド環境でも関係なく動く</p></li>
<li><p>Docker のポータビリティは完璧なものではなく、いくつかの例外が存在する</p></li>
</ul>
<div class="section" id="kernel">
<h3><a class="toc-backref" href="#id26">3.2.1 Kernel・アーキテクチャの違い</a></h3>
<ul class="simple">
<li><p>ホスト型仮想技術のようにハードウェアを演算によって再現する方式とは違い、Docker のコンテナ型貸そうか技術ではホストOSとカーネルのリソースを共有している</p></li>
<li><p>ある特定のCPUアーキテクチャやOSの前提の上に成立している</p></li>
</ul>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id27">3.2.2 ライブラリ・ダイナミックリンクの課題</a></h3>
<ul class="simple">
<li><p>アプリケーションが利用しているライブラリによっても、ポータビリティが損なわれるケースが存在する</p></li>
<li><p>ネイティブライブラリをダイナミックリンクするようなケース</p></li>
<li><p>Docker コンテナ上での実行を想定したアプリケーションを作るには、ネイティブライブラリを極力スタティックリンクしてビルドすることを第一に考えるべき</p></li>
<li><p>Docker において <strong>ポータビリティ</strong> という言葉はしばしば独り歩きしがちですが、これが絶対的なものではない、ということを理解しておかなければならない</p></li>
</ul>
</div>
</div>
<div class="section" id="docker">
<h2><a class="toc-backref" href="#id28">3.3 Docker フレンドリなアプリケーション</a></h2>
<p>コンテナ化の恩恵を最大限受けるには。</p>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id29">3.3.1 環境変数を活用する</a></h3>
<p>アプリケーションの挙動を環境変数で制御するのがおすすめ。</p>
<ul class="simple">
<li><p>環境変数は、アプリケーションとは別のリポジトリで管理するのが一般的</p></li>
<li><p>docker-compose であれば <code class="docutils literal">env</code> 属性に列挙する</p></li>
<li><p>Kubernetes や Amazon ECS にも同様の仕組みがある</p></li>
<li><p>各環境で利用する環境変数を定義したファイルを集約したリポジトリを作って管理するのが良いでしょう</p></li>
</ul>
</div>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id30">3.4 永続化データをどう扱うか</a></h2>
<p>Docker コンテナを実行中に書き込まれたファイルは、ホスト側にファイル・ディレクトリをマウントしない限りコンテナを廃棄したタイミングでディスクから消去される。</p>
<ul class="simple">
<li><p>Data Volume で各コンテナとホストで永続化データを共有するほかに、 Data Volume コンテナという永続化データ用のコンテナを起動する手法もある。</p></li>
</ul>
<div class="section" id="data-volume">
<h3><a class="toc-backref" href="#id31">3.4.1 Data Volume</a></h3>
<p>Docker コンテナ内のディレクトリをディスクに永続化するための仕組み</p>
<ul class="simple">
<li><p>ホスト・コンテナ間のディレクトリの共有・再利用が可能になる</p></li>
<li><p>イメージを更新して新しくコンテナを作成しても、同じ Data Volume を利用し続けることができる</p></li>
<li><p>コンテナを破棄してもディスクに保持される</p></li>
<li><p>コンテナでステートフルなアプリケーションを実行する用途に向いている</p></li>
</ul>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id32">Data Volume の作成</a></h4>
<pre class="code console"><a name="rest_code_7976832b095a463ab8f84c53503ef679-1"></a><span class="gp">$</span> docker container run <span class="o">[</span>options<span class="o">]</span> -v ホスト側ディレクトリ:コンテナ側ディレクトリ リポジトリ名<span class="o">[</span>:タグ<span class="o">]</span> <span class="o">[</span>コマンド<span class="o">]</span> <span class="o">[</span>コマンド引数<span class="o">]</span>
</pre>
<ul>
<li>
<p>コンテナの中で画像ファイルを作成する。</p>
<pre class="code console"><a name="rest_code_849b1472cfef440a9e5f9b9e935781ff-1"></a><span class="gp">$</span> docker container run -v <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>:/workspace gihyodocker/imagemagick:latest convert -size 100x100 xc:#000000 /workspace/gihyo.jpg
<a name="rest_code_849b1472cfef440a9e5f9b9e935781ff-2"></a><span class="go">Unable to find image 'gihyodocker/imagemagick:latest' locally</span>
<a name="rest_code_849b1472cfef440a9e5f9b9e935781ff-3"></a><span class="go">latest: Pulling from gihyodocker/imagemagick</span>
<a name="rest_code_849b1472cfef440a9e5f9b9e935781ff-4"></a><span class="go">ff3a5c916c92: Pull complete</span>
<a name="rest_code_849b1472cfef440a9e5f9b9e935781ff-5"></a><span class="go">9a79e6da4633: Pull complete</span>
<a name="rest_code_849b1472cfef440a9e5f9b9e935781ff-6"></a><span class="go">d46751c713a4: Pull complete</span>
<a name="rest_code_849b1472cfef440a9e5f9b9e935781ff-7"></a><span class="go">Digest: sha256:883299973ff2e6183ddc7e042d5b44e5c0bbe24b746ab382fba558a42284cb02</span>
<a name="rest_code_849b1472cfef440a9e5f9b9e935781ff-8"></a><span class="go">Status: Downloaded newer image for gihyodocker/imagemagick:latest</span>
</pre>
<ul class="simple">
<li><p>Data Volume を通じて、イメージを更新することなく、ホスト側で編集したファイルをコンテナに共有できる</p></li>
<li><p>Data Volume を設定していると、初回のコンテナ作成時にホスト側の指定したパスで共有されて、コンテナ停止・廃棄後も残る</p></li>
<li><p>ホストの特定のパスに依存しているし、ホスト側の Data Volume への誤操作によってアプリケーションに副作用が起きることもあるので、ポータビリティの面では課題のある手法であることも覚えておきましょう</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id33">3.4.2 Data Volume コンテナ</a></h3>
<ul class="simple">
<li><p>コンテナのデータ永続化手法として推奨されている</p></li>
<li><p>Data Volume コンテナによって Data Volume への操作がカプセル化されるため、ホストをあまり意識せずに Data Volume を利用できる</p></li>
<li><p>コンテナ内のアプリケーションとデータの密結合が緩和される</p></li>
<li>
<p>アプリケーションコンテナと Data Valume コンテナの付け替えや移行をスムーズに行うことができる</p>
<ul>
<li><p>コンテナ間でディレクトリを共有する</p></li>
<li><p>データだけを持つコンテナ</p></li>
<li><p>Data Volume コンテナの Volume は Docker の管理領域であるホスト側の <code class="docutils literal">/var/lib/docker/valumes/</code> 以下に配置されている</p></li>
<li><p>Docker の管理下にあるディレクトリのみに影響する</p></li>
<li><p>コンテナに与える影響を最小限に抑えられる</p></li>
<li><p>Data Volume コンテナは Volume への仲介役としての役割を持つ</p></li>
<li><p>Volume を必要とするコンテナは、ホスト側のその場所を知る必要はなく、ディレクトリを提供してくれる Data Volume コンテナのみ知っていればよい</p></li>
</ul>
</li>
</ul>
<div class="section" id="mysql-data-volume">
<h4><a class="toc-backref" href="#id34">MySQL のデータを Data Volume コンテナに保持する</a></h4>
<ol class="arabic">
<li>
<p>Data Volume コンテナの Dockerfile を用意する</p>
<blockquote>
<pre class="code docker"><a name="rest_code_ed6faa21298b475096d85b6fc4081bec-1"></a><span class="c"># 最小限のOSの機能を備えた非常に軽量なOS。しばしばベースのDockerイメージとして利用される</span>
<a name="rest_code_ed6faa21298b475096d85b6fc4081bec-2"></a><span class="k">FROM</span><span class="s"> busybox</span>
<a name="rest_code_ed6faa21298b475096d85b6fc4081bec-3"></a>
<a name="rest_code_ed6faa21298b475096d85b6fc4081bec-4"></a><span class="k">VOLUME</span><span class="s"> /var/lib/mysql</span>
<a name="rest_code_ed6faa21298b475096d85b6fc4081bec-5"></a>
<a name="rest_code_ed6faa21298b475096d85b6fc4081bec-6"></a><span class="k">CMD</span> <span class="p">[</span><span class="s2">"bin/true"</span><span class="p">]</span>
</pre>
</blockquote>
</li>
<li>
<p>Data Volume コンテナのイメージをビルドする</p>
<blockquote>
<pre class="code bash"><a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-1"></a><span class="c1"># Dockerfile のあるディレクトリで実行する</span>
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-2"></a>$ docker image build -t example/mysql-data:latest .
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-3"></a>Sending build context to Docker daemon  <span class="m">2</span>.048kB
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-4"></a>Step <span class="m">1</span>/3 : FROM busybox
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-5"></a>latest: Pulling from library/busybox
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-6"></a>90e01955edcd: Pull <span class="nb">complete</span>
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-7"></a>Digest: sha256:2a03a6059f21e150ae84b0973863609494aad70f0a80eaeb64bddd8d92465812
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-8"></a>Status: Downloaded newer image <span class="k">for</span> busybox:latest
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-9"></a> ---&gt; 59788edf1f3e
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-10"></a>Step <span class="m">2</span>/3 : VOLUME /var/lib/mysql
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-11"></a> ---&gt; Running in 1ab0898c94a2
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-12"></a>Removing intermediate container 1ab0898c94a2
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-13"></a> ---&gt; 1f5d663c0ce1
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-14"></a>Step <span class="m">3</span>/3 : CMD <span class="o">[</span><span class="s2">"bin/true"</span><span class="o">]</span>
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-15"></a> ---&gt; Running in 1fddf68af7c2
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-16"></a>Removing intermediate container 1fddf68af7c2
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-17"></a> ---&gt; e4bdb5df5b5d
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-18"></a>Successfully built e4bdb5df5b5d
<a name="rest_code_bc2720e7e4fe4cf0aaf5403418bf7bae-19"></a>Successfully tagged example/mysql-data:latest
</pre>
</blockquote>
</li>
<li>
<p>Data Volume コンテナを実行する (コンテナは廃棄されない限りディスクに保持される)</p>
<blockquote>
<pre class="code console"><a name="rest_code_bfb984c6b66d400db95ab3e833c2d096-1"></a><span class="gp">$</span> docker container run -d --name mysql-data example/mysql-data:latest
<a name="rest_code_bfb984c6b66d400db95ab3e833c2d096-2"></a><span class="go">edaab85b9b7e3505c93d8d8947ef2b868cd620765a439bbb77a93c92cfa96373</span>
</pre>
</blockquote>
</li>
<li>
<p>MySQL コンテナを実行する</p>
<blockquote>
<pre class="code console"><a name="rest_code_b973f3e8275a465c894691c97ef895b2-1"></a><span class="gp">$</span> docker container run -d --rm --name mysql <span class="se">\</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-2"></a>  -e <span class="s2">"MYSQL_ALLOW_EMPTY_PASSWORD=yes"</span> <span class="se">\</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-3"></a>  -e <span class="s2">"MYSQL_DATABASE=volume_test"</span> <span class="se">\</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-4"></a>  -e <span class="s2">"MYSQL_USER=example"</span> <span class="se">\</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-5"></a>  -e <span class="s2">"MYSQL_PASSWORD=example"</span> <span class="se">\</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-6"></a>  --volumes-from mysql-data <span class="se">\</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-7"></a>  mysql:5.7
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-8"></a>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-9"></a><span class="go">Unable to find image 'mysql:5.7' locally</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-10"></a><span class="go">5.7: Pulling from library/mysql</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-11"></a><span class="go">a5a6f2f73cd8: Pulling fs layer</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-12"></a><span class="go">936836019e67: Pulling fs layer</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-13"></a><span class="go">283fa4c95fb4: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-14"></a><span class="go">1f212fb371f9: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-15"></a><span class="go">e2ae0d063e89: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-16"></a><span class="go">5ed0ae805b65: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-17"></a><span class="go">0283dc49ef4e: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-18"></a><span class="go">a7905d9fbbea: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-19"></a><span class="go">cd2a65837235: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-20"></a><span class="go">5f906b8da5fe: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-21"></a><span class="go">e81e51815567: Pull complete</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-22"></a><span class="go">Digest: sha256:c23e9bfe66eeffc990cf6bce4bb0e9c5c85eb908170f3b3dde3e9a12c5a91689</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-23"></a><span class="go">Status: Downloaded newer image for mysql:5.7</span>
<a name="rest_code_b973f3e8275a465c894691c97ef895b2-24"></a><span class="go">f702db74f9156b20595fe04d3df09b2f0008bf707bb9b2c32db593fd33941342</span>
</pre>
</blockquote>
</li>
<li>
<p>実行中の mysql コンテナに root アカウントでログイン (パスワードは空)</p>
<blockquote>
<pre class="code console"><a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it mysql mysql -u root -p volume_test
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-2"></a>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-3"></a><span class="go">Enter password:</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-4"></a><span class="go">Welcome to the MySQL monitor.  Commands end with ; or \g.</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-5"></a><span class="go">Your MySQL connection id is 2</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-6"></a><span class="go">Server version: 5.7.24 MySQL Community Server (GPL)</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-7"></a>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-8"></a><span class="go">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-9"></a>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-10"></a><span class="go">Oracle is a registered trademark of Oracle Corporation and/or its</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-11"></a><span class="go">affiliates. Other names may be trademarks of their respective</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-12"></a><span class="go">owners.</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-13"></a>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-14"></a><span class="go">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-15"></a>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-16"></a><span class="go">mysql&gt; CREATE TABLE user(</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-17"></a><span class="go">    -&gt;   id int PRIMARY KEY AUTO_INCREMENT,</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-18"></a><span class="go">    -&gt;   name VARCHAR(255)</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-19"></a><span class="go">    -&gt; ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_unicode_ci;</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-20"></a><span class="go">Query OK, 0 rows affected (0.01 sec)</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-21"></a>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-22"></a><span class="go">mysql&gt; INSERT INTO user (name) VALUES ('gihyo'), ('docker'), ('Solomon Hykes');</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-23"></a><span class="go">Query OK, 3 rows affected (0.01 sec)</span>
<a name="rest_code_22b880fbabf34d3199694a82b0ff58c6-24"></a><span class="go">Records: 3  Duplicates: 0  Warnings: 0</span>
</pre>
</blockquote>
</li>
<li>
<p>mysql コンテナを停止する ( --rm オプションをつけて実行したため、停止すると廃棄される)</p>
<blockquote>
<pre class="code console"><a name="rest_code_dac0d93caf374d6580ff142d2334a6c0-1"></a><span class="gp">$</span> docker container stop mysql
<a name="rest_code_dac0d93caf374d6580ff142d2334a6c0-2"></a><span class="go">mysql</span>
</pre>
</blockquote>
</li>
<li>
<p>再度、新しい mysql コンテナを実行する。</p>
<blockquote>
<pre class="code console"><a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-1"></a><span class="gp">$</span> docker container run -d --rm --name mysql <span class="se">\</span>
<a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-2"></a>  -e <span class="s2">"MYSQL_ALLOW_EMPTY_PASSWORD=yes"</span> <span class="se">\</span>
<a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-3"></a>  -e <span class="s2">"MYSQL_DATABASE=volume_test"</span> <span class="se">\</span>
<a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-4"></a>  -e <span class="s2">"MYSQL_USER=example"</span> <span class="se">\</span>
<a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-5"></a>  -e <span class="s2">"MYSQL_PASSWORD=example"</span> <span class="se">\</span>
<a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-6"></a>  --volumes-from mysql-data <span class="se">\</span>
<a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-7"></a>  mysql:5.7
<a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-8"></a>
<a name="rest_code_6e6e935069fa4544844a4f6f02c5f382-9"></a><span class="go">f180d4063914b43b7d522324eb5abf5640b67d6342cb353b04ea77f85d347dcb</span>
</pre>
</blockquote>
</li>
<li>
<p>実行中の mysql コンテナに root アカウントでログイン (パスワードは空) すると、先ほどのデータが残っている!!</p>
<blockquote>
<pre class="code console"><a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it mysql mysql -u root -p volume_test
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-2"></a>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-3"></a><span class="go">Enter password:</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-4"></a><span class="go">Reading table information for completion of table and column names</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-5"></a><span class="go">You can turn off this feature to get a quicker startup with -A</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-6"></a>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-7"></a><span class="go">Welcome to the MySQL monitor.  Commands end with ; or \g.</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-8"></a><span class="go">Your MySQL connection id is 2</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-9"></a><span class="go">Server version: 5.7.24 MySQL Community Server (GPL)</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-10"></a>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-11"></a><span class="go">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-12"></a>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-13"></a><span class="go">Oracle is a registered trademark of Oracle Corporation and/or its</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-14"></a><span class="go">affiliates. Other names may be trademarks of their respective</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-15"></a><span class="go">owners.</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-16"></a>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-17"></a><span class="go">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-18"></a>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-19"></a><span class="go">mysql&gt; SELECT * FROM user;</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-20"></a><span class="go">+----+---------------+</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-21"></a><span class="go">| id | name          |</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-22"></a><span class="go">+----+---------------+</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-23"></a><span class="go">|  1 | gihyo         |</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-24"></a><span class="go">|  2 | docker        |</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-25"></a><span class="go">|  3 | Solomon Hykes |</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-26"></a><span class="go">+----+---------------+</span>
<a name="rest_code_bf123fcc25c84a7dab43ca04467ad07f-27"></a><span class="go">3 rows in set (0.00 sec)</span>
</pre>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id35">データのエクスポートとリストア</a></h4>
<ul>
<li><p>Data Volume は同一 Docker ホスト内でのみ有効</p></li>
<li>
<p>他の Docker ホストで使いたいときは、 Data Volume コンテナからデータをファイルとしてホストにエクスポートする</p>
<pre class="code console"><a name="rest_code_c7fc14bc5eb6404eba2516b7e1a32c8f-1"></a><span class="gp">$</span> docker container run -v <span class="sb">`</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="sb">`</span>:/tmp <span class="se">\</span>
<a name="rest_code_c7fc14bc5eb6404eba2516b7e1a32c8f-2"></a>  --volumes-from mysql-data <span class="se">\</span>
<a name="rest_code_c7fc14bc5eb6404eba2516b7e1a32c8f-3"></a>  busybox <span class="se">\</span>
<a name="rest_code_c7fc14bc5eb6404eba2516b7e1a32c8f-4"></a>  tar cvzf /tmp/mysql-backup.tar.gz /var/lib/mysql
</pre>
<ul class="simple">
<li><p>これ (できなかったけど) はちょっと不便なので、Volume Plugins がいろいろある</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="id13">
<h2><a class="toc-backref" href="#id36">3.5 コンテナ配置戦略</a></h2>
<p>多くのリクエストをさばく必要のある実用的なシステムでは複数のコンテナを複数のホストに配置させる必要がある</p>
<ul class="simple">
<li><p>コンテナをどのように配置すべきか</p></li>
<li><p>複数の Docker ホストをどのように制御すべきか</p></li>
</ul>
<div class="section" id="docker-swarm">
<h3><a class="toc-backref" href="#id37">3.5.1 Docker Swarm</a></h3>
<p>Docker Swarm:</p>
<ul class="simple">
<li><p>複数の Docker ホストを束ねてクラスタ化するためのツール</p></li>
<li><p>コンテナオーケストレーションシステムのひとつ</p></li>
<li><p>複数のッホストを意識せずにクラスタを透過的に操作できる</p></li>
</ul>
<table class="colwidths-auto">
<caption>Docker でのコンテナオーケストレーションに関わる名称</caption>
<thead><tr>
<th class="head"><p>名称</p></th>
<th class="head"><p>役割</p></th>
<th class="head"><p>対応するコマンド</p></th>
</tr></thead>
<tbody>
<tr>
<td><p>Compose</p></td>
<td><p>複数コンテナを使う Docker アプリケーションの管理 (主にシングルホスト)</p></td>
<td><p>docker-compose</p></td>
</tr>
<tr>
<td><p>Swarm</p></td>
<td><p>クラスタの構築や管理を担う (主にマルチホスト)</p></td>
<td><p>docker swarm</p></td>
</tr>
<tr>
<td><p>Service</p></td>
<td><p>Swarm前提、クラスタ内の Service (1つ以上のコンテナの集まり) を管理する</p></td>
<td><p>docker service</p></td>
</tr>
<tr>
<td><p>Stack</p></td>
<td><p>Swarm前提、複数の Service をまとめたアプリケーション全体の管理</p></td>
<td><p>docker stack</p></td>
</tr>
</tbody>
</table>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id38">複数の Docker ホストを用意し、 Swarm クラスタを構築する</a></h4>
<p>Docker in Docker (dind):</p>
<ul class="simple">
<li><p>Docker ホストとして機能する Docker コンテナを複数個立てられる</p></li>
<li><p>Docker ホストをコンテナで入れ子にできる</p></li>
</ul>
<ol class="arabic">
<li>
<p><code class="docutils literal"><span class="pre">docker-compose.yml</span></code> を作成する。</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-1"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-2"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-3"></a>  <span class="nt">registry</span><span class="p">:</span>  <span class="c1"># Docker レジストリ役のコンテナ</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-4"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">registry</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-5"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">registry:2.6</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-6"></a>    <span class="nt">ports</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-7"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5000:5000</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-8"></a>    <span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-9"></a>      <span class="p p-Indicator">-</span> <span class="s">"./registry-data:/var/lib/registry"</span>  <span class="c1"># 永続化のため、ホストにマウント</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-10"></a>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-11"></a>  <span class="nt">manager</span><span class="p">:</span>  <span class="c1"># Swarm クラスタ全体を制御する役割</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-12"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">manager</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-13"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker:18.05.0-ce-dind</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-14"></a>    <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-15"></a>    <span class="nt">tty</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-16"></a>    <span class="nt">ports</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-17"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000:80</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-18"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:9000</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-19"></a>    <span class="nt">depends_on</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-20"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">registry</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-21"></a>    <span class="nt">expose</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-22"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">3375</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-23"></a>    <span class="nt">command</span><span class="p">:</span> <span class="s">"--insecure-registry</span><span class="nv"> </span><span class="s">registry:5000"</span>  <span class="c1"># HTTP でも利用できるようにしている</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-24"></a>    <span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-25"></a>      <span class="p p-Indicator">-</span> <span class="s">"./stack:/stack"</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-26"></a>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-27"></a>  <span class="nt">worker01</span><span class="p">:</span>  <span class="c1"># ノードの役割</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-28"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">worker01</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-29"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker:18.05.0-ce-dind</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-30"></a>    <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-31"></a>    <span class="nt">tty</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-32"></a>    <span class="nt">depends_on</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-33"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">manager</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-34"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">registry</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-35"></a>    <span class="nt">expose</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-36"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7946</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-37"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7946/udp</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-38"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4789/udp</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-39"></a>    <span class="nt">command</span><span class="p">:</span> <span class="s">"--insecure-registry</span><span class="nv"> </span><span class="s">registry:5000"</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-40"></a>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-41"></a>  <span class="nt">worker02</span><span class="p">:</span>  <span class="c1"># ノードの役割</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-42"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">worker02</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-43"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker:18.05.0-ce-dind</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-44"></a>    <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-45"></a>    <span class="nt">tty</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-46"></a>    <span class="nt">depends_on</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-47"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">manager</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-48"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">registry</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-49"></a>    <span class="nt">expose</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-50"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7946</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-51"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7946/udp</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-52"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4789/udp</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-53"></a>    <span class="nt">command</span><span class="p">:</span> <span class="s">"--insecure-registry</span><span class="nv"> </span><span class="s">registry:5000"</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-54"></a>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-55"></a>  <span class="nt">worker03</span><span class="p">:</span>  <span class="c1"># ノードの役割</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-56"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">worker03</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-57"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker:18.05.0-ce-dind</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-58"></a>    <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-59"></a>    <span class="nt">tty</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-60"></a>    <span class="nt">depends_on</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-61"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">manager</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-62"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">registry</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-63"></a>    <span class="nt">expose</span><span class="p">:</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-64"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7946</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-65"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7946/udp</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-66"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4789/udp</span>
<a name="rest_code_4d2289a87d154d1489e432d2ae8d8527-67"></a>    <span class="nt">command</span><span class="p">:</span> <span class="s">"--insecure-registry</span><span class="nv"> </span><span class="s">registry:5000"</span>
</pre>
</blockquote>
</li>
<li>
<p>Compose を実行する。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_a618083de33541ddbb4b91d1ef48c002-1"></a>$ docker-compose up -d
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-2"></a>...
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-3"></a>Creating registry ... <span class="k">done</span>
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-4"></a>Creating manager  ... <span class="k">done</span>
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-5"></a>Creating worker03 ... <span class="k">done</span>
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-6"></a>Creating worker01 ... <span class="k">done</span>
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-7"></a>Creating worker02 ... <span class="k">done</span>
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-8"></a>
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-9"></a><span class="c1"># 実行中のコンテナを確認する</span>
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-10"></a>$ docker container ls
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-11"></a>CONTAINER ID        IMAGE                    COMMAND                  CREATED             STATUS              PORTS                                                              NAMES
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-12"></a>cfffba103c8c        docker:18.05.0-ce-dind   <span class="s2">"dockerd-entrypoint.…"</span>   <span class="m">5</span> seconds ago       Up <span class="m">4</span> seconds        <span class="m">2375</span>/tcp, <span class="m">4789</span>/udp, <span class="m">7946</span>/tcp, <span class="m">7946</span>/udp                             worker03
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-13"></a>272227e51007        docker:18.05.0-ce-dind   <span class="s2">"dockerd-entrypoint.…"</span>   <span class="m">5</span> seconds ago       Up <span class="m">4</span> seconds        <span class="m">2375</span>/tcp, <span class="m">4789</span>/udp, <span class="m">7946</span>/tcp, <span class="m">7946</span>/udp                             worker02
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-14"></a>7190447651de        docker:18.05.0-ce-dind   <span class="s2">"dockerd-entrypoint.…"</span>   <span class="m">5</span> seconds ago       Up <span class="m">4</span> seconds        <span class="m">2375</span>/tcp, <span class="m">4789</span>/udp, <span class="m">7946</span>/tcp, <span class="m">7946</span>/udp                             worker01
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-15"></a>a7e4b99c1ee7        docker:18.05.0-ce-dind   <span class="s2">"dockerd-entrypoint.…"</span>   <span class="m">6</span> seconds ago       Up <span class="m">5</span> seconds        <span class="m">2375</span>/tcp, <span class="m">3375</span>/tcp, <span class="m">0</span>.0.0.0:9000-&gt;9000/tcp, <span class="m">0</span>.0.0.0:8000-&gt;80/tcp   manager
<a name="rest_code_a618083de33541ddbb4b91d1ef48c002-16"></a>3c0a564dbbac        registry:2.6             <span class="s2">"/entrypoint.sh /etc…"</span>   <span class="m">7</span> seconds ago       Up <span class="m">6</span> seconds        <span class="m">0</span>.0.0.0:5000-&gt;5000/tcp                                             registry
</pre>
</blockquote>
</li>
<li>
<p>manager コンテナを、 Swarm の manager に設定する。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-1"></a>$ docker container <span class="nb">exec</span> -it manager docker swarm init
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-2"></a><span class="c1"># JOIN トークンが発行される</span>
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-3"></a><span class="c1"># Docker ホストを Swarm クラスタの worker として登録するには、この JOIN トークンが必要</span>
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-4"></a>Swarm initialized: current node <span class="o">(</span>7f20ikf4s04lp9abasnvm8euz<span class="o">)</span> is now a manager.
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-5"></a>
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-6"></a>To add a worker to this swarm, run the following command:
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-7"></a>
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-8"></a>    docker swarm join --token SWMTKN-1-55tobs2vcs0odcbd40q5m42y9obs08wgm4200q9udctpv25gu6-4oy23esi800n14wwoddl7ma4n <span class="m">172</span>.27.0.3:2377
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-9"></a>
<a name="rest_code_38676eb79c7e43729a53820ba4d4fb14-10"></a>To add a manager to this swarm, run <span class="s1">'docker swarm join-token manager'</span> and follow the instructions.
</pre>
</blockquote>
</li>
<li>
<p>JOIN トークンを利用して、3つのノードを Swarm クラスタに worker として登録する。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_5ba980525d6d4c6f824084a8581e1937-1"></a><span class="c1"># manager と全ての worker コンテナは Compose で作成されたデフォルトネットワーク上で実行されているので、お互いをコンテナ名で名前解決できる</span>
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-2"></a>$ docker container <span class="nb">exec</span> -it worker01 docker swarm join <span class="se">\</span>
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-3"></a>  --token SWMTKN-1-55tobs2vcs0odcbd40q5m42y9obs08wgm4200q9udctpv25gu6-4oy23esi800n14wwoddl7ma4n manager:2377
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-4"></a>This node joined a swarm as a worker.
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-5"></a>$ docker container <span class="nb">exec</span> -it worker02 docker swarm join <span class="se">\</span>
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-6"></a>  --token SWMTKN-1-55tobs2vcs0odcbd40q5m42y9obs08wgm4200q9udctpv25gu6-4oy23esi800n14wwoddl7ma4n manager:2377
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-7"></a>This node joined a swarm as a worker.
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-8"></a>$ docker container <span class="nb">exec</span> -it worker03 docker swarm join <span class="se">\</span>
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-9"></a>  --token SWMTKN-1-55tobs2vcs0odcbd40q5m42y9obs08wgm4200q9udctpv25gu6-4oy23esi800n14wwoddl7ma4n manager:2377
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-10"></a>This node joined a swarm as a worker.
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-11"></a>
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-12"></a><span class="c1"># ノードが追加されたか確認する。</span>
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-13"></a>$ docker container <span class="nb">exec</span> -it manager docker node ls
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-14"></a>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-15"></a>u8crbubyz85jmnpou9zgnc1wf     272227e51007        Ready               Active                                  <span class="m">18</span>.05.0-ce
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-16"></a>ww80hcmlzbga1cprtz0cmmuu2     7190447651de        Ready               Active                                  <span class="m">18</span>.05.0-ce
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-17"></a>7f20ikf4s04lp9abasnvm8euz *   a7e4b99c1ee7        Ready               Active              Leader              <span class="m">18</span>.05.0-ce
<a name="rest_code_5ba980525d6d4c6f824084a8581e1937-18"></a>j91gerxg4um0r05wukdfoqwo1     cfffba103c8c        Ready               Active                                  <span class="m">18</span>.05.0-ce
</pre>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="docker-push">
<h4><a class="toc-backref" href="#id39">Docker レジストリにイメージを Push する</a></h4>
<ol class="arabic">
<li>
<p>Docker イメージにタグをつける</p>
<blockquote>
<pre class="code bash"><a name="rest_code_02c62bed4f5049748788043bf9d785bd-1"></a><span class="c1"># docker image tag example/echo:latest [レジストリのホスト/]リポジトリ名[:タグ]</span>
<a name="rest_code_02c62bed4f5049748788043bf9d785bd-2"></a><span class="c1"># レジストリのホスト = イメージの push 先および pull 先のレジストリ</span>
<a name="rest_code_02c62bed4f5049748788043bf9d785bd-3"></a>$ docker image tag example/echo:latest localhost:5000/example/echo:latest
</pre>
</blockquote>
</li>
<li>
<p>ホストから、 registry コンテナにイメージを push する</p>
<blockquote>
<pre class="code bash"><a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-1"></a><span class="c1"># 2章で作ったイメージを push する</span>
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-2"></a>$ docker image push localhost:5000/example/echo:latest
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-3"></a>The push refers to repository <span class="o">[</span>localhost:5000/example/echo<span class="o">]</span>
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-4"></a>b2aff6d696c0: Preparing
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-5"></a>f18abb5d7b45: Preparing
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-6"></a>186d94bd2c62: Preparing
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-7"></a>b2aff6d696c0: Pushed
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-8"></a>e7dc337030ba: Pushed
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-9"></a>920961b94eb3: Pushed
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-10"></a>fa0c3f992cbd: Pushed
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-11"></a>ce6466f43b11: Pushed
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-12"></a>719d45669b35: Pushed
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-13"></a>3b10514a95be: Pushed
<a name="rest_code_65fb1fd5e9574a588e9c469e70218f41-14"></a>latest: digest: sha256:834be6348517746b53f3d44c56b580a0cea74161b86426cc006b1c066c48e047 size: <span class="m">2417</span>
</pre>
</blockquote>
</li>
<li>
<p>worker01 コンテナ上で registry コンテナから Docker イメージを pull する。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_0df2d9e3ad494778943ede9ed238eba6-1"></a><span class="c1"># worker01 から registry で名前解決できる</span>
<a name="rest_code_0df2d9e3ad494778943ede9ed238eba6-2"></a>$ docker container <span class="nb">exec</span> -it worker01 docker image pull registry:5000/example/echo:latest
<a name="rest_code_0df2d9e3ad494778943ede9ed238eba6-3"></a>
<a name="rest_code_0df2d9e3ad494778943ede9ed238eba6-4"></a><span class="c1"># イメージを pull できたか確認する。</span>
<a name="rest_code_0df2d9e3ad494778943ede9ed238eba6-5"></a>$ docker container <span class="nb">exec</span> -it worker01 docker image ls
</pre>
</blockquote>
</li>
</ol>
</div>
</div>
<div class="section" id="service">
<h3><a class="toc-backref" href="#id40">3.5.2 Service</a></h3>
<ul class="simple">
<li><p>Service にレプリカ数の制御を指示すると、自動でコンテナを複製し、複数のノードにまたがって適切に配置してくれる。</p></li>
<li><p>スケールアウトが容易</p></li>
<li><p><code class="docutils literal">docker container run</code> の代わりにこれ</p></li>
</ul>
<p>Service を作成する。</p>
<pre class="code console"><a name="rest_code_00c641f821724e9dbb8093cdb6c10803-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager <span class="se">\</span>
<a name="rest_code_00c641f821724e9dbb8093cdb6c10803-2"></a>  docker service create --replicas <span class="m">1</span> --publish <span class="m">8000</span>:8000 --name <span class="nb">echo</span> registry:5000/example/echo:latest
</pre>
<p>Service の一覧を表示する。</p>
<pre class="code console"><a name="rest_code_8571f65ec8534f8fb54164b4a488bd82-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker service ls
<a name="rest_code_8571f65ec8534f8fb54164b4a488bd82-2"></a><span class="go">ID                  NAME                MODE                REPLICAS            IMAGE                               PORTS</span>
<a name="rest_code_8571f65ec8534f8fb54164b4a488bd82-3"></a><span class="go">uurtfoiovt5t        echo                replicated          1/1                 registry:5000/example/echo:latest   *:8000-&gt;8000/tcp</span>
</pre>
<p>該当サービスのコンテナ数を増減できる。</p>
<pre class="code console"><a name="rest_code_79357cefd26a4900a253a421a2a6bda8-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker service scale <span class="nv">echo</span><span class="o">=</span><span class="m">6</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-2"></a><span class="go">echo scaled to 6</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-3"></a><span class="go">overall progress: 6 out of 6 tasks</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-4"></a><span class="go">1/6: running   [==================================================&gt;]</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-5"></a><span class="go">2/6: running   [==================================================&gt;]</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-6"></a><span class="go">3/6: running   [==================================================&gt;]</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-7"></a><span class="go">4/6: running   [==================================================&gt;]</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-8"></a><span class="go">5/6: running   [==================================================&gt;]</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-9"></a><span class="go">6/6: running   [==================================================&gt;]</span>
<a name="rest_code_79357cefd26a4900a253a421a2a6bda8-10"></a><span class="go">verify: Service converged</span>
</pre>
<p>Swarm クラスタ上で実行されているコンテナを確認する。</p>
<pre class="code bash"><a name="rest_code_67d54e3fe0594a69b9b4880dbcad31d8-1"></a>$ docker container <span class="nb">exec</span> -it manager docker service ps <span class="nb">echo</span> <span class="p">|</span> grep Running
<a name="rest_code_67d54e3fe0594a69b9b4880dbcad31d8-2"></a><span class="c1"># Service によって Swarm クラスタのノードに分散して配置されていることがわかる</span>
<a name="rest_code_67d54e3fe0594a69b9b4880dbcad31d8-3"></a>q5rd4bezklf2        echo.1              registry:5000/example/echo:latest   a7e4b99c1ee7        Running             Running <span class="m">8</span> minutes ago
<a name="rest_code_67d54e3fe0594a69b9b4880dbcad31d8-4"></a>cgt98m1d4395        echo.2              registry:5000/example/echo:latest   cfffba103c8c        Running             Running about a minute ago
<a name="rest_code_67d54e3fe0594a69b9b4880dbcad31d8-5"></a>u5120nxk830w        echo.3              registry:5000/example/echo:latest   7190447651de        Running             Running <span class="m">2</span> minutes ago
<a name="rest_code_67d54e3fe0594a69b9b4880dbcad31d8-6"></a>9ejgtkum844u        echo.4              registry:5000/example/echo:latest   272227e51007        Running             Running about a minute ago
<a name="rest_code_67d54e3fe0594a69b9b4880dbcad31d8-7"></a>mqkivzbb5j3e        echo.5              registry:5000/example/echo:latest   272227e51007        Running             Running about a minute ago
<a name="rest_code_67d54e3fe0594a69b9b4880dbcad31d8-8"></a>7xdlngpoid1i        echo.6              registry:5000/example/echo:latest   a7e4b99c1ee7        Running             Running <span class="m">2</span> minutes ago
</pre>
<p>デプロイした service は <code class="docutils literal">docker service rm</code> サービス名 で削除できる。</p>
<pre class="code console"><a name="rest_code_ab7c2be0c5834837b409b7304c8a2d29-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker service rm <span class="nb">echo</span>
<a name="rest_code_ab7c2be0c5834837b409b7304c8a2d29-2"></a><span class="go">echo</span>
<a name="rest_code_ab7c2be0c5834837b409b7304c8a2d29-3"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker service ls
<a name="rest_code_ab7c2be0c5834837b409b7304c8a2d29-4"></a><span class="go">ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span>
</pre>
</div>
<div class="section" id="stack">
<h3><a class="toc-backref" href="#id41">3.5.3 Stack</a></h3>
<p>Stack: 複数の Service をグルーピングした単位であり、アプリケーションの全体の構成を定義する。</p>
<ul class="simple">
<li><p>Service は１つのアプリケーションイメージしか扱うことができないが、複数の Service が強調して動作することで成立するアプリケーションも多くある</p></li>
<li><p>これを解決する上位概念が Stack</p></li>
<li><p>Stack は複数の Service を扱うことができる</p></li>
<li><p>Stack が扱うアプリケーションの粒度は Compose と同等</p></li>
<li><p>Stack はいわば Swarm 上でスケールイン・スケールアウトや constraint が可能になった Compose という位置付け</p></li>
<li><p>Stack によってデプロイされる Service 群は overlay ネットワークに所属する</p></li>
<li><p>overlay ネットワークとは複数の Docker ホストにデプロイされているコンテナ群を同じネットワークに配置させることができる技術</p></li>
<li><p>overlay ネットワークによって、 Docker ホスト間を越えたコンテナ間通信が可能となる</p></li>
</ul>
<ol class="arabic">
<li>
<p>overlay ネットワークを作成する。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_5c23953e1cf8472da60cbebb62af6890-1"></a><span class="c1"># ch03 という名前にする</span>
<a name="rest_code_5c23953e1cf8472da60cbebb62af6890-2"></a>$ docker container <span class="nb">exec</span> -it manager docker network create --driver<span class="o">=</span>overlay --attachable ch03
<a name="rest_code_5c23953e1cf8472da60cbebb62af6890-3"></a>ts9rcnez3tl5oi4z9p0qbc030
</pre>
</blockquote>
</li>
<li>
<p>Stack を作成する。</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-1"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-2"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-3"></a>  <span class="nt">nginx</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-4"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gihyodocker/nginx-proxy:latest</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-5"></a>    <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-6"></a>      <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>                  <span class="c1"># レプリカ数</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-7"></a>      <span class="nt">placement</span><span class="p">:</span>                   <span class="c1"># コンテナの配置戦略</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-8"></a>        <span class="nt">constraints</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">node.role != manager</span><span class="p p-Indicator">]</span>  <span class="c1"># manager 以外のノードにコンテナを配置する</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-9"></a>    <span class="nt">environment</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-10"></a>      <span class="nt">BACKEND_HOST</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo_api:8080</span>  <span class="c1"># リクエストの転送先</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-11"></a>    <span class="nt">depends_on</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-12"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">api</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-13"></a>    <span class="nt">networks</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-14"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ch03</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-15"></a>  <span class="nt">api</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-16"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">registry:5000/example/echo:latest</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-17"></a>    <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-18"></a>      <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>                  <span class="c1"># レプリカ数</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-19"></a>      <span class="nt">placement</span><span class="p">:</span>                   <span class="c1"># コンテナの配置戦略</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-20"></a>        <span class="nt">constraints</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">node.role != manager</span><span class="p p-Indicator">]</span>  <span class="c1"># manager 以外のノードにコンテナを配置する</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-21"></a>    <span class="nt">networks</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-22"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ch03</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-23"></a>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-24"></a><span class="nt">networks</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-25"></a>  <span class="nt">ch03</span><span class="p">:</span>
<a name="rest_code_6ab3c669b69245c6a297c190f5e54fa1-26"></a>    <span class="nt">external</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre>
<table class="colwidths-auto">
<caption>docker stack のサブコマンド</caption>
<thead><tr>
<th class="head"><p>stack サブコマンド</p></th>
<th class="head"><p>内容</p></th>
</tr></thead>
<tbody>
<tr>
<td><p>deploy</p></td>
<td><p>新規に Stack をデプロイ、または更新する</p></td>
</tr>
<tr>
<td><p>ls</p></td>
<td><p>デプロイされている Stack の一覧を表示する</p></td>
</tr>
<tr>
<td><p>ps</p></td>
<td><p>Stack によってデプロイされているコンテナの一覧を表示する</p></td>
</tr>
<tr>
<td><p>rm</p></td>
<td><p>デプロイされている Stack を削除する</p></td>
</tr>
<tr>
<td><p>services</p></td>
<td><p>Stack 内の Service 一覧を表示する</p></td>
</tr>
</tbody>
</table>
</blockquote>
</li>
</ol>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id42">Stack をデプロイする</a></h4>
<pre class="code console"><a name="rest_code_94840b3c1c3e480c82892ae8ca392c5e-1"></a><span class="gp">$</span> docker stack deploy <span class="o">[</span>options<span class="o">]</span> stack名
</pre>
<ul class="simple">
<li><p><code class="docutils literal"><span class="pre">-c</span></code>: Stack 定義ファイルへのパス</p></li>
</ul>
<ol class="arabic" start="3">
<li>
<p>stack を echo という Stack 名でデプロイする。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_37c1a04e9d4c44ed967a2b99bade1678-1"></a><span class="c1"># stack ディレクトリは manager コンテナの /stack にマウントされている</span>
<a name="rest_code_37c1a04e9d4c44ed967a2b99bade1678-2"></a>$ docker container <span class="nb">exec</span> -it manager docker stack deploy -c /stack/ch03-webapi.yml <span class="nb">echo</span>
<a name="rest_code_37c1a04e9d4c44ed967a2b99bade1678-3"></a>Creating service echo_nginx
<a name="rest_code_37c1a04e9d4c44ed967a2b99bade1678-4"></a>Creating service echo_api
</pre>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id43">デプロイされた Stack を確認する</a></h4>
<pre class="code console"><a name="rest_code_bc0f2c1fa886450880f71b3acfbadfc8-1"></a><span class="gp">$</span> docker stack services <span class="o">[</span>options<span class="o">]</span> Stack名
</pre>
<ol class="arabic" start="4">
<li>
<p>echo スタックの Service 一覧を表示する。</p>
<blockquote>
<pre class="code console"><a name="rest_code_981cc9dab5524fffa4b7bfae0916db36-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker stack services <span class="nb">echo</span>
<a name="rest_code_981cc9dab5524fffa4b7bfae0916db36-2"></a><span class="go">ID                  NAME                MODE                REPLICAS            IMAGE                               PORTS</span>
<a name="rest_code_981cc9dab5524fffa4b7bfae0916db36-3"></a><span class="go">lbomogfj0q65        echo_nginx          replicated          3/3                 gihyodocker/nginx-proxy:latest</span>
<a name="rest_code_981cc9dab5524fffa4b7bfae0916db36-4"></a><span class="go">wh6ddqk6q4zj        echo_api            replicated          3/3                 registry:5000/example/echo:latest</span>
</pre>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id44">Stack でデプロイされたコンテナを確認する</a></h4>
<pre class="code console"><a name="rest_code_2349278cc1c042b1ac1900c322ebf3f7-1"></a><span class="gp">$</span> docker stack ps <span class="o">[</span>options<span class="o">]</span> Stack名
</pre>
<ol class="arabic" start="5">
<li>
<p>echo スタックでデプロイされたコンテナの一覧を表示する。</p>
<blockquote>
<pre class="code console"><a name="rest_code_c4907bd15cd54057b2c69fa1c311faca-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker stack ps <span class="nb">echo</span>
</pre>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="visualizer">
<h4><a class="toc-backref" href="#id45">visualizer で配置されているコンテナを可視化する</a></h4>
<ol class="arabic">
<li>
<p><code class="docutils literal">visualizer.yml</code> を作成する。</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-1"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-2"></a>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-3"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-4"></a>  <span class="nt">app</span><span class="p">:</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-5"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dockersamples/visualizer</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-6"></a>    <span class="nt">ports</span><span class="p">:</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-7"></a>      <span class="p p-Indicator">-</span> <span class="s">"9000:8080"</span>                          <span class="c1"># ポートフォワード (manager &lt;=&gt; visualizer)</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-8"></a>    <span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-9"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-10"></a>    <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-11"></a>      <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">global</span>                           <span class="c1"># 特定のコンテナをクラスタ上の全ノードに配置できる設定</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-12"></a>      <span class="nt">placement</span><span class="p">:</span>
<a name="rest_code_5f3479bae6bd444e9a0d2729694cc272-13"></a>        <span class="nt">constraints</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">node.role == manager</span><span class="p p-Indicator">]</span>  <span class="c1"># manager ノードだけに配置する</span>
</pre>
</blockquote>
</li>
<li>
<p>Stack としてデプロイする。</p>
<blockquote>
<pre class="code console"><a name="rest_code_274777f5c45542e2a4eee57dbb40c065-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker stack deploy -c /stack/visualizer.yml visualizer
<a name="rest_code_274777f5c45542e2a4eee57dbb40c065-2"></a><span class="go">Creating network visualizer_default</span>
<a name="rest_code_274777f5c45542e2a4eee57dbb40c065-3"></a><span class="go">Creating service visualizer_app</span>
</pre>
</blockquote>
</li>
<li>
<p><a class="reference external" href="http://localhost:9000/">http://localhost:9000/</a></p>
<blockquote>
<p></p>
<div class="figure">
<img alt="/images/docker/introduction-to-practice-container-development/3-volumes-etc/visualizer.png" src="../../images/docker/introduction-to-practice-container-development/3-volumes-etc/visualizer.png">
</div>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id46">Stack の削除</a></h4>
<p>デプロイした Stack を Service ごと削除する。</p>
<pre class="code console"><a name="rest_code_809d33dc8d2c4ec1a8c2a052ac895e3c-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker stack rm <span class="nb">echo</span>
<a name="rest_code_809d33dc8d2c4ec1a8c2a052ac895e3c-2"></a><span class="go">Removing service echo_api</span>
<a name="rest_code_809d33dc8d2c4ec1a8c2a052ac895e3c-3"></a><span class="go">Removing service echo_nginx</span>
</pre>
</div>
</div>
<div class="section" id="service-swarm">
<h3><a class="toc-backref" href="#id47">3.5.4 Service を Swarm クラスタ外から利用する</a></h3>
<p>複数のコンテナが複数のノードに分散して配置されている Service にホストからアクセスする。</p>
<ul class="simple">
<li>
<p>Service クラスタ外からのトラフィックを、目的の Service に転送するためのプロキシサーバーを置く</p>
<ul>
<li>
<p><code class="docutils literal">HAProxy</code>:</p>
<ul>
<li><p>プロキシサーバー</p></li>
<li><p>外部から Service へアクセスするための橋渡し (ingress) をする</p></li>
<li><p>Service が配置されているノードへのロードバランシングをする</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="section" id="swarm-echo-nginx-service">
<h4><a class="toc-backref" href="#id48">Swarm クラスタ外から echo_nginx の Service にアクセスする</a></h4>
<ol class="arabic">
<li>
<p><code class="docutils literal"><span class="pre">ch03-ingress.yml</span></code> を作成する。</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-1"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-2"></a>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-3"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-4"></a>  <span class="nt">haproxy</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-5"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dockercloud/haproxy</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-6"></a>    <span class="nt">networks</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-7"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ch03</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-8"></a>    <span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-9"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-10"></a>    <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-11"></a>      <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">global</span>                           <span class="c1"># 特定のコンテナをクラスタ上の全ノードに配置できる設定</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-12"></a>      <span class="nt">placement</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-13"></a>        <span class="nt">constraints</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-14"></a>          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">node.role == manager</span>  <span class="c1"># manager ノードだけに配置する</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-15"></a>    <span class="nt">ports</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-16"></a>      <span class="p p-Indicator">-</span> <span class="s">"80:80"</span>                          <span class="c1"># ポートフォワード</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-17"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1936:1936</span>  <span class="c1"># for stats page (basic auth. stats:stats)</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-18"></a>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-19"></a><span class="nt">networks</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-20"></a>  <span class="nt">ch03</span><span class="p">:</span>
<a name="rest_code_45591a6b0b134b46bf2f445efebf6ec9-21"></a>    <span class="nt">external</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre>
</blockquote>
</li>
<li>
<p><code class="docutils literal"><span class="pre">ch03-webapi.yml</span></code> の、 nginx の環境変数に <code class="docutils literal">SERVICE_PORTS</code> を追加する。</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-1"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-2"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-3"></a>  <span class="nt">nginx</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-4"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gihyodocker/nginx-proxy:latest</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-5"></a>    <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-6"></a>      <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>                  <span class="c1"># レプリカ数</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-7"></a>      <span class="nt">placement</span><span class="p">:</span>                   <span class="c1"># コンテナの配置戦略</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-8"></a>        <span class="nt">constraints</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">node.role != manager</span><span class="p p-Indicator">]</span>  <span class="c1"># manager 以外のノードにコンテナを配置する</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-9"></a>    <span class="nt">environment</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-10"></a>      <span class="nt">SERVICE_PORTS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>            <span class="c1"># HAProxy が Service を見つけ出すため</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-11"></a>      <span class="nt">BACKEND_HOST</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo_api:8080</span>  <span class="c1"># リクエストの転送先</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-12"></a>    <span class="nt">depends_on</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-13"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">api</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-14"></a>    <span class="nt">networks</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-15"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ch03</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-16"></a>  <span class="nt">api</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-17"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">registry:5000/example/echo:latest</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-18"></a>    <span class="nt">deploy</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-19"></a>      <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>                  <span class="c1"># レプリカ数</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-20"></a>      <span class="nt">placement</span><span class="p">:</span>                   <span class="c1"># コンテナの配置戦略</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-21"></a>        <span class="nt">constraints</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">node.role != manager</span><span class="p p-Indicator">]</span>  <span class="c1"># manager 以外のノードにコンテナを配置する</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-22"></a>    <span class="nt">networks</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-23"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ch03</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-24"></a>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-25"></a><span class="nt">networks</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-26"></a>  <span class="nt">ch03</span><span class="p">:</span>
<a name="rest_code_5b692c412eff4e2186fe1002c4b23a10-27"></a>    <span class="nt">external</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre>
</blockquote>
</li>
<li>
<p><code class="docutils literal"><span class="pre">ch03-webapi.yml</span></code> を echo Stack としてデプロイする。</p>
<blockquote>
<pre class="code console"><a name="rest_code_18676db5201940e1984918895ea007da-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker stack deploy -c /stack/ch03-webapi.yml <span class="nb">echo</span>
<a name="rest_code_18676db5201940e1984918895ea007da-2"></a><span class="go">Creating service echo_nginx</span>
<a name="rest_code_18676db5201940e1984918895ea007da-3"></a><span class="go">Creating service echo_api</span>
</pre>
</blockquote>
</li>
<li>
<p><code class="docutils literal"><span class="pre">ch03-ingress.yml</span></code> を ingress Stack としてデプロイする。</p>
<blockquote>
<pre class="code console"><a name="rest_code_77585c49399d422fb5e85a0cfb2c95b8-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker stack deploy -c /stack/ch03-ingress.yml ingress
<a name="rest_code_77585c49399d422fb5e85a0cfb2c95b8-2"></a><span class="go">Creating service ingress_haproxy</span>
</pre>
</blockquote>
</li>
<li>
<p>Service の配置を確認する。</p>
<blockquote>
<pre class="code console"><a name="rest_code_94ac524eafbf4203b1585a1161f446bf-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it manager docker service ls
<a name="rest_code_94ac524eafbf4203b1585a1161f446bf-2"></a><span class="go">ID                  NAME                MODE                REPLICAS            IMAGE                               PORTS</span>
<a name="rest_code_94ac524eafbf4203b1585a1161f446bf-3"></a><span class="go">11wu48dvb9s0        echo_api            replicated          3/3                 registry:5000/example/echo:latest</span>
<a name="rest_code_94ac524eafbf4203b1585a1161f446bf-4"></a><span class="go">pyov2dftee9g        echo_nginx          replicated          3/3                 gihyodocker/nginx-proxy:latest</span>
<a name="rest_code_94ac524eafbf4203b1585a1161f446bf-5"></a><span class="go">nxxu04tsdqql        ingress_haproxy     global              1/1                 dockercloud/haproxy:latest          *:80-&gt;80/tcp, *:1936-&gt;1936/tcp</span>
<a name="rest_code_94ac524eafbf4203b1585a1161f446bf-6"></a><span class="go">sqoaqpzkr2g5        visualizer_app      global              1/1                 dockersamples/visualizer:latest     *:9000-&gt;8080/tcp</span>
</pre>
</blockquote>
</li>
<li>
<p>echo_nginx にアクセスできるようになる。</p>
<blockquote>
<pre class="code console"><a name="rest_code_503eff65d83241ddaa67ca15f6accb37-1"></a><span class="gp">$</span> curl http://localhost:8000/
<a name="rest_code_503eff65d83241ddaa67ca15f6accb37-2"></a><span class="go">Hello Docker!!</span>
</pre>
</blockquote>
</li>
</ol>
</div>
</div>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id49">Docker Swarm まとめ</a></h3>
<ul class="simple">
<li><p>Service はレプリカ数 (コンテナの数) を制御することで容易にコンテナを複製でき、複数のノードに配置できるため、スケールアウトへの親和性が高い</p></li>
<li><p>Service によって管理される複数のレプリカは Service 名で名前解決でき、かつ、 Service へのトラフィックはレプリカへ分散される。</p></li>
<li><p>Swarm クラスタ外から Swarm の Service を利用するには、 Service にトラフィックを分散するためのプロキシを用意する。</p></li>
<li><p>Stack は、複数の Service をグルーピングでき、複数の Service で形成されるアプリケーションのデプロイに役立つ。</p></li>
</ul>
</div>
</div>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>
</html>
