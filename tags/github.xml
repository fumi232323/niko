<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ふみのて (Posts about github)</title><link>https://32imuf.com/</link><description></description><atom:link href="https://32imuf.com/tags/github.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><copyright>Contents © 2021 &lt;a href="mailto:fumi232323fumi2016@gmail.com"&gt;fumi23&lt;/a&gt; </copyright><lastBuildDate>Mon, 20 Sep 2021 14:52:02 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>GitHub Actions で deploy 時に changelog を生成してタグを打ちたい</title><link>https://32imuf.com/github/actions/changelog-tag-deploy/</link><dc:creator>fumi23</dc:creator><description>&lt;div&gt;&lt;details&gt;
  &lt;summary&gt;目次&lt;/summary&gt;&lt;div class="contents topic" id="contents"&gt;
&lt;p class="topic-title first"&gt;Contents&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id1" id="id18"&gt;リファレンス・ガイド&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#github-actions" id="id19"&gt;GitHub Actions&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#actions" id="id20"&gt;ワークフロー中で使った Actions&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#case1-push-tag" id="id21"&gt;Case1: 直接 push する、 tag は手動トリガー時に入力できる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id3" id="id22"&gt;条件&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#workflow" id="id23"&gt;workflow&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#case2-push-tag-protected-branch" id="id24"&gt;Case2: 直接 push する、 tag は手動トリガー時に入力できる (ちょっとだけ protected branch)&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id5" id="id25"&gt;条件&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id6" id="id26"&gt;workflow&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id9" id="id27"&gt;ちなみに&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#case3-protected-branch-pr-tag-auto-bump-changelog-tag" id="id28"&gt;Case3: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがずれる)&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id10" id="id29"&gt;条件&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id13" id="id30"&gt;workflow&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#note" id="id31"&gt;Note&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#case4-protected-branch-pr-tag-auto-bump-changelog-tag" id="id32"&gt;Case4: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがいっしょ!)&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id14" id="id33"&gt;条件&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id15" id="id34"&gt;workflow&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#changelog-next-tag" id="id35"&gt;1. changelog 生成, next tag 払い出し&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#tag-deploy" id="id36"&gt;2. tag 打ちして deploy&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id16" id="id37"&gt;その他&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/details&gt;&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id18"&gt;リファレンス・ガイド&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="github-actions"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id19"&gt;GitHub Actions&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/actions/reference/workflow-syntax-for-github-actions"&gt;GitHub Actionsのワークフロー構文&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="actions"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id20"&gt;ワークフロー中で使った Actions&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;Checkout V2: &lt;a class="reference external" href="https://github.com/actions/checkout"&gt;https://github.com/actions/checkout&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;git-auto-commit Action: &lt;a class="reference external" href="https://github.com/stefanzweifel/git-auto-commit-action"&gt;https://github.com/stefanzweifel/git-auto-commit-action&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GitHub Tag Action: &lt;a class="reference external" href="https://github.com/mathieudutour/github-tag-action"&gt;https://github.com/mathieudutour/github-tag-action&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Create Pull Request: &lt;a class="reference external" href="https://github.com/peter-evans/create-pull-request"&gt;https://github.com/peter-evans/create-pull-request&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Enable Pull Request Auto-merge: &lt;a class="reference external" href="https://github.com/peter-evans/enable-pull-request-automerge"&gt;https://github.com/peter-evans/enable-pull-request-automerge&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;approve-pull-request-action: &lt;a class="reference external" href="https://github.com/juliangruber/approve-pull-request-action"&gt;https://github.com/juliangruber/approve-pull-request-action&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="case1-push-tag"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id21"&gt;Case1: 直接 push する、 tag は手動トリガー時に入力できる&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id3"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id22"&gt;条件&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;private repository&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog push 対象のブランチに、 Branch protection rules の適用なし&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="workflow"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id23"&gt;workflow&lt;/a&gt;&lt;/h3&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;ブランチを選択・タグ名を入力して、 &lt;code class="docutils literal"&gt;Run workflow&lt;/code&gt; (手動トリガー)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を生成&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ワークフローをトリガーしたブランチに、 changelog を commit &amp;amp; push&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog の commit に、入力したタグ名でタグ打ち&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;deploy&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/actions/managing-workflow-runs/manually-running-a-workflow"&gt;ワークフローの手動実行&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-1"&gt;&lt;/a&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy (Case1)&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-2"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-3"&gt;&lt;/a&gt;&lt;span class="nt"&gt;on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-4"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;workflow_dispatch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-5"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# 手動トリガー&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-6"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;inputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-7"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;tag-name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-8"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ここで入力したタグ名でタグを打つ&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-9"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;description&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Enter&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;tag&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;name&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;(e.g.&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;v1.2.3)'&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-10"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;required&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-11"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-12"&gt;&lt;/a&gt;&lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-13"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# 必要な環境変数を定義する&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-14"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# ここで定義した env はすべての job から参照できる&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-15"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;AWS_REGION&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ap-northeast-1&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-16"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# (以下省略)&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-17"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-18"&gt;&lt;/a&gt;&lt;span class="nt"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-19"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-20"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bash&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-21"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-22"&gt;&lt;/a&gt;&lt;span class="nt"&gt;jobs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-23"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-24"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;changelog&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-25"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG and create new tag&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-26"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-27"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;outputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-28"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# job の outputs として tag を打った (changelog を commit した) コミットの hash (SHA) を設定&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-29"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;tagged-sha&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.push-changelog-tag.outputs.commit_hash }}&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-30"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-31"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-32"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-33"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-34"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-35"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Build services&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-36"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-37"&gt;&lt;/a&gt;          &lt;span class="no"&gt;cp example.env .env&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-38"&gt;&lt;/a&gt;          &lt;span class="no"&gt;docker-compose build --parallel&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-39"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-40"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;1&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-41"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-42"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-43"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# root ユーザーで実行する&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-44"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# root で実行しないと、 towncrier が見たい dir の参照権限がなかったりして、fail する&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-45"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose run -u 0 --rm djangoapp towncrier --yes&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-46"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-47"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Stop and remove containers, networks and volumes&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-48"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose down -v&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-49"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;always()&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-50"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-51"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Restore git dir owner and group&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-52"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# CHANGELOG は root:root で作成される&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-53"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# そのままだと git-auto-commit-action に失敗することがあるため元に戻す&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-54"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ※これは正しい解決策なのか否かちょっと自信なし&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-55"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;sudo chown -R runner:docker .git/objects/&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-56"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-57"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Commit, push CHANGELOG and create new tag&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-58"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;push-changelog-tag&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-59"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;stefanzweifel/git-auto-commit-action@v4&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-60"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-61"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;commit_message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Updated CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-62"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 手動トリガーで受け取ったタグ名でタグを打つ&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-63"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 手動トリガー時に受け取った inputs はこんな風に参照できる&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-64"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;tagging_message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.event.inputs.tag-name }}&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-65"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-66"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;deploy&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-67"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-68"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-69"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# changelog job が正常終了したらこの job を実行する (直列で実行する)&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-70"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# needs を指定しないと並列実行される&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-71"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;needs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-72"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;changelog&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-73"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-74"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-75"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-76"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-77"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-78"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# すべての tag も fetch する&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-79"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# これをつけないと (デフォルトだと) 、ワークフローをトリガーした ref/SHA のコミットひとつだけが fetch される&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-80"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;fetch-depth&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;0&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-81"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# changelog job で tag を打った (changelog を commit した) コミットをチェックアウトする&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-82"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# ※ changelog + tag のコミットを deploy したいため&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-83"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# needs に指定した job の outputs はこんな風に参照できる&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-84"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;ref&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ needs.changelog.outputs.tagged_hash }}&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-85"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-86"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Set tagged sha&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-87"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set-tag-sha&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-88"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# [確認用] チェックアウトしたブランチの最新の commit を取得&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-89"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-90"&gt;&lt;/a&gt;          &lt;span class="no"&gt;TAGGED_SHA=$(git log -1 --format='%H')&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-91"&gt;&lt;/a&gt;          &lt;span class="no"&gt;echo $TAGGED_SHA&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-92"&gt;&lt;/a&gt;          &lt;span class="no"&gt;echo "::set-output name=tag-sha::$TAGGED_SHA"&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-93"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-94"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-ref&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-95"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.ref }}"&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-96"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-sha&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-97"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーしたときの SHA&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-98"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.sha }}"&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-99"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo changelog-tagged_hash&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-100"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# changelog job で tag を打った SHA&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-101"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# このワークフロー中で commit したので、 github.sha より一つ進んでいる&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-102"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ needs.changelog.outputs.tagged_hash }}"&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-103"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo tag-sha&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-104"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# チェックアウトしたブランチの最新の commit の SHA&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-105"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# == changelog-tagged_hash&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-106"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ steps.set-tag-sha.outputs.tag-sha }}"&lt;/span&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-107"&gt;&lt;/a&gt;
&lt;a name="rest_code_e85a82f0a3354807991d9fc3323c25d7-108"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# あとは deploy する (省略)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="case2-push-tag-protected-branch"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id24"&gt;Case2: 直接 push する、 tag は手動トリガー時に入力できる (ちょっとだけ protected branch)&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id5"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id25"&gt;条件&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;private repository&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog push 対象のブランチに、 Branch protection rules の適用あり&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Require pull request reviews before merging: OFF&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Require status checks to pass before merging: ON&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Include administrators: OFF&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id26"&gt;workflow&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Case1 と同じ&lt;/p&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_f04af439b1944281be779fc423991391-1"&gt;&lt;/a&gt;&lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f04af439b1944281be779fc423991391-2"&gt;&lt;/a&gt;  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_f04af439b1944281be779fc423991391-3"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_f04af439b1944281be779fc423991391-4"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# ここだけ変える&lt;/span&gt;
&lt;a name="rest_code_f04af439b1944281be779fc423991391-5"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f04af439b1944281be779fc423991391-6"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# 管理者権限を持つユーザーで repo scope の PAT を作成し、&lt;/span&gt;
&lt;a name="rest_code_f04af439b1944281be779fc423991391-7"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# GitHub Actions の secrets に登録しておく&lt;/span&gt;
&lt;a name="rest_code_f04af439b1944281be779fc423991391-8"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.REPO_SCOPED_PAT }}&lt;/span&gt;
&lt;/pre&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token"&gt;個人アクセストークンを使用する&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/actions/reference/encrypted-secrets"&gt;暗号化されたシークレット&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="id9"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id27"&gt;ちなみに&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Branch protection rules のうち、以下のいずれかもしくは両方が &lt;code class="docutils literal"&gt;ON&lt;/code&gt; の場合は NG です。
workflow は fail します (changelog の push に失敗する) 。&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;Require pull request reviews before merging&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;自分のローカルから push するときは、これ ON でも Include administrators が OFF なら push できるんだけれども、
なにか、PAT の権限足すといけるのかもしれない (けれどあまり強権限持たせたくない..)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;それに、管理者だからって、自分の頭で気をつけるんじゃなくて GitHub に助けて (チェックして) もらいたい...&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Include administrators&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="case3-protected-branch-pr-tag-auto-bump-changelog-tag"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id28"&gt;Case3: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがずれる)&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id10"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id29"&gt;条件&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;private repository&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog push 対象のブランチに、 Branch protection rules の適用あり&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Require pull request reviews before merging: ON&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Require status checks to pass before merging: ON (今回の場合は、以下の3つを指定)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ci (自分のところで用意している CI)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;push イベントで起動 (branch は特に絞り込んでいません)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://github.com/marketplace/task-list-completed"&gt;task-list-completed&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://github.com/marketplace/actions/wip"&gt;WIP&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Include administrators: ON&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;リポジトリ内のプルリクエストの自動マージを許可: ON&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/github/administering-a-repository/configuring-pull-request-merges/managing-auto-merge-for-pull-requests-in-your-repository"&gt;リポジトリ内のプルリクエストの自動マージを管理する&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/github/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request"&gt;プルリクエストを自動的にマージする&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id13"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id30"&gt;workflow&lt;/a&gt;&lt;/h3&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;ブランチを選択して、 &lt;code class="docutils literal"&gt;Run workflow&lt;/code&gt; (手動トリガー)&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;タグ version の bump up は自動でやってくれるので、通常の実行時はタグ名を指定しない&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;デフォルトが &lt;code class="docutils literal"&gt;Patch&lt;/code&gt; になっているので、 &lt;code class="docutils literal"&gt;Minor&lt;/code&gt; or &lt;code class="docutils literal"&gt;Major&lt;/code&gt; の version を bump up したいときは、 &lt;code class="docutils literal"&gt;custom_tag&lt;/code&gt; を指定する&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ちょっとまだどんな風に version up していくか見えていないので&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を生成&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ワークフローをトリガーしたコミットにタグ打ち (タグのバージョンは自動 bump up)&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;changelog の PR が merge されるのをワークフロー中で待てないので、&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;あきらめて「ワークフローをトリガーしたコミット」にタグを打つ。&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog のコミットは、「タグを打ったコミット」より後の別のコミットになる。&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を PR&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog の PR の自動マージを有効化&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を PR を自動 approve&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;deploy&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-1"&gt;&lt;/a&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy (Case3)&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-2"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-3"&gt;&lt;/a&gt;&lt;span class="nt"&gt;on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-4"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;workflow_dispatch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-5"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;inputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-6"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;custom_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-7"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;description&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'メジャー/マイナーバージョンをインクリメントしたいときのみ指定してください&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;(e.g.&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;1.2.0)'&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-8"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-9"&gt;&lt;/a&gt;&lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-10"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;AWS_REGION&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ap-northeast-1&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-11"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# (以下省略)&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-12"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-13"&gt;&lt;/a&gt;&lt;span class="nt"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-14"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-15"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bash&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-16"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-17"&gt;&lt;/a&gt;&lt;span class="nt"&gt;jobs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-18"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-19"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;changelog&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-20"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG and create new tag&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-21"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-22"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;outputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-23"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# changelog job の outputs として version を bump したタグ名設定&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-24"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;new_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.create-tag.outputs.new_tag }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-25"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-26"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-27"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-28"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-29"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-30"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Build services&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-31"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-32"&gt;&lt;/a&gt;          &lt;span class="no"&gt;cp example.env .env&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-33"&gt;&lt;/a&gt;          &lt;span class="no"&gt;docker-compose build --parallel&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-34"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-35"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;1&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-36"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-37"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-38"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose run -u 0 --rm djangoapp towncrier --yes&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-39"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-40"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Stop and remove containers, networks and volumes&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-41"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose down -v&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-42"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;always()&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-43"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-44"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Bump version and push tag&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-45"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# changelog の PR が merge されるのをワークフロー中で待てないので、&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-46"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# あきらめて「ワークフローをトリガーしたコミット」にタグを打つ。&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-47"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# changelog のコミットは、「タグを打ったコミット」より後の別のコミットになる。&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-48"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;create-tag&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-49"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;mathieudutour/github-tag-action@v5.6&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-50"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# main 以外のブランチで実行した場合は `v1.2.3-{branch_name}.0` のようなタグがつくため、&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-51"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# main ブランチの bump には影響しない。&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-52"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ※ custom_tag に、 main ブランチのタグと同じ形式のタグ名を指定すると影響する&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-53"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-54"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# secrets.GITHUB_TOKEN は github.token と同義だそうです&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-55"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;github_token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-56"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 手動トリガー時に custom_tag を受け取った場合は、&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-57"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 受け取ったタグ名でタグを打つ&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-58"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;custom_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.event.inputs.custom_tag }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-59"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-60"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Create Pull Request&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-61"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;cpr&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-62"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;peter-evans/create-pull-request@v3&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-63"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-64"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;TAG_MAME&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.create-tag.outputs.new_tag }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-65"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-66"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.PR_CHANGELOG_PAT }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-67"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;branch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'deploy/${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-68"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;commit-message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Updated&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;CHANGELOG&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-69"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;title&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Update&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;CHANGELOG&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-70"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# どのコミットにタグを打ったかわからなくならないようにメモ↓&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-71"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;body&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Commit&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;SHA:&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;github.sha&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-72"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-73"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Enable Pull Request Automerge&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-74"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;steps.cpr.outputs.pull-request-operation == 'created'&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-75"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;peter-evans/enable-pull-request-automerge@v1&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-76"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-77"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# repo scope の PAT を作成し、&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-78"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# GitHub Actions の secrets に登録しておく&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-79"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.PR_CHANGELOG_PAT }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-80"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;pull-request-number&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.cpr.outputs.pull-request-number }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-81"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;merge-method&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;squash&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-82"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-83"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Auto approve Pull Request&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-84"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;steps.cpr.outputs.pull-request-operation == 'created'&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-85"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;juliangruber/approve-pull-request-action@v1&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-86"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-87"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;github-token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-88"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;number&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.cpr.outputs.pull-request-number }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-89"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-90"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;deploy&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-91"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-92"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-93"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;needs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-94"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;changelog&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-95"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-96"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-97"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-98"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-99"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-100"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# changelog job で タグを打ったコミットをチェックアウトする&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-101"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# とはいえ、「ワークフローをトリガーしたコミット == タグを打ったコミット」なので、&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-102"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 正直付けなくて良い&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-103"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;fetch-depth&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;0&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-104"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;ref&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ needs.changelog.outputs.new_tag }}&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-105"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-106"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Set tagged sha&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-107"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set-tag-sha&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-108"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# [確認用] チェックアウトしたブランチの最新の commit を取得&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-109"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-110"&gt;&lt;/a&gt;          &lt;span class="no"&gt;TAGGED_SHA=$(git log -1 --format='%H')&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-111"&gt;&lt;/a&gt;          &lt;span class="no"&gt;echo $TAGGED_SHA&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-112"&gt;&lt;/a&gt;          &lt;span class="no"&gt;echo "::set-output name=tag-sha::$TAGGED_SHA"&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-113"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-114"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-ref&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-115"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.ref }}"&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-116"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-sha&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-117"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーしたときの SHA&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-118"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.sha }}"&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-119"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo tag-sha&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-120"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# チェックアウトしたブランチの最新の commit の SHA&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-121"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# == changelog job で tag を打った SHA&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-122"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# == github-sha&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-123"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ steps.set-tag-sha.outputs.tag-sha }}"&lt;/span&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-124"&gt;&lt;/a&gt;
&lt;a name="rest_code_a00abb0247aa45ba8f525b2c53ab0537-125"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# あとは deploy する (省略)&lt;/span&gt;
&lt;/pre&gt;&lt;div class="section" id="note"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id31"&gt;Note&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Create Pull Request, Enable Pull Request Automerge, Auto approve Pull Request の &lt;code class="docutils literal"&gt;token&lt;/code&gt;, &lt;code class="docutils literal"&gt;&lt;span class="pre"&gt;github-token&lt;/span&gt;&lt;/code&gt; は、
以下のとおり指定しないとうまくいかない (&lt;cite&gt;Can not approve your own pull request&lt;/cite&gt; になっちゃう)&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;Create Pull Request: &lt;code class="docutils literal"&gt;secrets.PR_CHANGELOG_PAT&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Enable Pull Request Automerge: &lt;code class="docutils literal"&gt;secrets.PR_CHANGELOG_PAT&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Auto approve Pull Request: &lt;code class="docutils literal"&gt;secrets.GITHUB_TOKEN&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;※ &lt;a class="reference external" href="https://github.com/peter-evans/enable-pull-request-automerge#example"&gt;https://github.com/peter-evans/enable-pull-request-automerge#example&lt;/a&gt; に書いてある順番&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;例えば、1 は &lt;code class="docutils literal"&gt;secrets.GITHUB_TOKEN&lt;/code&gt; も指定可能ですが、そうすると、&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;PR つくるひと -&amp;gt; 2. PR の自動マージ有効化するひと -&amp;gt; 3. PR を approve するひと =&amp;gt; 1 と 3 がいっしょになっちゃう!!&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="case4-protected-branch-pr-tag-auto-bump-changelog-tag"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id32"&gt;Case4: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがいっしょ!)&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id14"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id33"&gt;条件&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Case3 と同じ&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id15"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id34"&gt;workflow&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;workflow は二本用意します&lt;/p&gt;
&lt;div class="section" id="changelog-next-tag"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id35"&gt;1. changelog 生成, next tag 払い出し&lt;/a&gt;&lt;/h4&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;ブランチを選択して、 &lt;code class="docutils literal"&gt;Run workflow&lt;/code&gt; (手動トリガー)&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;タグ version の bump up は自動でやってくれるので、通常の実行時はタグ名を指定しない&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;デフォルトが &lt;code class="docutils literal"&gt;Patch&lt;/code&gt; になっているので、 &lt;code class="docutils literal"&gt;Minor&lt;/code&gt; or &lt;code class="docutils literal"&gt;Major&lt;/code&gt; の version を bump up したいときは、 &lt;code class="docutils literal"&gt;custom_tag&lt;/code&gt; を指定する&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;デフォルトは変えられます&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を生成&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;bump up したタグ名 (&lt;code class="docutils literal"&gt;next tag&lt;/code&gt;) 払い出し&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;タグ打ちはまだしない (&lt;code class="docutils literal"&gt;dry_run: true&lt;/code&gt;)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を PR&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;code class="docutils literal"&gt;deploy&lt;/code&gt; ラベルをつける&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;body に 3 で払い出した &lt;code class="docutils literal"&gt;next tag&lt;/code&gt; を書いておく&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog の PR の自動マージを有効化&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を PR を自動 approve =&amp;gt; Automerge される&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# Branch protection rules が適用されているブランチであれば、&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-2"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# main 以外のブランチでも実行できます&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-3"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-4"&gt;&lt;/a&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy dev (Case4-1. changelog)&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-5"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-6"&gt;&lt;/a&gt;&lt;span class="nt"&gt;on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-7"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;workflow_dispatch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-8"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;inputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-9"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;custom_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-10"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;description&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'メジャー/マイナーバージョンをインクリメントしたいときのみ指定してください&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;(e.g.&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;1.2.0)'&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-11"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-12"&gt;&lt;/a&gt;&lt;span class="nt"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-13"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-14"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bash&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-15"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-16"&gt;&lt;/a&gt;&lt;span class="nt"&gt;jobs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-17"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-18"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;changelog&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-19"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-20"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-21"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-22"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-23"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-24"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-25"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-26"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Build services&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-27"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-28"&gt;&lt;/a&gt;          &lt;span class="no"&gt;cp example.env .env&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-29"&gt;&lt;/a&gt;          &lt;span class="no"&gt;docker-compose build --parallel&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-30"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-31"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;1&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-32"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-33"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-34"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose run -u 0 --rm djangoapp towncrier --yes&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-35"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-36"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Stop and remove containers, networks and volumes&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-37"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose down -v&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-38"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;always()&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-39"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-40"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Bump tag version&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-41"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# bump up したタグ名を払い出す&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-42"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# main 以外のブランチで実行した場合は `v1.2.3-{branch_name}.0` のようなタグがつくため、&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-43"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;#  main ブランチの bump には影響しない。&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-44"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;#  ※ custom_tag に、 main ブランチのタグと同じ形式のタグ名を指定すると影響します&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-45"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bump-tag&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-46"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;mathieudutour/github-tag-action@v5.6&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-47"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-48"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;github_token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-49"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;custom_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.event.inputs.custom_tag }}&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-50"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# タグ打ちはまだしない&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-51"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;dry_run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-52"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-53"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Create Pull Request&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-54"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;cpr&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-55"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;peter-evans/create-pull-request@v3&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-56"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-57"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;TAG_MAME&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.bump-tag.outputs.new_tag }}&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-58"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-59"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# repo scope の PAT を作成し、&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-60"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# GitHub Actions の secrets に登録しておく&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-61"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.PR_CHANGELOG_PAT }}&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-62"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;branch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'deploy/${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-63"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;commit-message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Updated&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;CHANGELOG&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-64"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;title&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Update&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;CHANGELOG&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-65"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# `deploy` label を付けておく&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-66"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;labels&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;deploy, automerge&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-67"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# deploy workflow でタグ打ちするので、 next tag を body に書いておく&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-68"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;body&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ env.TAG_MAME }}&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-69"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-70"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Enable Pull Request Automerge&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-71"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;steps.cpr.outputs.pull-request-operation == 'created'&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-72"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;peter-evans/enable-pull-request-automerge@v1&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-73"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-74"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.PR_CHANGELOG_PAT }}&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-75"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;pull-request-number&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.cpr.outputs.pull-request-number }}&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-76"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;merge-method&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;squash&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-77"&gt;&lt;/a&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-78"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Auto approve Pull Request&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-79"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;steps.cpr.outputs.pull-request-operation == 'created'&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-80"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;juliangruber/approve-pull-request-action@v1&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-81"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-82"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;github-token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;a name="rest_code_663abab788cd45598df3db00ed7e57a0-83"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;number&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.cpr.outputs.pull-request-number }}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="tag-deploy"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id36"&gt;2. tag 打ちして deploy&lt;/a&gt;&lt;/h4&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;PR の close イベントで起動&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;以下の条件に合致する場合に deploy job を実行する&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;ワークフローをトリガーした PR が merge 済み、かつ、&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ワークフローをトリガーした PR の labels に &lt;code class="docutils literal"&gt;deploy&lt;/code&gt; が含まれる&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog のコミットにタグ打ち&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;タグ名には、 PR の body から取得した next tag を使用する&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;deploy&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-1"&gt;&lt;/a&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy dev (Case4-2. deploy)&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-2"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-3"&gt;&lt;/a&gt;&lt;span class="nt"&gt;on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-4"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;pull_request&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-5"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;types&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;closed&lt;/span&gt;&lt;span class="p p-Indicator"&gt;]&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-6"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-7"&gt;&lt;/a&gt;&lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-8"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;AWS_REGION&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ap-northeast-1&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-9"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# (以下省略)&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-10"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-11"&gt;&lt;/a&gt;&lt;span class="nt"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-12"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-13"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bash&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-14"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-15"&gt;&lt;/a&gt;&lt;span class="nt"&gt;jobs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-16"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-17"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;deploy&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-18"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Tag and Deploy&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-19"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-20"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# PR が merge 済み、かつ、`deploy` label 付きの場合だけ実行&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-21"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# ほかのトピックブランチが merge -&amp;gt; close されたときには、 Skip されるよ&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-22"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;github.event.pull_request.merged == true &amp;amp;&amp;amp; contains(github.event.pull_request.labels.*.name, 'deploy')&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-23"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-24"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-25"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-26"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-27"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーした PR の マージブランチの直近のマージコミット&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-28"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# がチェックアウトされる&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-29"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-30"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-ref&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-31"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーした PR のマージブランチ&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-32"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# 例えば、PR のブランチが main から生えていたら、 `main` 、&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-33"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;#  ブランチA から生えていたら `branchA`&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-34"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.ref }}"&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-35"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-sha&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-36"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーした PR の マージブランチの直近のマージコミット&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-37"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# == changelog の commit&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-38"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# (タイミングによっては違っちゃうこともあるかもしれない、頻度は低いが可能性としてはありえそう)&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-39"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.sha }}"&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-40"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-head-sha&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-41"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# PR のブランチで changelog を commit したときの commit&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-42"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.event.pull_request.head.sha }}"&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-43"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-44"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Push tag&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-45"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-46"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# ワークフローをトリガーした PR の body から取得した next tag&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-47"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;TAG_MAME&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.event.pull_request.body }}&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-48"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;COMMIT&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.sha }}&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-49"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-50"&gt;&lt;/a&gt;          &lt;span class="no"&gt;git tag $TAG_MAME $COMMIT&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-51"&gt;&lt;/a&gt;          &lt;span class="no"&gt;git push origin $TAG_MAME&lt;/span&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-52"&gt;&lt;/a&gt;
&lt;a name="rest_code_8f3da937902f458db97ccecf9df34267-53"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# あとは deploy する (省略)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id16"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id37"&gt;その他&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;GitHub Actions はスケジュール実行もできる。
&lt;code class="docutils literal"&gt;next tag&lt;/code&gt; がデフォルトの挙動通りで良いシーンでは、夜間に定期 deploy などしても。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/actions/reference/events-that-trigger-workflows#scheduled-events"&gt;スケジュールしたイベント&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;</description><category>github</category><guid>https://32imuf.com/github/actions/changelog-tag-deploy/</guid><pubDate>Sun, 19 Sep 2021 15:00:00 GMT</pubDate></item><item><title>GitHub に新しいリポジトリを作成して、pushする</title><link>https://32imuf.com/github/how-to-create-new-repository/</link><dc:creator>fumi23</dc:creator><description>&lt;div class="section" id="github-push"&gt;
&lt;h2&gt;GitHub に新しいリポジトリを作成して、pushする&lt;/h2&gt;
&lt;ol class="arabic"&gt;
&lt;li&gt;&lt;p&gt;GitHub の右上の &lt;code class="docutils literal"&gt;+&lt;/code&gt; ボタンから、 &lt;code class="docutils literal"&gt;New repository&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;リポジトリ名を入力して、作成&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;こうするといいよ、というページが表示されるので、それに従う&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre class="code console"&gt;&lt;a name="rest_code_7a0f477ce0c242c7a732c8ba99ad539c-1"&gt;&lt;/a&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git remote add origin git@github.com:fumi232323/miya.git
&lt;a name="rest_code_7a0f477ce0c242c7a732c8ba99ad539c-2"&gt;&lt;/a&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git push -u origin master
&lt;/pre&gt;&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><category>github</category><guid>https://32imuf.com/github/how-to-create-new-repository/</guid><pubDate>Sun, 09 Sep 2018 15:00:00 GMT</pubDate></item><item><title>GitHub Pages にカスタムドメインを設定する</title><link>https://32imuf.com/github/github-pages-custom-domain-setting/</link><dc:creator>fumi23</dc:creator><description>&lt;div&gt;&lt;div class="section" id="id1"&gt;
&lt;h2&gt;手順&lt;/h2&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;ドメインを購入する&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://help.github.com/articles/setting-up-an-apex-domain/#configuring-a-records-with-your-dns-provider"&gt;Configuring A records with your DNS provider&lt;/a&gt; をする&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://help.github.com/articles/adding-or-removing-a-custom-domain-for-your-github-pages-site/"&gt;Adding or removing a custom domain for your GitHub Pages site&lt;/a&gt; をする&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;カスタムドメインの良いところ&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;どこに行ってもURL が変わらないので、なくならない&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;&lt;/div&gt;</description><category>github</category><guid>https://32imuf.com/github/github-pages-custom-domain-setting/</guid><pubDate>Sat, 30 Jun 2018 15:00:00 GMT</pubDate></item></channel></rss>