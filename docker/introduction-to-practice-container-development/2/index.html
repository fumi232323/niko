<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Docker/Kubernetes 実践コンテナ開発入門 --- 2. Docker コンテナのデプロイ/ふみのて</title>
<link rel="shortcut icon" href="../../../assets/icons/favicon.ico">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Griffy">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link rel="stylesheet" href="../../../assets/css/style.css?20190611">
</head>
<body>
    <div class="container">
      <div class="header"><header class="item item-header"><h1>
    <a href="../../../">
      <img class="logo" src="../../../assets/images/inuu.png" alt="犬"></a>
  </h1>
  <nav class="nav"><ul>
<li class="nav-category"><a href="../../../">HOME</a></li>
    </ul></nav><iframe src="../../../tags/" class="tags-frame"></iframe>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-docker"><time class="date" datetime="2018-11-04 00:00:00+09:00">
      2018-11-04 Sun
    </time><div class="title">Docker/Kubernetes 実践コンテナ開発入門 --- 2. Docker コンテナのデプロイ</div>
    <div class="category">
      <a href="../../../tags/docker/">
          docker
      </a>
    </div>
    <div class="text">
      <div>
<details><summary>目次</summary><div class="contents topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li>
<a class="reference internal" href="#id2" id="id26">2.1 コンテナでアプリケーションを実行する</a><ul>
<li>
<a class="reference internal" href="#docker-docker" id="id27">2.1.1 Docker イメージと Docker コンテナの基本</a><ul>
<li><a class="reference internal" href="#id3" id="id28">基本の流れ</a></li>
</ul>
</li>
<li>
<a class="reference internal" href="#docker" id="id29">2.1.2 簡単なアプリケーションと Docker イメージをつくる</a><ul>
<li><a class="reference internal" href="#id4" id="id30">用意するもの</a></li>
<li><a class="reference internal" href="#dockerfile" id="id31">Dockerfileの説明</a></li>
<li><a class="reference internal" href="#id5" id="id32">Docker イメージをビルドする</a></li>
</ul>
</li>
<li>
<a class="reference internal" href="#id6" id="id33">2.1.3 Docker コンテナを実行する</a><ul>
<li><a class="reference internal" href="#id7" id="id34">ポートフォワーディング</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a class="reference internal" href="#id8" id="id35">2.2 Docker イメージの操作</a><ul>
<li><a class="reference internal" href="#docker-image-build" id="id36">2.2.1 docker image build --- イメージのビルド</a></li>
<li>
<a class="reference internal" href="#docker-search" id="id37">2.2.2 docker search --- イメージの検索</a><ul>
<li><a class="reference internal" href="#docker-hub" id="id38">Docker Hub</a></li>
<li><a class="reference internal" href="#id9" id="id39">検索する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#docker-image-pull" id="id40">2.2.3 docker image pull --- イメージの取得</a></li>
<li><a class="reference internal" href="#docker-image-ls" id="id41">2.2.4 docker image ls --- イメージの一覧</a></li>
<li>
<a class="reference internal" href="#docker-image-tag" id="id42">2.2.5 docker image tag --- イメージのタグ付け</a><ul>
<li><a class="reference internal" href="#id10" id="id43">Docker イメージのバージョン</a></li>
<li><a class="reference internal" href="#id" id="id44">イメージIDへのタグ付け</a></li>
</ul>
</li>
<li>
<a class="reference internal" href="#docker-image-push" id="id45">2.2.6 docker image push --- イメージの公開</a><ul>
<li><a class="reference internal" href="#docker-hub-push" id="id46">Docker Hub にイメージを push する</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a class="reference internal" href="#id11" id="id47">2.3 Docker コンテナの操作</a><ul>
<li><a class="reference internal" href="#id12" id="id48">2.3.1 Docker コンテナのライフサイクル</a></li>
<li>
<a class="reference internal" href="#docker-container-run" id="id49">2.3.2 docker container run --- コンテナの作成と実行</a><ul>
<li><a class="reference internal" href="#id13" id="id50">docker container run 時に引数を与える</a></li>
<li><a class="reference internal" href="#id14" id="id51">名前付きコンテナ</a></li>
<li><a class="reference internal" href="#id15" id="id52">コマンド実行時の頻出オプション</a></li>
</ul>
</li>
<li>
<a class="reference internal" href="#docker-container-ls" id="id53">2.3.3 docker container ls --- コンテナの一覧</a><ul>
<li><a class="reference internal" href="#id16" id="id54">コンテナIDだけを抽出する</a></li>
<li><a class="reference internal" href="#filter" id="id55">filter を使う</a></li>
<li><a class="reference internal" href="#id17" id="id56">終了したコンテナを取得する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#docker-container-stop" id="id57">2.3.4 docker container stop --- コンテナの停止</a></li>
<li><a class="reference internal" href="#docker-container-restart" id="id58">2.3.5 docker container restart --- コンテナの再起動</a></li>
<li>
<a class="reference internal" href="#docker-container-rm" id="id59">2.3.6 docker container rm --- コンテナの破棄</a><ul>
<li><a class="reference internal" href="#id18" id="id60">停止の際にコンテナを破棄する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#docker-container-logs" id="id61">2.3.7 docker container logs --- 標準出力の取得</a></li>
<li><a class="reference internal" href="#docker-container-exec" id="id62">2.3.8 docker container exec --- 実行中コンテナでのコマンド実行</a></li>
<li><a class="reference internal" href="#docker-container-cp" id="id63">2.3.9 docker container cp --- ファイルのコピー</a></li>
</ul>
</li>
<li>
<a class="reference internal" href="#id19" id="id64">2.4 運用管理向けコマンド</a><ul>
<li>
<a class="reference internal" href="#prune" id="id65">2.4.1 prune --- 破棄</a><ul>
<li><a class="reference internal" href="#id20" id="id66">Docker イメージを一括削除する</a></li>
<li><a class="reference internal" href="#id21" id="id67">Docker リソースを一括削除する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#docker-container-stats" id="id68">2.4.2 docker container stats --- 利用状況の取得</a></li>
</ul>
</li>
<li>
<a class="reference internal" href="#docker-compose" id="id69">2.5 Docker Compose でマルチコンテナを実行する</a><ul>
<li>
<a class="reference internal" href="#id22" id="id70">2.5.1 docker-compose によるコンテナの実行</a><ul>
<li><a class="reference internal" href="#id23" id="id71">使えるかどうか確認する</a></li>
<li><a class="reference internal" href="#id24" id="id72">docker-compose でコンテナを実行する</a></li>
<li><a class="reference internal" href="#docker-compose-docker" id="id73">docker-compose で Docker イメージをビルドして、そのまま実行する</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a class="reference internal" href="#compose" id="id74">2.6 Compose による複数コンテナの実行</a><ul>
<li><a class="reference internal" href="#jenkins" id="id75">2.6.1 Jenkins コンテナを実行する</a></li>
<li><a class="reference internal" href="#master-jenkins-ssh" id="id76">2.6.2 Master Jenkins の SSH 鍵を作る</a></li>
<li>
<a class="reference internal" href="#jenkins-slave" id="id77">2.6.3 Jenkins Slave コンテナを作る</a><ul>
<li><a class="reference internal" href="#id25" id="id78">参考サイト</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</details><div class="section" id="id2">
<h2><a class="toc-backref" href="#id26">2.1 コンテナでアプリケーションを実行する</a></h2>
<table border="1" class="colwidths-auto docutils">
<caption>Docker イメージと Docker コンテナの関係性</caption>
<thead valign="bottom"><tr>
<th class="head">名称</th>
<th class="head">役割</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>Docker イメージ</td>
<td><ul class="first last simple">
<li>Docker コンテナを構成するファイルシステムや、実行するアプリケーションや設定をまとめたもの</li>
<li>コンテナを作成するために利用されるテンプレートとなるもの</li>
</ul></td>
</tr>
<tr>
<td>Docker コンテナ</td>
<td><ul class="first last simple">
<li>Docker イメージを基に作成され、具現化されたファイルシステムとアプリケーションが実行されている状態</li>
<li>ひとつの Docker イメージから複数のコンテナを生成できる</li>
</ul></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>まずは、イメージから作成する</li>
</ul>
<div class="section" id="docker-docker">
<h3><a class="toc-backref" href="#id27">2.1.1 Docker イメージと Docker コンテナの基本</a></h3>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id28">基本の流れ</a></h4>
<ol class="arabic">
<li>
<p class="first">Docker イメージをダウンロード</p>
<blockquote>
<pre class="code console"><a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-1"></a><span class="gp">FumienoMacBook-Pro:docker-work fumi23$</span> docker image pull gihyodocker/echo:latest
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-2"></a><span class="go">latest: Pulling from gihyodocker/echo</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-3"></a><span class="go">723254a2c089: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-4"></a><span class="go">abe15a44e12f: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-5"></a><span class="go">409a28e3cc3d: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-6"></a><span class="go">503166935590: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-7"></a><span class="go">abe52c89597f: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-8"></a><span class="go">ce145c5cf4da: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-9"></a><span class="go">96e333289084: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-10"></a><span class="go">39cd5f38ffb8: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-11"></a><span class="go">22860d04f4f1: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-12"></a><span class="go">7528760e0a03: Pull complete</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-13"></a><span class="go">Digest: sha256:4520b6a66d2659dea2f8be5245eafd5434c954485c6c1ac882c56927fe4cec84</span>
<a name="rest_code_5fe1b236c5d3483099b79fe4aca841e0-14"></a><span class="go">Status: Downloaded newer image for gihyodocker/echo:latest</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">Docker イメージを実行</p>
<blockquote>
<pre class="code console"><a name="rest_code_a58e5299bd4d4e388b10d2a8b0fbdb4a-1"></a><span class="gp">FumienoMacBook-Pro:docker-work fumi23$</span> docker container run -t -p <span class="m">9000</span>:8080 gihyodocker/echo:latest
<a name="rest_code_a58e5299bd4d4e388b10d2a8b0fbdb4a-2"></a><span class="go">2018/10/01 13:53:03 start server</span>
</pre>
<ul class="simple">
<li>ポートフォワーディング設定をしている<ul>
<li>Docker 実行環境の 9000 ポート経由で HTTP リクエストを受けられるようになっている</li>
</ul>
</li>
</ul>
</blockquote>
</li>
<li>
<p class="first">別のターミナルからアクセスしてみる</p>
<blockquote>
<pre class="code console"><a name="rest_code_7e91984cd8144c4d8cfd8b61fe95cb8b-1"></a><span class="gp">FumienoMacBook-Pro:~ fumi23$</span> curl http://localhost:9000
<a name="rest_code_7e91984cd8144c4d8cfd8b61fe95cb8b-2"></a><span class="go">Hello Docker!!</span>
</pre>
<pre class="code console"><a name="rest_code_d9cef05796c64c9dbba10ca9f2bab0dd-1"></a><span class="gp">FumienoMacBook-Pro:docker-work fumi23$</span> docker container run -t -p <span class="m">9000</span>:8080 gihyodocker/echo:latest
<a name="rest_code_d9cef05796c64c9dbba10ca9f2bab0dd-2"></a><span class="go">2018/10/01 13:53:03 start server</span>
<a name="rest_code_d9cef05796c64c9dbba10ca9f2bab0dd-3"></a><span class="go">2018/10/01 13:56:44 received request</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">停止する</p>
<blockquote>
<pre class="code console"><a name="rest_code_aca19af663af4ba5948a9e377f6ad286-1"></a><span class="gp">$</span> docker stop <span class="k">$(</span>docker container ls -q<span class="k">)</span>
</pre>
</blockquote>
</li>
</ol>
</div>
</div>
<div class="section" id="docker">
<h3><a class="toc-backref" href="#id29">2.1.2 簡単なアプリケーションと Docker イメージをつくる</a></h3>
<p>Docker コンテナがどのように作られ、実行されているかのイメージをつかむ。
Go 言語で簡単な Web サーバーを書き、 Docker コンテナ嬢で動作させてみましょう。</p>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id30">用意するもの</a></h4>
<ul>
<li>
<p class="first">main.go</p>
<pre class="code go"><a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-1"></a><span class="kn">package</span> <span class="nx">main</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-2"></a>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-3"></a><span class="kn">import</span> <span class="p">(</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-4"></a>    <span class="s">"fmt"</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-5"></a>    <span class="s">"log"</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-6"></a>    <span class="s">"net/http"</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-7"></a><span class="p">)</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-8"></a>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-9"></a><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-10"></a>    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-11"></a>        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"received request"</span><span class="p">)</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-12"></a>        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">"Hello Docker!!"</span><span class="p">)</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-13"></a>    <span class="p">})</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-14"></a>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-15"></a>    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"start server"</span><span class="p">)</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-16"></a>    <span class="nx">server</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Addr</span><span class="p">:</span> <span class="s">":8080"</span><span class="p">}</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-17"></a>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-18"></a>        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-19"></a>    <span class="p">}</span>
<a name="rest_code_9fc4ac4cc62a4bb18049e2fadcdd845f-20"></a><span class="p">}</span>
</pre>
</li>
<li>
<p class="first">Dockerfile</p>
<pre class="code docker"><a name="rest_code_72de448018434ab8ba5779903f9ceb7b-1"></a><span class="k">FROM</span><span class="s"> golang:1.9</span>
<a name="rest_code_72de448018434ab8ba5779903f9ceb7b-2"></a>
<a name="rest_code_72de448018434ab8ba5779903f9ceb7b-3"></a><span class="k">RUN</span> mkdir /echo
<a name="rest_code_72de448018434ab8ba5779903f9ceb7b-4"></a><span class="k">COPY</span> main.go /echo
<a name="rest_code_72de448018434ab8ba5779903f9ceb7b-5"></a>
<a name="rest_code_72de448018434ab8ba5779903f9ceb7b-6"></a><span class="k">CMD</span> <span class="p">[</span><span class="s2">"go"</span><span class="p">,</span> <span class="s2">"run"</span><span class="p">,</span> <span class="s2">"/echo/main.go"</span><span class="p">]</span>
</pre>
</li>
</ul>
</div>
<div class="section" id="dockerfile">
<h4><a class="toc-backref" href="#id31">Dockerfileの説明</a></h4>
<ul>
<li>
<p class="first">Dockerfile には、 Docker 独自の DSL (ドメイン固有言語) を使ってイメージの構成を定義する。</p>
</li>
<li>
<p class="first"><tt class="docutils literal">FROM</tt> や <tt class="docutils literal">RUN</tt> といったキーワードは「インストラクション (命令) 」と呼ばれている。</p>
<table border="1" class="colwidths-auto docutils">
<caption>Dockerfile のインストラクション</caption>
<thead valign="bottom"><tr>
<th class="head">インストラクション名</th>
<th class="head">説明</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>FROM</td>
<td><ul class="first last simple">
<li>作成する Docker イメージのベースとなるイメージを指定する。</li>
<li>Dockerfile でイメージをビルドする際、まず最初に <tt class="docutils literal">FROM</tt> で指定されたイメージをダウンロードしてから実行される。</li>
<li>Docker は、デフォルトで <tt class="docutils literal">FROM</tt> の取得先として <tt class="docutils literal">Docker Hub</tt> のレジストリを参照する。</li>
</ul></td>
</tr>
<tr>
<td>RUN</td>
<td><ul class="first last simple">
<li>Docker イメージビルド時に、 Docker コンテナで実行するコマンドを定義します。</li>
<li>
<tt class="docutils literal">RUN</tt> の引数には Docker コンテナ内で実行するコマンドをそのまま指定する。</li>
</ul></td>
</tr>
<tr>
<td>COPY</td>
<td>Docker を動作させているホストマシン上のファイルやディレクトリを Docker コンテナ内にコピーするためのインストラクション。</td>
</tr>
<tr>
<td>CMD</td>
<td><ul class="first last simple">
<li>Docker コンテナとして実行する際に、コンテナ内で実行するプロセスを指定する。</li>
<li>
<tt class="docutils literal">CMD</tt> はコンテナ起動時に１度実行される。</li>
<li>
<tt class="docutils literal">CMD</tt> で指定した命令は、 docker container run の指定で実行時に上書きできる。</li>
</ul></td>
</tr>
<tr>
<td>LABEL</td>
<td>イメージの作者名記入などに使う。</td>
</tr>
<tr>
<td>ENV</td>
<td>Dockerfile をもとに生成した Docker コンテナ内で使える環境変数を指定する。</td>
</tr>
<tr>
<td>ARG</td>
<td>ビルド時に情報を埋め込むために使う。イメージビルドのときだけ使用できる一時的な環境変数。</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id32">Docker イメージをビルドする</a></h4>
<p>Docker イメージを作成するためのコマンド</p>
<pre class="code console"><a name="rest_code_25a5385d4c684d63a5e3524007d8945b-1"></a><span class="gp">$</span> docker image build -t 名前空間/イメージ名<span class="o">[</span>:タグ名<span class="o">]</span> Dockerfile配置ディレクトリのパス
</pre>
<p>実行すると、</p>
<pre class="code console"><a name="rest_code_2d06b26b80184f43ac5379420147b7b3-1"></a><span class="gp">$</span> docker image build -t example/echo:latest .
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-2"></a><span class="go">Sending build context to Docker daemon  3.072kB</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-3"></a><span class="go">Step 1/4 : FROM golang:1.9</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-4"></a><span class="go">1.9: Pulling from library/golang</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-5"></a><span class="go">55cbf04beb70: Pull complete</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-6"></a><span class="go">1607093a898c: Pull complete</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-7"></a><span class="go">9a8ea045c926: Pull complete</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-8"></a><span class="go">d4eee24d4dac: Pull complete</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-9"></a><span class="go">9c35c9787a2f: Pull complete</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-10"></a><span class="go">8b376bbb244f: Pull complete</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-11"></a><span class="go">0d4eafcc732a: Pull complete</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-12"></a><span class="go">186b06a99029: Pull complete</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-13"></a><span class="go">Digest: sha256:8b5968585131604a92af02f5690713efadf029cc8dad53f79280b87a80eb1354</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-14"></a><span class="go">Status: Downloaded newer image for golang:1.9</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-15"></a><span class="go"> ---&gt; ef89ef5c42a9</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-16"></a><span class="go">Step 2/4 : RUN mkdir /echo</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-17"></a><span class="go"> ---&gt; Running in 4da08e7c5693</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-18"></a><span class="go">Removing intermediate container 4da08e7c5693</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-19"></a><span class="go"> ---&gt; 7caf124fb4d3</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-20"></a><span class="go">Step 3/4 : COPY main.go /echo</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-21"></a><span class="go"> ---&gt; 73db87b05d43</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-22"></a><span class="go">Step 4/4 : CMD ["go", "run", "/echo/main.go"]</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-23"></a><span class="go"> ---&gt; Running in 3db24ec2a7c7</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-24"></a><span class="go">Removing intermediate container 3db24ec2a7c7</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-25"></a><span class="go"> ---&gt; 294c33d2b845</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-26"></a><span class="go">Successfully built 294c33d2b845</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-27"></a><span class="go">Successfully tagged example/echo:latest</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-28"></a><span class="gp">$</span> docker image ls
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-29"></a><span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-30"></a><span class="go">example/echo                     latest              294c33d2b845        37 seconds ago      750MB</span>
<a name="rest_code_2d06b26b80184f43ac5379420147b7b3-31"></a><span class="go">golang                           1.9                 ef89ef5c42a9        3 months ago        750MB</span>
</pre>
<ul class="simple">
<li>
<tt class="docutils literal">ENTRYPOINT</tt> というものを使うと、コマンド実行が便利になるらしい</li>
</ul>
</div>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id33">2.1.3 Docker コンテナを実行する</a></h3>
<ul>
<li>
<p class="first">コンテナを実行する</p>
<pre class="code console"><a name="rest_code_e0ce63e0e5b745949f4952aad924f57a-1"></a><span class="gp">$</span> docker container run example/echo:latest
<a name="rest_code_e0ce63e0e5b745949f4952aad924f57a-2"></a><span class="go">2018/11/04 10:05:45 start server</span>
</pre>
<ul class="simple">
<li>終了は、 <tt class="docutils literal">Ctrl + C</tt> (やってみたけど終わらないな...)</li>
</ul>
</li>
<li>
<p class="first"><tt class="docutils literal"><span class="pre">-d</span></tt>: バックグランドでコンテナを実行させる</p>
<pre class="code console"><a name="rest_code_0b919bf8a2234e94be564de2894e7e05-1"></a><span class="gp">$</span> docker container run -d example/echo:latest
<a name="rest_code_0b919bf8a2234e94be564de2894e7e05-2"></a><span class="go">449ccdc8c99e72ecd791b036417632ec3e7944f1e7ab14c5b96d7e4caec0e58b</span>
</pre>
<ul class="simple">
<li>ハッシュ値のような文字列は、 Docker コンテナのID</li>
<li>コンテナのID は、コンテナ実行時に付与される一意な ID</li>
</ul>
</li>
<li>
<p class="first">停止する</p>
<pre class="code console"><a name="rest_code_4393702405f8482e8aac0eccc0115968-1"></a><span class="gp">$</span> docker container stop <span class="k">$(</span>docker container ls --filter <span class="s2">"ancestor=example/echo"</span> -q<span class="k">)</span>
<a name="rest_code_4393702405f8482e8aac0eccc0115968-2"></a><span class="go">449ccdc8c99e</span>
</pre>
</li>
<li>
<p class="first">現在実行中のコンテナの一覧を表示する</p>
<pre class="code console"><a name="rest_code_fafe573fe7f84bde8f4c52178c64f140-1"></a><span class="gp">$</span> docker container ls
<a name="rest_code_fafe573fe7f84bde8f4c52178c64f140-2"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS               NAMES</span>
<a name="rest_code_fafe573fe7f84bde8f4c52178c64f140-3"></a><span class="go">449ccdc8c99e        example/echo:latest   "go run /echo/main.go"   2 minutes ago       Up 2 minutes                            determined_zhukovsky</span>
</pre>
</li>
</ul>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id34">ポートフォワーディング</a></h4>
<p>ホストマシンのポートをコンテナポートに紐づける。
コンテナの外から来た通信をコンテナポートに転送することができる。</p>
<ul>
<li>
<p class="first">ホスト側の 9000 番ポートをコンテナ側の 8080 番ポートにポートフォワーディングする。</p>
<pre class="code console"><a name="rest_code_09fcbd1a2ae149d084f6b111082ee5c8-1"></a><span class="gp">$</span> docker container run -d -p <span class="m">9000</span>:8080 example/echo:latest
<a name="rest_code_09fcbd1a2ae149d084f6b111082ee5c8-2"></a><span class="go">b113261a42b8fb110cd1984904dccfe859067abd078637ff37804ad5f00c3ff5</span>
</pre>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">-p</span> <span class="pre">{ホスト側ポート}:{コンテナポート}</span></tt></li>
<li>ホスト側のポートは省略できる。省略すると空いているポートが自動的に割り当てられる。</li>
</ul>
</li>
<li>
<p class="first">ホスト側のポートに curl で GET リクエストしてみる</p>
<pre class="code console"><a name="rest_code_15da6144cf0f4f139b8ec6c9cfcf6387-1"></a><span class="gp">$</span> curl http://localhost:9000/
<a name="rest_code_15da6144cf0f4f139b8ec6c9cfcf6387-2"></a><span class="go">Hello Docker!!</span>
</pre>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id35">2.2 Docker イメージの操作</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name">
<col class="field-body">
<tbody valign="top">
<tr class="field">
<th class="field-name">Docker イメージ:</th>
<td class="field-body">Docker コンテナを作成するためのテンプレート</td>
</tr>
<tr class="field">
<th class="field-name">Dockerfile:</th>
<td class="field-body">イメージを構築するための手順を記述したファイル</td>
</tr>
<tr class="field"><th class="field-name" colspan="2">Docker イメージをビルドする:</th></tr>
<tr class="field">
<td> </td>
<td class="field-body">イメージを構築する</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p class="first">Docker のヘルプを表示する</p>
<pre class="code console"><a name="rest_code_9798c8c96d9249f4919ba2180eecbce2-1"></a><span class="gp">$</span> docker <span class="nb">help</span>
</pre>
</li>
<li>
<p class="first">Docker のイメージ操作に関するコマンドのヘルプを表示する</p>
<pre class="code console"><a name="rest_code_ebe796705b77446e8edb096551a2f184-1"></a><span class="gp">$</span> docker image --help
</pre>
</li>
</ul>
<div class="section" id="docker-image-build">
<h3><a class="toc-backref" href="#id36">2.2.1 docker image build --- イメージのビルド</a></h3>
<ul>
<li>
<p class="first">Dockerfile をもとに Docker イメージを作成する</p>
<pre class="code console"><a name="rest_code_a4b871757f3148c483fdbc73771900ec-1"></a><span class="gp">$</span> docker image build -t イメージ名<span class="o">[</span>:タグ名<span class="o">]</span> Dockerfile配置ディレクトリのパス
</pre>
<ul class="simple">
<li>
<tt class="docutils literal"><span class="pre">-t</span> <span class="pre">イメージ名[:タグ名]</span></tt> : Docker を利用する上でほぼ必須。</li>
</ul>
</li>
<li>
<p class="first">Dockerfile という名前ではない Dockerfile を指定して Docker イメージを作成する</p>
<pre class="code console"><a name="rest_code_dcbaad4cc2134129bb52e6cc19c22fd0-1"></a><span class="gp">$</span> docker image build -f <span class="o">{</span>Dockerfile名<span class="o">}</span> -t イメージ名<span class="o">[</span>:タグ名<span class="o">]</span> Dockerfile配置ディレクトリのパス
</pre>
</li>
<li>
<p class="first">イメージをビルド時に、 <tt class="docutils literal">FROM</tt> で指定したベースイメージを強制的に再取得させる。</p>
<pre class="code console"><a name="rest_code_767d8b1846b140978c67bdb4cd4449e7-1"></a><span class="gp">$</span> docker image build --pull<span class="o">=</span><span class="nb">true</span> -t example/echo:latest
</pre>
<ul class="simple">
<li>実際の運用では、 <tt class="docutils literal">latest</tt> ではなく、タグ付けされたイメージを利用することがほとんど</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="docker-search">
<h3><a class="toc-backref" href="#id37">2.2.2 docker search --- イメージの検索</a></h3>
<div class="section" id="docker-hub">
<h4><a class="toc-backref" href="#id38">Docker Hub</a></h4>
<ul class="simple">
<li>Docker イメージのレジストリ</li>
<li>ユーザーや組織が GitHub と同様にリポジトリを持つことができる</li>
<li>リポジトリでそれぞれの Docker イメージを管理していく</li>
<li>全てのイメージのベースとなるような OS (CentOS や Ubuntu) のリポジトリ、言語のランタイムや著名なミドルウェアのイメージのリポジトリなどたくさんある</li>
<li>全ての Docker イメージを自前で用意する必要はない、ほかの人が作ったものを活用していく</li>
</ul>
</div>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id39">検索する</a></h4>
<pre class="code console"><a name="rest_code_70f686159f9c46e5acc4660a615e0960-1"></a><span class="gp">$</span> docker search <span class="o">[</span>options<span class="o">]</span> 検索キーワード
</pre>
<ul>
<li>
<p class="first">mysql を検索する</p>
<pre class="code console"><a name="rest_code_eac9881c7ee04deb8677b75d7fd24ec0-1"></a><span class="gp">$</span> docker search --limit <span class="m">5</span> mysql
<a name="rest_code_eac9881c7ee04deb8677b75d7fd24ec0-2"></a><span class="go">NAME                         DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span>
<a name="rest_code_eac9881c7ee04deb8677b75d7fd24ec0-3"></a><span class="go">mysql                        MySQL is a widely used, open-source relation…   7249                [OK]</span>
<a name="rest_code_eac9881c7ee04deb8677b75d7fd24ec0-4"></a><span class="go">mysql/mysql-server           Optimized MySQL Server Docker images. Create…   535                                     [OK]</span>
<a name="rest_code_eac9881c7ee04deb8677b75d7fd24ec0-5"></a><span class="go">zabbix/zabbix-server-mysql   Zabbix Server with MySQL database support       136                                     [OK]</span>
<a name="rest_code_eac9881c7ee04deb8677b75d7fd24ec0-6"></a><span class="go">mysql/mysql-cluster          Experimental MySQL Cluster Docker images. Cr…   33</span>
<a name="rest_code_eac9881c7ee04deb8677b75d7fd24ec0-7"></a><span class="go">circleci/mysql               MySQL is a widely used, open-source relation…   7</span>
</pre>
<ul class="simple">
<li>スターの降順で表示される</li>
<li>
<tt class="docutils literal"><span class="pre">--limit</span> 5</tt> : 表示件数を5件に制限する</li>
<li>名前空間はオーナー名</li>
<li>公式リポジトリは、名前空間が表示されない</li>
<li>公式リポジトリの名前空間には一律で <tt class="docutils literal">library</tt> がついているので、正式名称は <tt class="docutils literal">library/mysql</tt>
</li>
</ul>
</li>
<li>
<p class="first">リリースされているタグの一覧を表示する</p>
<pre class="code console"><a name="rest_code_44e894266e58463583896773f6418059-1"></a><span class="gp">$</span> curl -s <span class="s1">'https://hub.docker.com/v2/repositories/library/golang/tags/?page_size=10'</span> <span class="p">|</span> jq -r <span class="s1">'.results[].name'</span>
<a name="rest_code_44e894266e58463583896773f6418059-2"></a><span class="go">1.10</span>
<a name="rest_code_44e894266e58463583896773f6418059-3"></a><span class="go">1.10.5</span>
<a name="rest_code_44e894266e58463583896773f6418059-4"></a><span class="go">latest</span>
<a name="rest_code_44e894266e58463583896773f6418059-5"></a><span class="go">1</span>
<a name="rest_code_44e894266e58463583896773f6418059-6"></a><span class="go">1.11</span>
<a name="rest_code_44e894266e58463583896773f6418059-7"></a><span class="go">1.11.2</span>
<a name="rest_code_44e894266e58463583896773f6418059-8"></a><span class="go">1.10-alpine3.7</span>
<a name="rest_code_44e894266e58463583896773f6418059-9"></a><span class="go">1.10.5-alpine3.7</span>
<a name="rest_code_44e894266e58463583896773f6418059-10"></a><span class="go">1.10-alpine</span>
<a name="rest_code_44e894266e58463583896773f6418059-11"></a><span class="go">1.10.5-alpine</span>
</pre>
</li>
</ul>
</div>
</div>
<div class="section" id="docker-image-pull">
<h3><a class="toc-backref" href="#id40">2.2.3 docker image pull --- イメージの取得</a></h3>
<p>Docker レジストリから Docker イメージをダウンロードする</p>
<pre class="code console"><a name="rest_code_605d9a742c754cc3b1ea487a636a3f5f-1"></a><span class="gp">$</span> docker image pull <span class="o">[</span>options<span class="o">]</span> リポジトリ名<span class="o">[</span>:タグ名<span class="o">]</span>
</pre>
<ul>
<li>
<p class="first">指定するリポジトリ名とタグ名は Docker Hub に存在するものを指定する</p>
</li>
<li>
<p class="first">jenkins の Docker イメージをダウンロードする</p>
<pre class="code console"><a name="rest_code_26b7598129174a0483bda0fbb63dab9a-1"></a><span class="gp">$</span> docker image pull jenkins:latest
</pre>
<ul class="simple">
<li>タグ名を省略した場合は、デフォルトタグ (多くは latest) が利用される</li>
<li>ダウンロードしてきたイメージは、そのまま Docker コンテナとして利用できる</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="docker-image-ls">
<h3><a class="toc-backref" href="#id41">2.2.4 docker image ls --- イメージの一覧</a></h3>
<p>Docker ホストに保持されているイメージの一覧を表示する</p>
<pre class="code console"><a name="rest_code_486920dfd00442389803bb75b2318b44-1"></a><span class="gp">$</span> docker image ls <span class="o">[</span>options<span class="o">]</span> <span class="o">[</span>リポジトリ名<span class="o">[</span>:タグ名<span class="o">]]</span>
</pre>
<ul>
<li>
<p class="first">Docker ホスト: Docker デーモンを実行しているホスト環境のこと</p>
</li>
<li>
<p class="first">リモートから pull してきたイメージも、自分でビルドしたイメージも両方表示される</p>
<pre class="code console"><a name="rest_code_682b0c92001b42d3992f2640e9c7d382-1"></a><span class="gp">$</span> docker image ls
<a name="rest_code_682b0c92001b42d3992f2640e9c7d382-2"></a><span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<a name="rest_code_682b0c92001b42d3992f2640e9c7d382-3"></a><span class="go">example/echo                     latest              ed899b24590f        3 hours ago         750MB</span>
<a name="rest_code_682b0c92001b42d3992f2640e9c7d382-4"></a><span class="go">jenkins                          latest              cd14cecfdb3a        3 months ago        696MB</span>
<a name="rest_code_682b0c92001b42d3992f2640e9c7d382-5"></a><span class="go">golang                           1.9                 ef89ef5c42a9        3 months ago        750MB</span>
<a name="rest_code_682b0c92001b42d3992f2640e9c7d382-6"></a><span class="go">gihyodocker/echo                 latest              3dbbae6eb30d        10 months ago       733MB</span>
</pre>
<ul class="simple">
<li>
<tt class="docutils literal">IMAGE ID</tt> : イメージのID。コンテナのIDとは違うものなので、混同しないこと。</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="docker-image-tag">
<h3><a class="toc-backref" href="#id42">2.2.5 docker image tag --- イメージのタグ付け</a></h3>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id43">Docker イメージのバージョン</a></h4>
<p>イメージのバージョンとは、正確にはイメージIDのこと</p>
<ul>
<li>
<p class="first">イメージのビルドの度に、別の <tt class="docutils literal">IMAGE ID</tt> が割り振られる。</p>
<pre class="code console"><a name="rest_code_bc1a00f79b8b47d9b2f783389f14fce6-1"></a><span class="gp">$</span> docker image ls
<a name="rest_code_bc1a00f79b8b47d9b2f783389f14fce6-2"></a><span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<a name="rest_code_bc1a00f79b8b47d9b2f783389f14fce6-3"></a><span class="go">example/echo                     latest              ed899b24590f        3 hours ago         750MB</span>
<a name="rest_code_bc1a00f79b8b47d9b2f783389f14fce6-4"></a><span class="go">&lt;none&gt;                           &lt;none&gt;              294c33d2b845        3 hours ago         750MB</span>
</pre>
<ul class="simple">
<li>ひとつのタグに紐づけられるイメージはひとつまで (上の例だと <tt class="docutils literal">latest</tt> )</li>
<li>古いイメージはタグとの紐づけが解除されて <tt class="docutils literal">&lt;none&gt;</tt> になる</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id">
<h4><a class="toc-backref" href="#id44">イメージIDへのタグ付け</a></h4>
<p>イメージID にタグ名という形で別名をつけることができる</p>
<pre class="code console"><a name="rest_code_0f8a182463694a61b4361895fbf1ccc2-1"></a><span class="gp">$</span> docker image tag 元イメージ名<span class="o">[</span>:タグ<span class="o">]</span> 新イメージ名<span class="o">[</span>:タグ<span class="o">]</span>
</pre>
<ul>
<li>
<p class="first">ある特定のイメージIDを持つ Docker イメージを識別しやすくするために使う。</p>
</li>
<li>
<p class="first"><tt class="docutils literal">latest</tt> は Git で言うところの master ブランチのようなもの。常に最新のイメージ。</p>
</li>
<li>
<p class="first"><tt class="docutils literal">example/echo</tt> の <tt class="docutils literal">latest</tt> に 0.1.0 のタグをつける</p>
<pre class="code console"><a name="rest_code_cf343c3866454daea5c5a010e08758ee-1"></a><span class="gp">$</span> docker image tag example/echo:latest example/echo:0.1.0
<a name="rest_code_cf343c3866454daea5c5a010e08758ee-2"></a><span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<a name="rest_code_cf343c3866454daea5c5a010e08758ee-3"></a><span class="go">example/echo                     0.1.0               ed899b24590f        3 hours ago         750MB</span>
<a name="rest_code_cf343c3866454daea5c5a010e08758ee-4"></a><span class="go">example/echo                     latest              ed899b24590f        3 hours ago         750MB</span>
<a name="rest_code_cf343c3866454daea5c5a010e08758ee-5"></a><span class="go">&lt;none&gt;                           &lt;none&gt;              294c33d2b845        3 hours ago         750MB</span>
</pre>
</li>
</ul>
</div>
</div>
<div class="section" id="docker-image-push">
<h3><a class="toc-backref" href="#id45">2.2.6 docker image push --- イメージの公開</a></h3>
<p>Docker イメージを Docker Hub などのレジストリに登録する</p>
<pre class="code console"><a name="rest_code_e31dd7667c4442f78a3f004ff4538c95-1"></a><span class="gp">$</span> docker image push <span class="o">[</span>options<span class="o">]</span> リポジトリ名<span class="o">[</span>:タグ<span class="o">]</span>
</pre>
<div class="section" id="docker-hub-push">
<h4><a class="toc-backref" href="#id46">Docker Hub にイメージを push する</a></h4>
<ol class="arabic">
<li>
<p class="first">Docker Hub にログインする</p>
<blockquote>
<pre class="code console"><a name="rest_code_0e660510bc554d29b4baf4d40d2a4cec-1"></a><span class="gp">$</span> docker login -u your_docker_id -p your_docker_pw
</pre>
</blockquote>
</li>
<li>
<p class="first">名前空間を自分のリポジトリ名にする</p>
<blockquote>
<pre class="code console"><a name="rest_code_60b4dec64f5542a584623a8a2e43021e-1"></a><span class="gp">$</span> docker image tag example/echo:latest fumi23/echo:latest
<a name="rest_code_60b4dec64f5542a584623a8a2e43021e-2"></a><span class="gp">$</span> docker image ls
<a name="rest_code_60b4dec64f5542a584623a8a2e43021e-3"></a><span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<a name="rest_code_60b4dec64f5542a584623a8a2e43021e-4"></a><span class="go">example/echo                     0.1.0               ed899b24590f        4 hours ago         750MB</span>
<a name="rest_code_60b4dec64f5542a584623a8a2e43021e-5"></a><span class="go">example/echo                     latest              ed899b24590f        4 hours ago         750MB</span>
<a name="rest_code_60b4dec64f5542a584623a8a2e43021e-6"></a><span class="go">fumi23/echo                      latest              ed899b24590f        4 hours ago         750MB</span>
</pre>
<ul class="simple">
<li>Docker Hub は、自分が所有している、または、所属している organization のリポジトリにしか push できない</li>
</ul>
</blockquote>
</li>
<li>
<p class="first">Docker Hub に push する</p>
<blockquote>
<pre class="code console"><a name="rest_code_d8fcfcf603924fbeb3d6ffcaebbd1acb-1"></a><span class="gp">$</span> docker image push fumi23/echo:latest
<a name="rest_code_d8fcfcf603924fbeb3d6ffcaebbd1acb-2"></a><span class="go">The push refers to repository [docker.io/fumi23/echo]</span>
<a name="rest_code_d8fcfcf603924fbeb3d6ffcaebbd1acb-3"></a><span class="go">b2aff6d696c0: Preparing</span>
<a name="rest_code_d8fcfcf603924fbeb3d6ffcaebbd1acb-4"></a><span class="go">f18abb5d7b45: Preparing</span>
<a name="rest_code_d8fcfcf603924fbeb3d6ffcaebbd1acb-5"></a><span class="go">f18abb5d7b45: Pushed</span>
<a name="rest_code_d8fcfcf603924fbeb3d6ffcaebbd1acb-6"></a><span class="go">latest: digest: sha256:834be6348517746b53f3d44c56b580a0cea74161b86426cc006b1c066c48e047 size: 2417</span>
</pre>
</blockquote>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="id11">
<h2><a class="toc-backref" href="#id47">2.3 Docker コンテナの操作</a></h2>
<p>Docker コンテナは外から見ると仮想環境、ファイルシステムとアプリケーションが同梱されている箱のようなもの。</p>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id48">2.3.1 Docker コンテナのライフサイクル</a></h3>
<p>Docker コンテナは、以下の3つの状態のいずれかに分類される。</p>
<table border="1" class="colwidths-auto docutils"><tbody valign="top">
<tr>
<th class="stub">実行中</th>
<td>
<tt class="docutils literal">$ docker container run</tt> で起動した状態。</td>
</tr>
<tr>
<th class="stub">停止</th>
<td>停止しても、ディスクにコンテナ終了時の状態は保持される。停止したコンテナは再実行可能。</td>
</tr>
<tr>
<th class="stub">破棄</th>
<td><ul class="first last simple">
<li>停止したコンテナは明示的に破棄しない限りディスクに残り続ける。どんどんたまる。</li>
<li>完全に不要なコンテナは破棄するほうが望ましい。</li>
<li>一度破棄したコンテナを再び開始することはできない。</li>
</ul></td>
</tr>
</tbody></table>
</div>
<div class="section" id="docker-container-run">
<h3><a class="toc-backref" href="#id49">2.3.2 docker container run --- コンテナの作成と実行</a></h3>
<p>Docker イメージからコンテナを作成、実行するコマンド。</p>
<pre class="code console"><a name="rest_code_f39c97bfde384fcb97e59cfe15910b77-1"></a><span class="gp">$</span> docker container run <span class="o">[</span>options<span class="o">]</span> イメージ名<span class="o">[</span>:タグ名<span class="o">]</span> <span class="o">[</span>コマンド<span class="o">]</span> <span class="o">[</span>コマンド引数...<span class="o">]</span>
</pre>
<pre class="code console"><a name="rest_code_2ff9cdccfd0742989d186700b3df5524-1"></a><span class="gp">$</span> docker container run <span class="o">[</span>options<span class="o">]</span> イメージID <span class="o">[</span>コマンド<span class="o">]</span> <span class="o">[</span>コマンド引数...<span class="o">]</span>
</pre>
<div class="admonition note">
<p class="first admonition-title">備考</p>
<p>コンテナをバックグラウンドで実行 → HTTP リクエストしてみる → 停める</p>
<div class="last"><pre class="code console"><a name="rest_code_06cef588a73746ad9b264c17240a7364-1"></a><span class="gp">$</span> docker container run -d -p <span class="m">9001</span>:8080 example/echo:latest
<a name="rest_code_06cef588a73746ad9b264c17240a7364-2"></a><span class="gp">$</span> curl http://localhost:9001/
<a name="rest_code_06cef588a73746ad9b264c17240a7364-3"></a><span class="gp">$</span> docker container stop <span class="k">$(</span>docker container ls --filter <span class="s2">"ancestor=example/echo"</span> -q<span class="k">)</span>
</pre></div>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id50">docker container run 時に引数を与える</a></h4>
<pre class="code console"><a name="rest_code_631e2126734b4908a296e1fe897183c7-1"></a><span class="gp">$</span> docker image pull alpine:3.7
<a name="rest_code_631e2126734b4908a296e1fe897183c7-2"></a><span class="gp">#</span> docker container run -it alpine:3.7  <span class="c1"># シェルに入る</span>
<a name="rest_code_631e2126734b4908a296e1fe897183c7-3"></a><span class="gp">$</span> docker container run -it alpine:3.7 uname -a
</pre>
</div>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id51">名前付きコンテナ</a></h4>
<p><tt class="docutils literal">NAMES</tt> は適当な単語で作られた名前が自動でつけられる。</p>
<pre class="code console"><a name="rest_code_894b8432e9e647449401ff005d59caa1-1"></a><span class="gp">$</span> docker container ls
<a name="rest_code_894b8432e9e647449401ff005d59caa1-2"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                    NAMES</span>
<a name="rest_code_894b8432e9e647449401ff005d59caa1-3"></a><span class="go">77699bc8d7cd        example/echo:latest   "go run /echo/main.go"   4 seconds ago       Up 2 seconds        0.0.0.0:9001-&gt;8080/tcp   modest_saha</span>
</pre>
<p>コンテナに好きな名前をつけられる。</p>
<pre class="code console"><a name="rest_code_253b53eda63545de884921fe4dd80158-1"></a><span class="gp">$</span> docker container run --name <span class="o">[</span>好きなコンテナ名<span class="o">]</span> <span class="o">[</span>イメージ名<span class="o">]</span>:<span class="o">[</span>タグ<span class="o">]</span>
</pre>
<pre class="code console"><a name="rest_code_9e6c8bb1aea443b99ea5a25647c5a806-1"></a><span class="gp">$</span> docker container run -t -d --name gihyo-echo example/echo:latest
<a name="rest_code_9e6c8bb1aea443b99ea5a25647c5a806-2"></a><span class="go">4864fcaf10802340449f50364891cc48b99e90538f04d8e601c5c0397ff11917</span>
<a name="rest_code_9e6c8bb1aea443b99ea5a25647c5a806-3"></a><span class="gp">$</span> docker container ls
<a name="rest_code_9e6c8bb1aea443b99ea5a25647c5a806-4"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                    NAMES</span>
<a name="rest_code_9e6c8bb1aea443b99ea5a25647c5a806-5"></a><span class="go">4864fcaf1080        example/echo:latest   "go run /echo/main.go"   3 seconds ago       Up 2 seconds                                 gihyo-echo</span>
<a name="rest_code_9e6c8bb1aea443b99ea5a25647c5a806-6"></a><span class="go">77699bc8d7cd        example/echo:latest   "go run /echo/main.go"   4 minutes ago       Up 4 minutes        0.0.0.0:9001-&gt;8080/tcp   modest_saha</span>
</pre>
<ul class="simple">
<li>開発時は便利だが、本番環境ではあまり使わない</li>
<li>同名のコンテナを新たに実行するには既存の同名コンテナを削除する必要があるため</li>
</ul>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id52">コマンド実行時の頻出オプション</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name">
<col class="field-body">
<tbody valign="top">
<tr class="field">
<th class="field-name">-i:</th>
<td class="field-body">docker 起動後にコンテナ側の標準入力をつなぎっぱなしにする。シェルに入ってコマンド実行ができる。</td>
</tr>
<tr class="field">
<th class="field-name">-t:</th>
<td class="field-body">擬似端末を有効にする。</td>
</tr>
<tr class="field">
<th class="field-name">-it:</th>
<td class="field-body">-i と -t はセットで使うことが多い。</td>
</tr>
<tr class="field">
<th class="field-name">--rm:</th>
<td class="field-body">コンテナ終了時にコンテナを破棄する。</td>
</tr>
<tr class="field">
<th class="field-name">-v:</th>
<td class="field-body">ホストとコンテナ間でディレクトリ、ファイルを共有する</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="docker-container-ls">
<h3><a class="toc-backref" href="#id53">2.3.3 docker container ls --- コンテナの一覧</a></h3>
<p>実行中及び終了したコンテナの一覧を表示するコマンド</p>
<pre class="code console"><a name="rest_code_0646655dbd06440f8aebe48af1660c36-1"></a><span class="gp">$</span> docker container ls <span class="o">[</span>options<span class="o">]</span>
</pre>
<p>オプションなしで実行すると、実行中のコンテナ一覧が表示される</p>
<pre class="code console"><a name="rest_code_f228363d67f64e0a9c8b8cb3204ac2d4-1"></a><span class="gp">$</span> docker container run -t -d -p <span class="m">8080</span> --name fumi23 example/echo:latest
<a name="rest_code_f228363d67f64e0a9c8b8cb3204ac2d4-2"></a><span class="go">81e3a724ae7c730eea14b86edf354c9aad4bced96e272d1fce238760080a23b6</span>
<a name="rest_code_f228363d67f64e0a9c8b8cb3204ac2d4-3"></a><span class="gp">$</span> docker container run -t -d -p <span class="m">8080</span> --name fumi45 example/echo:latest
<a name="rest_code_f228363d67f64e0a9c8b8cb3204ac2d4-4"></a><span class="go">db029554bc5fc2e23a724892bef867c613ae5dba861e50de48914bcde23ebaf1</span>
<a name="rest_code_f228363d67f64e0a9c8b8cb3204ac2d4-5"></a><span class="gp">$</span> docker container ls
<a name="rest_code_f228363d67f64e0a9c8b8cb3204ac2d4-6"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_f228363d67f64e0a9c8b8cb3204ac2d4-7"></a><span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   21 seconds ago      Up 21 seconds       0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<a name="rest_code_f228363d67f64e0a9c8b8cb3204ac2d4-8"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   44 seconds ago      Up 43 seconds       0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre>
<table border="1" class="colwidths-auto docutils">
<caption>一覧の表示項目</caption>
<thead valign="bottom"><tr>
<th class="head">項目</th>
<th class="head">内容</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>CONTAINER ID</td>
<td>コンテナに付与される一意の ID</td>
</tr>
<tr>
<td>IMAGE</td>
<td>コンテナ作成に使用された Docker イメージ</td>
</tr>
<tr>
<td>COMMAND</td>
<td>コンテナで実行されているアプリケーションのプロセス</td>
</tr>
<tr>
<td>CREATED</td>
<td>コンテナが作成されてから経過した時間</td>
</tr>
<tr>
<td>STATUS</td>
<td>Up (実行中), Exited(終了) といったコンテナの実行状態</td>
</tr>
<tr>
<td>PORTS</td>
<td>ホストのポートとコンテナポートの紐づけ (ポートフォワーディング)</td>
</tr>
<tr>
<td>NAMES</td>
<td>コンテナにつけられた名前</td>
</tr>
</tbody>
</table>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id54">コンテナIDだけを抽出する</a></h4>
<pre class="code console"><a name="rest_code_79336c94e0fc4f25a25a17c5c538eb71-1"></a><span class="gp">$</span> docker container ls -q
<a name="rest_code_79336c94e0fc4f25a25a17c5c538eb71-2"></a><span class="go">db029554bc5f</span>
<a name="rest_code_79336c94e0fc4f25a25a17c5c538eb71-3"></a><span class="go">81e3a724ae7c</span>
</pre>
</div>
<div class="section" id="filter">
<h4><a class="toc-backref" href="#id55">filter を使う</a></h4>
<p>特定の条件に一致するものだけを抽出する</p>
<pre class="code console"><a name="rest_code_f42c883b49d14df5af24fabddbe9c079-1"></a><span class="gp">$</span> docker container ls --filter <span class="s2">"filter名=値"</span>
</pre>
<ul>
<li>
<p class="first">コンテナ名で抽出する</p>
<pre class="code console"><a name="rest_code_8a8c297a44f742ab86fede70280f89db-1"></a><span class="gp">$</span> docker container ls --filter <span class="s2">"name=fumi45"</span>
<a name="rest_code_8a8c297a44f742ab86fede70280f89db-2"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_8a8c297a44f742ab86fede70280f89db-3"></a><span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
</pre>
</li>
<li>
<p class="first">イメージ名で抽出する</p>
<pre class="code console"><a name="rest_code_78b9233a51494f5d920fc3454b7b4668-1"></a><span class="gp">$</span> docker container ls --filter <span class="s2">"ancestor=example/echo"</span>
<a name="rest_code_78b9233a51494f5d920fc3454b7b4668-2"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_78b9233a51494f5d920fc3454b7b4668-3"></a><span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<a name="rest_code_78b9233a51494f5d920fc3454b7b4668-4"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre>
</li>
</ul>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id56">終了したコンテナを取得する</a></h4>
<p>終了したコンテナも含めたコンテナの一覧を取得する</p>
<blockquote>
<pre class="code console"><a name="rest_code_8569276b93f14b85ac52d664afc2d0d2-1"></a><span class="gp">$</span> docker container ls -a
<a name="rest_code_8569276b93f14b85ac52d664afc2d0d2-2"></a><span class="go">CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS                    PORTS                     NAMES</span>
<a name="rest_code_8569276b93f14b85ac52d664afc2d0d2-3"></a><span class="go">db029554bc5f        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<a name="rest_code_8569276b93f14b85ac52d664afc2d0d2-4"></a><span class="go">81e3a724ae7c        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<a name="rest_code_8569276b93f14b85ac52d664afc2d0d2-5"></a><span class="go">4864fcaf1080        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               gihyo-echo</span>
<a name="rest_code_8569276b93f14b85ac52d664afc2d0d2-6"></a><span class="go">77699bc8d7cd        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               modest_saha</span>
<a name="rest_code_8569276b93f14b85ac52d664afc2d0d2-7"></a><span class="go">...</span>
</pre>
</blockquote>
</div>
</div>
<div class="section" id="docker-container-stop">
<h3><a class="toc-backref" href="#id57">2.3.4 docker container stop --- コンテナの停止</a></h3>
<p>実行しているコンテナを終了する</p>
<pre class="code console"><a name="rest_code_f92985cc8d3741539f5ee78b88f53f5f-1"></a><span class="gp">$</span> docker container stop コンテナIDまたはコンテナ名
</pre>
<ul>
<li>
<p class="first">コンテナ名 <tt class="docutils literal">fumi45</tt> のコンテナを終了する。</p>
<pre class="code console"><a name="rest_code_e9afe045d3524262bafcd2190c037790-1"></a><span class="gp">$</span> docker container ls
<a name="rest_code_e9afe045d3524262bafcd2190c037790-2"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_e9afe045d3524262bafcd2190c037790-3"></a><span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<a name="rest_code_e9afe045d3524262bafcd2190c037790-4"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<a name="rest_code_e9afe045d3524262bafcd2190c037790-5"></a><span class="gp">$</span> docker container stop fumi45
<a name="rest_code_e9afe045d3524262bafcd2190c037790-6"></a><span class="go">fumi45</span>
<a name="rest_code_e9afe045d3524262bafcd2190c037790-7"></a><span class="gp">$</span> docker container ls
<a name="rest_code_e9afe045d3524262bafcd2190c037790-8"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_e9afe045d3524262bafcd2190c037790-9"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre>
</li>
</ul>
</div>
<div class="section" id="docker-container-restart">
<h3><a class="toc-backref" href="#id58">2.3.5 docker container restart --- コンテナの再起動</a></h3>
<p>一度停止したコンテナは破棄しない限り、再実行できる。</p>
<pre class="code console"><a name="rest_code_182709d2d14544fab3666eef5db7371a-1"></a><span class="gp">$</span> docker container restart コンテナIDまたはコンテナ名
</pre>
<ul>
<li>
<p class="first">さっき停止した fumi45 を再実行する</p>
<pre class="code console"><a name="rest_code_41cc138dcc4248b8b7cce656d3276101-1"></a><span class="gp">$</span> docker container restart fumi45
<a name="rest_code_41cc138dcc4248b8b7cce656d3276101-2"></a><span class="go">fumi45</span>
<a name="rest_code_41cc138dcc4248b8b7cce656d3276101-3"></a><span class="gp">$</span> docker container ls
<a name="rest_code_41cc138dcc4248b8b7cce656d3276101-4"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_41cc138dcc4248b8b7cce656d3276101-5"></a><span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 3 seconds        0.0.0.0:32770-&gt;8080/tcp   fumi45</span>
<a name="rest_code_41cc138dcc4248b8b7cce656d3276101-6"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre>
</li>
</ul>
</div>
<div class="section" id="docker-container-rm">
<h3><a class="toc-backref" href="#id59">2.3.6 docker container rm --- コンテナの破棄</a></h3>
<p>停止したコンテナをディスクから完全に破棄する。 (破棄しない限りはどんどん溜まる)</p>
<pre class="code console"><a name="rest_code_cb41245234fb46e2884ba51fe3bfdc14-1"></a><span class="gp">$</span> docker container rm コンテナIDまたはコンテナ名
</pre>
<ul>
<li>
<p class="first">コンテナID <tt class="docutils literal">4864fcaf1080</tt> のコンテナを破棄する。</p>
<pre class="code console"><a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-1"></a><span class="gp">$</span> docker container ls -a
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-2"></a><span class="go">CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS                    PORTS                     NAMES</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-3"></a><span class="go">db029554bc5f        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-4"></a><span class="go">81e3a724ae7c        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-5"></a><span class="go">4864fcaf1080        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               gihyo-echo</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-6"></a><span class="go">77699bc8d7cd        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               modest_saha</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-7"></a><span class="gp">$</span> docker container rm 4864fcaf1080
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-8"></a><span class="go">4864fcaf1080</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-9"></a><span class="gp">$</span> docker container ls -a
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-10"></a><span class="go">CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS                    PORTS                     NAMES</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-11"></a><span class="go">db029554bc5f        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 minutes              0.0.0.0:32770-&gt;8080/tcp   fumi45</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-12"></a><span class="go">81e3a724ae7c        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<a name="rest_code_c15cbecba6fa4a7ea1c22a8746954d02-13"></a><span class="go">77699bc8d7cd        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               modest_saha</span>
</pre>
</li>
<li>
<p class="first">実行中のコンテナを停止・削除する。</p>
<pre class="code console"><a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-1"></a><span class="gp">$</span> docker container ls
<a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-2"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-3"></a><span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 8 minutes        0.0.0.0:32770-&gt;8080/tcp   fumi45</span>
<a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-4"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-5"></a><span class="gp">$</span> docker container rm -f db029554bc5f
<a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-6"></a><span class="go">db029554bc5f</span>
<a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-7"></a><span class="gp">$</span> docker container ls
<a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-8"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_d9b1ec35c07c426aaeb66fa8594c7bed-9"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre>
</li>
</ul>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id60">停止の際にコンテナを破棄する</a></h4>
<pre class="code console"><a name="rest_code_735cd2b677a84d7ebc88466461199014-1"></a><span class="gp">$</span> docker container run --rm
</pre>
<ul>
<li>
<p class="first">コマンドラインツールとして利用するときなどに便利</p>
</li>
<li>
<p class="first">停止したあとディスクに保持し続ける必要がないときに利用する</p>
</li>
<li>
<p class="first">例)</p>
<pre class="code console"><a name="rest_code_7d78c97717f4473a995ac6b5fd19c244-1"></a><span class="gp">$</span> <span class="nb">echo</span> <span class="s1">'{"version": 100}'</span> <span class="p">|</span> docker container run -i --rm gihyodocker/jq:1.5 <span class="s1">'.version'</span>
<a name="rest_code_7d78c97717f4473a995ac6b5fd19c244-2"></a><span class="go">100</span>
</pre>
</li>
</ul>
</div>
</div>
<div class="section" id="docker-container-logs">
<h3><a class="toc-backref" href="#id61">2.3.7 docker container logs --- 標準出力の取得</a></h3>
<p>実行している特定のコンテナの標準出力を表示する。</p>
<pre class="code console"><a name="rest_code_f7aeadf6ef2142dd9412816ca57b2196-1"></a><span class="gp">$</span> docker container logs <span class="o">[</span>options<span class="o">]</span> コンテナIDまたはコンテナ名
</pre>
<ul class="simple">
<li>標準出力されているものだけが表示される。</li>
<li>コンテナ内でアプリケーションがファイルに出力したようなログは表示されない</li>
</ul>
</div>
<div class="section" id="docker-container-exec">
<h3><a class="toc-backref" href="#id62">2.3.8 docker container exec --- 実行中コンテナでのコマンド実行</a></h3>
<p>実行中の Docker コンテナの中で、任意のコマンドを実行できる。</p>
<pre class="code console"><a name="rest_code_45a588ea6934413fa8d7cf2c82399e96-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> <span class="o">[</span>options<span class="o">]</span> コンテナIDまたはコンテナ名 コンテナ内で実行するコマンド
</pre>
<ul>
<li>
<p class="first">実行中のコンテナ <tt class="docutils literal">fumi23</tt> 内で <tt class="docutils literal">pwd</tt> コマンドを実行する。</p>
<pre class="code console"><a name="rest_code_fe310218b25d42cf9591a68ac70e4aea-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> fumi23 <span class="nb">pwd</span>
<a name="rest_code_fe310218b25d42cf9591a68ac70e4aea-2"></a><span class="go">/go</span>
</pre>
</li>
<li>
<p class="first">コンテナをシェル経由で操作する。</p>
<pre class="code console"><a name="rest_code_d45cde3179d44e2c8d5bcbe591c1d466-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -it fumi23 sh
<a name="rest_code_d45cde3179d44e2c8d5bcbe591c1d466-2"></a><span class="gp">#</span> <span class="nb">pwd</span>
<a name="rest_code_d45cde3179d44e2c8d5bcbe591c1d466-3"></a><span class="go">/go</span>
<a name="rest_code_d45cde3179d44e2c8d5bcbe591c1d466-4"></a><span class="gp">#</span> <span class="nb">exit</span>
</pre>
<ul class="simple">
<li>本番環境ではやらないほうがよい</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="docker-container-cp">
<h3><a class="toc-backref" href="#id63">2.3.9 docker container cp --- ファイルのコピー</a></h3>
<p>コンテナ間、コンテナ・ホスト間でファイルをコピーできる。</p>
<pre class="code console"><a name="rest_code_54b43eafb8cb4ccf879879d8668f794f-1"></a><span class="gp">$</span> docker container cp <span class="o">[</span>options<span class="o">]</span> コンテナIDまたはコンテナ名:コンテナ内のコピー元 ホストのコピー先
</pre>
<pre class="code console"><a name="rest_code_27549cd6b5684d17898466c72c0ca733-1"></a><span class="gp">$</span> docker container cp <span class="o">[</span>options<span class="o">]</span> ホストのコピー元 コンテナIDまたはコンテナ名:コンテナ内のコピー先
</pre>
<ul>
<li>
<p class="first">実行中のコンテナ <tt class="docutils literal">fumi23</tt> からホストのカレントディレクトリに <tt class="docutils literal">main.go</tt> をコピーする。</p>
<pre class="code console"><a name="rest_code_024da30f33b44b79835d0d6d007d9b43-1"></a><span class="gp">$</span> docker container cp fumi23:/echo/main.go .
</pre>
</li>
<li>
<p class="first">ホストのカレントディレクトリから、実行中のコンテナ <tt class="docutils literal">fumi23</tt> に <tt class="docutils literal">dummy.txt</tt> をコピーする。</p>
<pre class="code console"><a name="rest_code_cce0d8884f7c497cac0df8be036e5fb3-1"></a><span class="gp">$</span> docker container cp dummy.txt fumi23:tmp
<a name="rest_code_cce0d8884f7c497cac0df8be036e5fb3-2"></a><span class="gp">$</span> docker container <span class="nb">exec</span> fumi23 ls /tmp <span class="p">|</span> grep dummy
<a name="rest_code_cce0d8884f7c497cac0df8be036e5fb3-3"></a><span class="go">dummy.txt</span>
</pre>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">備考</p>
<ul class="last simple">
<li>コンテナ内で生成されたファイルをホストにコピーしてきて確認するようなデバッグ用途で使ったりする。</li>
<li>破棄されていない終了したコンテナに対しても実行できる。</li>
</ul>
</div>
</div>
</div>
<div class="section" id="id19">
<h2><a class="toc-backref" href="#id64">2.4 運用管理向けコマンド</a></h2>
<div class="section" id="prune">
<h3><a class="toc-backref" href="#id65">2.4.1 prune --- 破棄</a></h3>
<p>停止しているコンテナを一括で削除する。</p>
<pre class="code console"><a name="rest_code_6a82cda2377245b6a6cd2eb45645b219-1"></a><span class="gp">$</span> docker container prune <span class="o">[</span>options<span class="o">]</span>
</pre>
<ul>
<li>
<p class="first">途中で 確認を求められるので <tt class="docutils literal">y</tt> と回答する。</p>
<pre class="code console"><a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-1"></a><span class="gp">$</span> docker container ls -a
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-2"></a><span class="go">CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS                    PORTS                     NAMES</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-3"></a><span class="go">81e3a724ae7c        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-4"></a><span class="go">77699bc8d7cd        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               modest_saha</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-5"></a><span class="go">9a5c3a822e39        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               inspiring_goldstine</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-6"></a><span class="go">f4e8a963eae4        example/echo:latest       "go run /echo/main.go"   5 days ago          Created                                             affectionate_curie</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-7"></a><span class="go">b113261a42b8        example/echo:latest       "go run /echo/main.go"   6 days ago          Exited (2) 5 days ago                               ecstatic_tesla</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-8"></a><span class="go">449ccdc8c99e        example/echo:latest       "go run /echo/main.go"   6 days ago          Exited (2) 6 days ago                               determined_zhukovsky</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-9"></a><span class="go">a11a7535307a        example/echo:latest       "go run /echo/main.go"   6 days ago          Exited (2) 6 days ago                               vibrant_borg</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-10"></a><span class="go">b8c42ba791e7        294c33d2b845              "go run /echo/main.go"   6 days ago          Exited (2) 6 days ago                               admiring_lalande</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-11"></a><span class="go">9cd48659badb        gihyodocker/echo:latest   "go run /echo/main.go"   7 days ago          Exited (2) 7 days ago                               dreamy_saha</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-12"></a><span class="go">fe9ad59901bb        gihyodocker/echo:latest   "go run /echo/main.go"   5 weeks ago         Exited (255) 7 days ago   0.0.0.0:9000-&gt;8080/tcp    vigilant_snyder</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-13"></a><span class="gp">$</span> docker container prune
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-14"></a><span class="go">WARNING! This will remove all stopped containers.</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-15"></a><span class="go">Are you sure you want to continue? [y/N] y</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-16"></a><span class="go">Deleted Containers:</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-17"></a><span class="go">77699bc8d7cd6992526da9171db5d10b511f46f4b12b8d68706825fddf8b7a18</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-18"></a><span class="go">9a5c3a822e39ee5f811f21634c38cd4918a35e2e1ca0f680d170576fe98e7f33</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-19"></a><span class="go">f4e8a963eae40f539e92b95b14236af8e614977d20bd80d11e0f870e6bfcdb0c</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-20"></a><span class="go">b113261a42b8fb110cd1984904dccfe859067abd078637ff37804ad5f00c3ff5</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-21"></a><span class="go">449ccdc8c99e72ecd791b036417632ec3e7944f1e7ab14c5b96d7e4caec0e58b</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-22"></a><span class="go">a11a7535307a23a8121c7ac241e4df40f125a3187f556451e9014aa4f710046f</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-23"></a><span class="go">b8c42ba791e7f266451bddc6d74b1eb196bf3b55d072bc8ff2f64a7f9c096648</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-24"></a><span class="go">9cd48659badb6c5e8add684becbc91bae8fbeb6a928ae93618d8ff9fe3d36a6d</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-25"></a><span class="go">fe9ad59901bbdd5dbad274eddc2def85fc49361a6299a7ae02f7693944c928ef</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-26"></a>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-27"></a><span class="go">Total reclaimed space: 29.41MB</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-28"></a><span class="gp">$</span> docker container ls -a
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-29"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<a name="rest_code_35dd047f2bae4b54ae360dc2080c1062-30"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre>
</li>
</ul>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id66">Docker イメージを一括削除する</a></h4>
<p>Docker イメージも一括で削除できる。</p>
<pre class="code console"><a name="rest_code_a8b13074b528473bb73bd9c111070023-1"></a><span class="gp">$</span> docker image prune <span class="o">[</span>options<span class="o">]</span>
</pre>
<ul>
<li>
<p class="first">途中で 確認を求められるので <tt class="docutils literal">y</tt> と回答する。</p>
<pre class="code console"><a name="rest_code_8adef25512de47408fdecd01d4752257-1"></a><span class="gp">$</span> docker image ls
<a name="rest_code_8adef25512de47408fdecd01d4752257-2"></a><span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-3"></a><span class="go">example/echo                     0.1.0               ed899b24590f        6 days ago          750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-4"></a><span class="go">example/echo                     latest              ed899b24590f        6 days ago          750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-5"></a><span class="go">fumi23/echo                      latest              ed899b24590f        6 days ago          750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-6"></a><span class="go">&lt;none&gt;                           &lt;none&gt;              294c33d2b845        7 days ago          750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-7"></a><span class="go">jenkins                          latest              cd14cecfdb3a        3 months ago        696MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-8"></a><span class="go">golang                           1.9                 ef89ef5c42a9        3 months ago        750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-9"></a><span class="go">gihyodocker/jq                   1.5                 fb12c33cec33        10 months ago       5.31MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-10"></a><span class="go">gihyodocker/echo                 latest              3dbbae6eb30d        10 months ago       733MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-11"></a><span class="gp">$</span> docker image prune
<a name="rest_code_8adef25512de47408fdecd01d4752257-12"></a><span class="go">WARNING! This will remove all dangling images.</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-13"></a><span class="go">Are you sure you want to continue? [y/N] y</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-14"></a><span class="go">Deleted Images:</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-15"></a><span class="go">deleted: sha256:294c33d2b8454edba3e291fff2e2e477b287df30c13734a72fd8018cc4b4be9b</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-16"></a><span class="go">deleted: sha256:73db87b05d43898a40665c4a8614bb383fc6bf050a37601e29da0fdb3f71e724</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-17"></a><span class="go">deleted: sha256:8b7b14181869de8ccf721f5fc57b37b9d9ff533dc4c67201ff7b78862a67553c</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-18"></a>
<a name="rest_code_8adef25512de47408fdecd01d4752257-19"></a><span class="go">Total reclaimed space: 395B</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-20"></a><span class="gp">$</span> docker image ls
<a name="rest_code_8adef25512de47408fdecd01d4752257-21"></a><span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-22"></a><span class="go">example/echo                     0.1.0               ed899b24590f        6 days ago          750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-23"></a><span class="go">example/echo                     latest              ed899b24590f        6 days ago          750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-24"></a><span class="go">fumi23/echo                      latest              ed899b24590f        6 days ago          750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-25"></a><span class="go">jenkins                          latest              cd14cecfdb3a        3 months ago        696MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-26"></a><span class="go">golang                           1.9                 ef89ef5c42a9        3 months ago        750MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-27"></a><span class="go">gihyodocker/jq                   1.5                 fb12c33cec33        10 months ago       5.31MB</span>
<a name="rest_code_8adef25512de47408fdecd01d4752257-28"></a><span class="go">gihyodocker/echo                 latest              3dbbae6eb30d        10 months ago       733MB</span>
</pre>
<ul class="simple">
<li>残っているイメージは、 Docker が自動で判断して残しているもの。実行中のコンテナのイメージであるなど理由がある。</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id67">Docker リソースを一括削除する</a></h4>
<p>利用されていない Docker コンテナやイメージ、ボリューム、ネットワークといった全ての Docker リソースを一括で削除する。</p>
<pre class="code console"><a name="rest_code_4241fc1f7a4947a68fef30b467f100d6-1"></a><span class="gp">$</span> docker system prune <span class="o">[</span>options<span class="o">]</span>
</pre>
</div>
</div>
<div class="section" id="docker-container-stats">
<h3><a class="toc-backref" href="#id68">2.4.2 docker container stats --- 利用状況の取得</a></h3>
<p>コンテナ単位でシステムリソースの利用状況を取得する。</p>
<pre class="code console"><a name="rest_code_a08287217685435bb0f81d1c5dca1c1e-1"></a><span class="gp">$</span> docker container stats <span class="o">[</span>options<span class="o">]</span> <span class="o">[</span>表示するコンテナID...<span class="o">]</span>
</pre>
<ul class="simple">
<li>実行例</li>
</ul>
<pre class="code console"><a name="rest_code_041f44791ded4b07b1047e00d0c74161-1"></a><span class="gp">$</span> docker container stats
<a name="rest_code_041f44791ded4b07b1047e00d0c74161-2"></a><span class="go">CONTAINER ID        NAME                CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS</span>
<a name="rest_code_041f44791ded4b07b1047e00d0c74161-3"></a><span class="go">81e3a724ae7c        fumi23              0.00%               8.012MiB / 1.952GiB   0.40%               19.1kB / 0B         1.21MB / 8.19kB     17</span>
</pre>
</div>
</div>
<div class="section" id="docker-compose">
<h2><a class="toc-backref" href="#id69">2.5 Docker Compose でマルチコンテナを実行する</a></h2>
<ul class="simple">
<li>Docker コンテナ = 単一のアプリケーションと言い換えることができる</li>
<li>仮想サーバとっは対象とする粒度が異なる</li>
<li>複数存在するコンテナ同士が通信し、かつ、コンテナがコンテナの依存関係を持つはず<ul>
<li>コンテナの挙動を制御するための設定ファイルや環境変数の与え方</li>
<li>コンテナ同士の依存関係</li>
<li>ポートフォワーディング</li>
</ul>
</li>
</ul>
<div class="section" id="id22">
<h3><a class="toc-backref" href="#id70">2.5.1 docker-compose によるコンテナの実行</a></h3>
<p>Compose: yaml 形式の設定ファイルで、複数のコンテナ実行を一括で管理できる。</p>
<ul class="simple">
<li>Docker コマンドで行なっていたコンテナの実行構成を設定ファイルで管理できるようになる</li>
</ul>
<div class="section" id="id23">
<h4><a class="toc-backref" href="#id71">使えるかどうか確認する</a></h4>
<pre class="code console"><a name="rest_code_0ab45e13273d4b38924387c1319f5f9a-1"></a><span class="gp">$</span> docker-compose version
<a name="rest_code_0ab45e13273d4b38924387c1319f5f9a-2"></a><span class="go">docker-compose version 1.22.0, build f46880f</span>
<a name="rest_code_0ab45e13273d4b38924387c1319f5f9a-3"></a><span class="go">docker-py version: 3.4.1</span>
<a name="rest_code_0ab45e13273d4b38924387c1319f5f9a-4"></a><span class="go">CPython version: 3.6.4</span>
<a name="rest_code_0ab45e13273d4b38924387c1319f5f9a-5"></a><span class="go">OpenSSL version: OpenSSL 1.0.2o  27 Mar 2018</span>
</pre>
</div>
<div class="section" id="id24">
<h4><a class="toc-backref" href="#id72">docker-compose でコンテナを実行する</a></h4>
<ol class="arabic">
<li>
<p class="first">docker-compose.yml を用意する。</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-1"></a><span class="c1"># ===========================================================</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-2"></a><span class="c1"># $ docker container run -d -p 9000:8080 example/echo:latest</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-3"></a><span class="c1"># と同等の振る舞いを docker-compose で定義する</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-4"></a><span class="c1"># ===========================================================</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-5"></a><span class="c1"># docker-compose.yml ファイルフォーマットのバージョンを宣言</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-6"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-7"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-8"></a>  <span class="nt">echo</span><span class="p">:</span>  <span class="c1"># コンテナの名前の定義</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-9"></a>    <span class="c1"># ここから下は実行するコンテナの定義</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-10"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">example/echo:latest</span>  <span class="c1"># 使用する Docker イメージ</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-11"></a>    <span class="nt">ports</span><span class="p">:</span>                      <span class="c1"># ポートフォワーディングを指定</span>
<a name="rest_code_5ab9f0ff2e574b60a89533f01ec248cb-12"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:8080</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">docker-compose.yml を作成したディレクトリで実行する。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-1"></a><span class="c1"># コンテナ群を実行する</span>
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-2"></a>$ docker-compose up -d
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-3"></a>Creating work_echo_1 ... <span class="k">done</span>
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-4"></a>
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-5"></a><span class="c1"># 実行中のコンテナを一覧表示する</span>
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-6"></a>$ docker container ls
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-7"></a>CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-8"></a>6287a2890ccb        example/echo:latest   <span class="s2">"go run /echo/main.go"</span>   <span class="m">8</span> seconds ago       Up <span class="m">8</span> seconds        <span class="m">0</span>.0.0.0:9000-&gt;8080/tcp    work_echo_1
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-9"></a>81e3a724ae7c        example/echo:latest   <span class="s2">"go run /echo/main.go"</span>   <span class="m">6</span> days ago          Up <span class="m">6</span> days           <span class="m">0</span>.0.0.0:32768-&gt;8080/tcp   fumi23
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-10"></a>
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-11"></a><span class="c1"># コンテナを停止・削除する</span>
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-12"></a>$ docker-compose down
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-13"></a>Stopping work_echo_1 ... <span class="k">done</span>
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-14"></a>Removing work_echo_1 ... <span class="k">done</span>
<a name="rest_code_bdbaa0a616b647eba53b6702e3b5025a-15"></a>Removing network work_default
</pre>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="docker-compose-docker">
<h4><a class="toc-backref" href="#id73">docker-compose で Docker イメージをビルドして、そのまま実行する</a></h4>
<ol class="arabic">
<li>
<p class="first">docker-compose.yml を用意する。</p>
<blockquote>
<pre class="code yaml"><a name="rest_code_3922c01704fa4599b249656311476ac3-1"></a><span class="c1"># ===========================================================</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-2"></a><span class="c1"># docker-compose で、イメージのビルドと実行を一緒にやる</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-3"></a><span class="c1"># ===========================================================</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-4"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-5"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-6"></a>  <span class="nt">echo</span><span class="p">:</span>  <span class="c1"># コンテナの名前の定義</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-7"></a>    <span class="c1"># ここ↓から実行するコンテナの定義</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-8"></a>    <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>                    <span class="c1"># Dockerfile が存在するディレクトリの相対パスを指定する</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-9"></a>    <span class="nt">ports</span><span class="p">:</span>                      <span class="c1"># ポートフォワーディングを指定する</span>
<a name="rest_code_3922c01704fa4599b249656311476ac3-10"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:8080</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">docker-compose.yml があるディレクトリで実行する。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_74aee8812e824faeb2366c545c3daf06-1"></a><span class="c1"># コンテナ群を実行する</span>
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-2"></a><span class="c1"># --build: up 時に Docker イメージを必ずビルドするオプション</span>
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-3"></a>$ docker-compose up -d --build
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-4"></a>Creating network <span class="s2">"echo_default"</span> with the default driver
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-5"></a>Building <span class="nb">echo</span>
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-6"></a>Step <span class="m">1</span>/4 : FROM golang:1.9
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-7"></a> ---&gt; ef89ef5c42a9
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-8"></a>Step <span class="m">2</span>/4 : RUN mkdir /echo
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-9"></a> ---&gt; Using cache
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-10"></a> ---&gt; 7caf124fb4d3
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-11"></a>Step <span class="m">3</span>/4 : COPY main.go /echo
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-12"></a> ---&gt; 15b6deaeb7ce
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-13"></a>Step <span class="m">4</span>/4 : CMD <span class="o">[</span><span class="s2">"go"</span>, <span class="s2">"run"</span>, <span class="s2">"/echo/main.go"</span><span class="o">]</span>
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-14"></a> ---&gt; Running in a9b3b311fdc9
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-15"></a>Removing intermediate container a9b3b311fdc9
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-16"></a> ---&gt; 291b78994229
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-17"></a>Successfully built 291b78994229
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-18"></a>Successfully tagged echo_echo:latest
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-19"></a>Creating echo_echo_1 ... <span class="k">done</span>
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-20"></a>
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-21"></a><span class="c1"># 起動したことを確認する</span>
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-22"></a>$ docker container ls
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-23"></a>CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-24"></a>6f0571015a21        echo_echo             <span class="s2">"go run /echo/main.go"</span>   <span class="m">39</span> seconds ago      Up <span class="m">38</span> seconds       <span class="m">0</span>.0.0.0:9000-&gt;8080/tcp    echo_echo_1
<a name="rest_code_74aee8812e824faeb2366c545c3daf06-25"></a>81e3a724ae7c        example/echo:latest   <span class="s2">"go run /echo/main.go"</span>   <span class="m">6</span> days ago          Up <span class="m">6</span> days           <span class="m">0</span>.0.0.0:32768-&gt;8080/tcp   fumi23
</pre>
</blockquote>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="compose">
<h2><a class="toc-backref" href="#id74">2.6 Compose による複数コンテナの実行</a></h2>
<div class="section" id="jenkins">
<h3><a class="toc-backref" href="#id75">2.6.1 Jenkins コンテナを実行する</a></h3>
<ol class="arabic">
<li>
<p class="first"><tt class="docutils literal"><span class="pre">docker-compose.yml</span></tt></p>
<blockquote>
<pre class="code yaml"><a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-1"></a><span class="c1"># ================================</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-2"></a><span class="c1"># 2.6.1 Jenkins コンテナを実行する</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-3"></a><span class="c1"># ================================</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-4"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-5"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-6"></a>  <span class="nt">master</span><span class="p">:</span>  <span class="c1"># コンテナの名前</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-7"></a>    <span class="c1"># 実行するコンテナの定義</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-8"></a>    <span class="c1"># ======================</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-9"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-10"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins:latest</span>      <span class="c1"># Docker Hub に登録されている Jenkins の公式イメージを利用する</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-11"></a>    <span class="nt">ports</span><span class="p">:</span>                      <span class="c1"># ポートフォワーディングを指定する</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-12"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:8080</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-13"></a>    <span class="nt">volumes</span><span class="p">:</span>                    <span class="c1"># ホスト・コンテナ間でファイルを共有する仕組み</span>
<a name="rest_code_f21a573e051c464fa7dbba5439aa3ce4-14"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./jenkins_home:/var/jenkins_home</span>    <span class="c1"># ホストの `./jenkins_home` に、Jenkins コンテナの `/var/jenkins_home` をマウント</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">Compose で実行する。</p>
<blockquote>
<pre class="code bash"><a name="rest_code_3a36e959272a44fcb38d6f3c076a8795-1"></a><span class="c1"># docker-compose.yml のあるディレクトリで実行する</span>
<a name="rest_code_3a36e959272a44fcb38d6f3c076a8795-2"></a>$ docker-compose up
</pre>
</blockquote>
</li>
<li>
<p class="first"><tt class="docutils literal"><span class="pre">http://localhost:9000/</span></tt> にアクセスして Jenkins の初期設定をする。</p>
</li>
</ol>
</div>
<div class="section" id="master-jenkins-ssh">
<h3><a class="toc-backref" href="#id76">2.6.2 Master Jenkins の SSH 鍵を作る</a></h3>
<pre class="code bash"><a name="rest_code_61e3a534e8324e05807794752bfdad8d-1"></a>$ docker container <span class="nb">exec</span> -it master ssh-keygen -t rsa -C <span class="s2">""</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-2"></a>Generating public/private rsa key pair.
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-3"></a>Enter file in which to save the key <span class="o">(</span>/var/jenkins_home/.ssh/id_rsa<span class="o">)</span>:
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-4"></a>Created directory <span class="s1">'/var/jenkins_home/.ssh'</span>.
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-5"></a>Enter passphrase <span class="o">(</span>empty <span class="k">for</span> no passphrase<span class="o">)</span>:
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-6"></a>Enter same passphrase again:
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-7"></a>Your identification has been saved in /var/jenkins_home/.ssh/id_rsa.
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-8"></a>Your public key has been saved in /var/jenkins_home/.ssh/id_rsa.pub.
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-9"></a>The key fingerprint is:
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-10"></a>SHA256:Ee3KESkiYjH4QoZBZqPie9PH5rZ9GsVBfUaUAuXwXaY
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-11"></a>The key<span class="err">'</span>s randomart image is:
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-12"></a>+---<span class="o">[</span>RSA <span class="m">2048</span><span class="o">]</span>----+
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-13"></a><span class="p">|</span><span class="o">=</span>O.     .o ++.oo+<span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-14"></a><span class="p">|</span>B++ . . o.o +o.*.<span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-15"></a><span class="p">|</span>*o . . ..o . oE. <span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-16"></a><span class="p">|</span>+ .     ..o .    <span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-17"></a><span class="p">|</span> o     .So o     <span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-18"></a><span class="p">|</span>  . . . o .      <span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-19"></a><span class="p">|</span> . o . + .       <span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-20"></a><span class="p">|</span>  . . +.. ..     <span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-21"></a><span class="p">|</span>      .o.oo      <span class="p">|</span>
<a name="rest_code_61e3a534e8324e05807794752bfdad8d-22"></a>+----<span class="o">[</span>SHA256<span class="o">]</span>-----+
</pre>
</div>
<div class="section" id="jenkins-slave">
<h3><a class="toc-backref" href="#id77">2.6.3 Jenkins Slave コンテナを作る</a></h3>
<ol class="arabic">
<li>
<p class="first"><tt class="docutils literal"><span class="pre">docker-compose.yml</span></tt></p>
<blockquote>
<pre class="code yaml"><a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-1"></a><span class="c1"># ===================================</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-2"></a><span class="c1"># 2.6.3 Jenkins Slave コンテナを作る</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-3"></a><span class="c1"># ===================================</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-4"></a><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-5"></a><span class="nt">services</span><span class="p">:</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-6"></a>  <span class="c1"># Master コンテナ</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-7"></a>  <span class="nt">master</span><span class="p">:</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-8"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-9"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins:latest</span>       <span class="c1"># Docker Hub に登録されている Jenkins の公式イメージを利用する</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-10"></a>    <span class="nt">ports</span><span class="p">:</span>                      <span class="c1"># ポートフォワーディングを指定する</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-11"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:8080</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-12"></a>    <span class="nt">volumes</span><span class="p">:</span>                    <span class="c1"># ホスト・コンテナ間でファイルを共有する仕組み</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-13"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./jenkins_home:/var/jenkins_home</span>    <span class="c1"># ホストの `./jenkins_home` に、Jenkins コンテナの `/var/jenkins_home` をマウント</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-14"></a>    <span class="nt">links</span><span class="p">:</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-15"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">slave01</span>                 <span class="c1"># これで、 master から slave01 で名前解決できるようになる</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-16"></a>    <span class="c1"># pw: bb91ef8ec2e74cc3a99802a79a84df6b</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-17"></a>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-18"></a>  <span class="c1"># Slave コンテナ</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-19"></a>  <span class="nt">slave01</span><span class="p">:</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-20"></a>    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">slave01</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-21"></a>    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkinsci/ssh-slave</span>    <span class="c1"># SSH 接続する Slave 用途の Docker イメージを利用する</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-22"></a>    <span class="nt">environment</span><span class="p">:</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-23"></a>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JENKINS_SLAVE_SSH_PUBKEY=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCd2Nn7oT9F9JoWCWuTyjkmADAMrNZzZGCBZjT118QD3518CsaTlLmE8ikqloO9rCi58Vgi9nBhSJ0SGGG+Vx8mBZlG5V/ucq3TlbHq9Epdr8mJAaJ44F3CWNso97WIBzDEdtCAYQPRO1kEjlGBOr2JAAkYPyNEDe9o2Ta02FzqLu4WpqmqopgS6xsDWqj3BfQoJ+MCLeej865zSETyFojz8BbYH03LMhzBUeb6Yfa9LtIJgpp0KMab9p3hKlV5Es6jIVhYlVBw2NokWkOaq7KjlwTj0pmUGYIBNpgg+POpkaMt42dVNiqYxvbEzz9ZaejM3T/DIORIhKtYnnANwN4b</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-24"></a>      <span class="c1"># ↑これで Master からの SSH 接続が許可された状態になる</span>
<a name="rest_code_5a0bc7a1b1df4218ad483dcfb585f1f2-25"></a>      <span class="c1"># Slave コンテナの `~/.ssh/authorized_keys ` ファイルに Master コンテナの SSH 公開鍵が追加される。</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">Compose で実行する。</p>
<blockquote>
<pre class="code console"><a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-1"></a><span class="gp">$</span> docker-compose up -d
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-2"></a><span class="go">Creating slave01 ... done</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-3"></a><span class="go">Creating master  ... done</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-4"></a><span class="gp">$</span> docker-compose ps
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-5"></a><span class="go"> Name                Command               State                 Ports</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-6"></a><span class="go">------------------------------------------------------------------------------------</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-7"></a><span class="go">master    /bin/tini -- /usr/local/bi ...   Up      50000/tcp, 0.0.0.0:9000-&gt;8080/tcp</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-8"></a><span class="go">slave01   setup-sshd                       Up      22/tcp</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-9"></a><span class="go">(venv) FumienoMacBook-Pro:2.6.1 fumi23$ docker container ls -a</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-10"></a><span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS                    PORTS                               NAMES</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-11"></a><span class="go">91ede878960a        jenkins:latest        "/bin/tini -- /usr/l…"   42 minutes ago      Up 42 minutes             50000/tcp, 0.0.0.0:9000-&gt;8080/tcp   master</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-12"></a><span class="go">5fc916903044        jenkinsci/ssh-slave   "setup-sshd"             42 minutes ago      Up 42 minutes             22/tcp                              slave01</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-13"></a><span class="go">6f0571015a21        echo_echo             "go run /echo/main.go"   6 days ago          Exited (2) 15 hours ago                                       echo_echo_1</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-14"></a><span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   12 days ago         Exited (2) 15 hours ago                                       fumi23</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-15"></a><span class="gp">$</span> docker container <span class="nb">exec</span> master ls /usr/share/jenkins
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-16"></a><span class="go">jenkins.war</span>
<a name="rest_code_81bd3c40bf19421493f36e1ea26cc060-17"></a><span class="go">ref</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">Jenkins のバージョンが古く、SSH Slaves plugin が使えなかったので、 Docker コンテナ内の Jenkins をバージョンアップする。</p>
<blockquote>
<pre class="code console"><a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-1"></a><span class="gp">$</span> docker container <span class="nb">exec</span> -u <span class="m">0</span> -it master bash
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-2"></a><span class="gp">root@91ede878960a:/#</span> wget http://updates.jenkins-ci.org/download/war/2.138.3/jenkins.war
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-3"></a><span class="go">--2018-11-18 06:21:47--  http://updates.jenkins-ci.org/download/war/2.138.3/jenkins.war</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-4"></a><span class="go">Resolving updates.jenkins-ci.org (updates.jenkins-ci.org)... 52.202.51.185</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-5"></a><span class="go">Connecting to updates.jenkins-ci.org (updates.jenkins-ci.org)|52.202.51.185|:80... connected.</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-6"></a><span class="go">HTTP request sent, awaiting response... 302 Found</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-7"></a><span class="go">Location: http://mirrors.jenkins-ci.org/war-stable/2.138.3/jenkins.war [following]</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-8"></a><span class="go">--2018-11-18 06:21:47--  http://mirrors.jenkins-ci.org/war-stable/2.138.3/jenkins.war</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-9"></a><span class="go">Resolving mirrors.jenkins-ci.org (mirrors.jenkins-ci.org)... 52.202.51.185</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-10"></a><span class="go">Reusing existing connection to updates.jenkins-ci.org:80.</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-11"></a><span class="go">HTTP request sent, awaiting response... 302 Found</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-12"></a><span class="go">Location: http://ftp.yz.yamagata-u.ac.jp/pub/misc/jenkins/war-stable/2.138.3/jenkins.war [following]</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-13"></a><span class="go">--2018-11-18 06:21:48--  http://ftp.yz.yamagata-u.ac.jp/pub/misc/jenkins/war-stable/2.138.3/jenkins.war</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-14"></a><span class="go">Resolving ftp.yz.yamagata-u.ac.jp (ftp.yz.yamagata-u.ac.jp)... 133.24.248.18, 133.24.248.16, 133.24.248.19, ...</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-15"></a><span class="go">Connecting to ftp.yz.yamagata-u.ac.jp (ftp.yz.yamagata-u.ac.jp)|133.24.248.18|:80... connected.</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-16"></a><span class="go">HTTP request sent, awaiting response... 200 OK</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-17"></a><span class="go">Length: 75733340 (72M)</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-18"></a><span class="go">Saving to: ‘jenkins.war’</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-19"></a>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-20"></a><span class="go">jenkins.war                                        100%[===============================================================================================================&gt;]  72.22M  3.97MB/s    in 14s</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-21"></a>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-22"></a><span class="go">2018-11-18 06:22:01 (5.30 MB/s) - ‘jenkins.war’ saved [75733340/75733340]</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-23"></a>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-24"></a><span class="gp">root@91ede878960a:/#</span> ls -la
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-25"></a><span class="go">total 74032</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-26"></a><span class="go">drwxr-xr-x   1 root root     4096 Nov 18 06:21 .</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-27"></a><span class="go">drwxr-xr-x   1 root root     4096 Nov 18 06:21 ..</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-28"></a><span class="go">-rwxr-xr-x   1 root root        0 Nov 18 05:03 .dockerenv</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-29"></a><span class="go">drwxr-xr-x   1 root root     4096 Jul 17 16:20 bin</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-30"></a><span class="go">drwxr-xr-x   2 root root     4096 Jun 26 12:03 boot</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-31"></a><span class="go">drwxr-xr-x   5 root root      340 Nov 18 05:03 dev</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-32"></a><span class="go">lrwxrwxrwx   1 root root       33 Jul 17 06:16 docker-java-home -&gt; /usr/lib/jvm/java-8-openjdk-amd64</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-33"></a><span class="go">drwxr-xr-x   1 root root     4096 Nov 18 05:03 etc</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-34"></a><span class="go">drwxr-xr-x   2 root root     4096 Jun 26 12:03 home</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-35"></a><span class="go">-rw-r--r--   1 root root 75733340 Nov  9 01:03 jenkins.war</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-36"></a><span class="go">drwxr-xr-x   1 root root     4096 Jul 16 00:00 lib</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-37"></a><span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 lib64</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-38"></a><span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 media</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-39"></a><span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 mnt</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-40"></a><span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 opt</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-41"></a><span class="go">dr-xr-xr-x 187 root root        0 Nov 18 05:03 proc</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-42"></a><span class="go">drwx------   2 root root     4096 Jul 16 00:00 root</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-43"></a><span class="go">drwxr-xr-x   3 root root     4096 Jul 16 00:00 run</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-44"></a><span class="go">drwxr-xr-x   1 root root     4096 Jul 17 03:13 sbin</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-45"></a><span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 srv</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-46"></a><span class="go">dr-xr-xr-x  13 root root        0 Nov 18 05:03 sys</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-47"></a><span class="go">drwxrwxrwt   1 root root     4096 Nov 18 05:04 tmp</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-48"></a><span class="go">drwxr-xr-x   1 root root     4096 Jul 16 00:00 usr</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-49"></a><span class="go">drwxr-xr-x   1 root root     4096 Jul 17 16:20 var</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-50"></a><span class="gp">root@91ede878960a:/#</span> mv ./jenkins.war /usr/share/jenkins
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-51"></a><span class="gp">root@91ede878960a:/#</span> chown jenkins:jenkins /usr/share/jenkins/jenkins.war
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-52"></a><span class="gp">root@91ede878960a:/#</span> <span class="nb">exit</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-53"></a><span class="go">exit</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-54"></a><span class="gp">$</span> docker-compose restart
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-55"></a><span class="go">Restarting master  ... done</span>
<a name="rest_code_0b35eee6b4a3488cb7f7448ed04fe106-56"></a><span class="go">Restarting slave01 ... done</span>
</pre>
</blockquote>
</li>
<li>
<p class="first"><tt class="docutils literal">slave01</tt> ノードを追加して、 SSH の設定をする。</p>
</li>
</ol>
<div class="section" id="id25">
<h4><a class="toc-backref" href="#id78">参考サイト</a></h4>
<p>ありがとうございました!!</p>
<ul class="simple">
<li><a class="reference external" href="https://medium.com/@jimkang/how-to-start-a-new-jenkins-container-and-update-jenkins-with-docker-cf628aa495e9">https://medium.com/@jimkang/how-to-start-a-new-jenkins-container-and-update-jenkins-with-docker-cf628aa495e9</a></li>
</ul>
</div>
</div>
</div>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>
</html>
