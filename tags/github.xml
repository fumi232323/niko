<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ふみのて (Posts about github)</title><link>https://32imuf.com/</link><description></description><atom:link href="https://32imuf.com/tags/github.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><copyright>Contents © 2021 &lt;a href="mailto:fumi232323fumi2016@gmail.com"&gt;fumi23&lt;/a&gt; </copyright><lastBuildDate>Mon, 20 Sep 2021 14:44:38 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>GitHub Actions で deploy 時に changelog を生成してタグを打ちたい</title><link>https://32imuf.com/github/actions/changelog-tag-deploy/</link><dc:creator>fumi23</dc:creator><description>&lt;div&gt;&lt;details&gt;
  &lt;summary&gt;目次&lt;/summary&gt;&lt;div class="contents topic" id="contents"&gt;
&lt;p class="topic-title first"&gt;Contents&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id1" id="id18"&gt;リファレンス・ガイド&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#github-actions" id="id19"&gt;GitHub Actions&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#actions" id="id20"&gt;ワークフロー中で使った Actions&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#case1-push-tag" id="id21"&gt;Case1: 直接 push する、 tag は手動トリガー時に入力できる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id3" id="id22"&gt;条件&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#workflow" id="id23"&gt;workflow&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#case2-push-tag-protected-branch" id="id24"&gt;Case2: 直接 push する、 tag は手動トリガー時に入力できる (ちょっとだけ protected branch)&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id5" id="id25"&gt;条件&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id6" id="id26"&gt;workflow&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id9" id="id27"&gt;ちなみに&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#case3-protected-branch-pr-tag-auto-bump-changelog-tag" id="id28"&gt;Case3: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがずれる)&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id10" id="id29"&gt;条件&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id13" id="id30"&gt;workflow&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#note" id="id31"&gt;Note&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#case4-protected-branch-pr-tag-auto-bump-changelog-tag" id="id32"&gt;Case4: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがいっしょ!)&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id14" id="id33"&gt;条件&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id15" id="id34"&gt;workflow&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#changelog-next-tag" id="id35"&gt;1. changelog 生成, next tag 払い出し&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#tag-deploy" id="id36"&gt;2. tag 打ちして deploy&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference internal" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id16" id="id37"&gt;その他&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/details&gt;&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id18"&gt;リファレンス・ガイド&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="github-actions"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id19"&gt;GitHub Actions&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/actions/reference/workflow-syntax-for-github-actions"&gt;GitHub Actionsのワークフロー構文&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="actions"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id20"&gt;ワークフロー中で使った Actions&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;Checkout V2: &lt;a class="reference external" href="https://github.com/actions/checkout"&gt;https://github.com/actions/checkout&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;git-auto-commit Action: &lt;a class="reference external" href="https://github.com/stefanzweifel/git-auto-commit-action"&gt;https://github.com/stefanzweifel/git-auto-commit-action&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GitHub Tag Action: &lt;a class="reference external" href="https://github.com/mathieudutour/github-tag-action"&gt;https://github.com/mathieudutour/github-tag-action&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Create Pull Request: &lt;a class="reference external" href="https://github.com/peter-evans/create-pull-request"&gt;https://github.com/peter-evans/create-pull-request&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Enable Pull Request Auto-merge: &lt;a class="reference external" href="https://github.com/peter-evans/enable-pull-request-automerge"&gt;https://github.com/peter-evans/enable-pull-request-automerge&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;approve-pull-request-action: &lt;a class="reference external" href="https://github.com/juliangruber/approve-pull-request-action"&gt;https://github.com/juliangruber/approve-pull-request-action&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="case1-push-tag"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id21"&gt;Case1: 直接 push する、 tag は手動トリガー時に入力できる&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id3"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id22"&gt;条件&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;private repository&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog push 対象のブランチに、 Branch protection rules の適用なし&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="workflow"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id23"&gt;workflow&lt;/a&gt;&lt;/h3&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;ブランチを選択・タグ名を入力して、 &lt;code class="docutils literal"&gt;Run workflow&lt;/code&gt; (手動トリガー)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を生成&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ワークフローをトリガーしたブランチに、 changelog を commit &amp;amp; push&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog の commit に、入力したタグ名でタグ打ち&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;deploy&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/actions/managing-workflow-runs/manually-running-a-workflow"&gt;ワークフローの手動実行&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-1"&gt;&lt;/a&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy (Case1)&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-2"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-3"&gt;&lt;/a&gt;&lt;span class="nt"&gt;on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-4"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;workflow_dispatch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-5"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# 手動トリガー&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-6"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;inputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-7"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;tag-name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-8"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ここで入力したタグ名でタグを打つ&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-9"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;description&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Enter&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;tag&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;name&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;(e.g.&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;v1.2.3)'&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-10"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;required&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-11"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-12"&gt;&lt;/a&gt;&lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-13"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# 必要な環境変数を定義する&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-14"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# ここで定義した env はすべての job から参照できる&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-15"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;AWS_REGION&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ap-northeast-1&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-16"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# (以下省略)&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-17"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-18"&gt;&lt;/a&gt;&lt;span class="nt"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-19"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-20"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bash&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-21"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-22"&gt;&lt;/a&gt;&lt;span class="nt"&gt;jobs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-23"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-24"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;changelog&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-25"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG and create new tag&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-26"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-27"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;outputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-28"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# job の outputs として tag を打った (changelog を commit した) コミットの hash (SHA) を設定&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-29"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;tagged-sha&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.push-changelog-tag.outputs.commit_hash }}&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-30"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-31"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-32"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-33"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-34"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-35"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Build services&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-36"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-37"&gt;&lt;/a&gt;          &lt;span class="no"&gt;cp example.env .env&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-38"&gt;&lt;/a&gt;          &lt;span class="no"&gt;docker-compose build --parallel&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-39"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-40"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;1&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-41"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-42"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-43"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# root ユーザーで実行する&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-44"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# root で実行しないと、 towncrier が見たい dir の参照権限がなかったりして、fail する&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-45"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose run -u 0 --rm djangoapp towncrier --yes&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-46"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-47"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Stop and remove containers, networks and volumes&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-48"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose down -v&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-49"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;always()&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-50"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-51"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Restore git dir owner and group&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-52"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# CHANGELOG は root:root で作成される&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-53"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# そのままだと git-auto-commit-action に失敗することがあるため元に戻す&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-54"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ※これは正しい解決策なのか否かちょっと自信なし&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-55"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;sudo chown -R runner:docker .git/objects/&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-56"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-57"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Commit, push CHANGELOG and create new tag&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-58"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;push-changelog-tag&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-59"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;stefanzweifel/git-auto-commit-action@v4&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-60"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-61"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;commit_message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Updated CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-62"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 手動トリガーで受け取ったタグ名でタグを打つ&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-63"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 手動トリガー時に受け取った inputs はこんな風に参照できる&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-64"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;tagging_message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.event.inputs.tag-name }}&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-65"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-66"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;deploy&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-67"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-68"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-69"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# changelog job が正常終了したらこの job を実行する (直列で実行する)&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-70"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# needs を指定しないと並列実行される&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-71"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;needs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-72"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;changelog&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-73"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-74"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-75"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-76"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-77"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-78"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# すべての tag も fetch する&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-79"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# これをつけないと (デフォルトだと) 、ワークフローをトリガーした ref/SHA のコミットひとつだけが fetch される&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-80"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;fetch-depth&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;0&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-81"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# changelog job で tag を打った (changelog を commit した) コミットをチェックアウトする&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-82"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# ※ changelog + tag のコミットを deploy したいため&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-83"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# needs に指定した job の outputs はこんな風に参照できる&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-84"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;ref&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ needs.changelog.outputs.tagged_hash }}&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-85"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-86"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Set tagged sha&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-87"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set-tag-sha&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-88"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# [確認用] チェックアウトしたブランチの最新の commit を取得&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-89"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-90"&gt;&lt;/a&gt;          &lt;span class="no"&gt;TAGGED_SHA=$(git log -1 --format='%H')&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-91"&gt;&lt;/a&gt;          &lt;span class="no"&gt;echo $TAGGED_SHA&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-92"&gt;&lt;/a&gt;          &lt;span class="no"&gt;echo "::set-output name=tag-sha::$TAGGED_SHA"&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-93"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-94"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-ref&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-95"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.ref }}"&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-96"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-sha&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-97"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーしたときの SHA&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-98"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.sha }}"&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-99"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo changelog-tagged_hash&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-100"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# changelog job で tag を打った SHA&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-101"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# このワークフロー中で commit したので、 github.sha より一つ進んでいる&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-102"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ needs.changelog.outputs.tagged_hash }}"&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-103"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo tag-sha&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-104"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# チェックアウトしたブランチの最新の commit の SHA&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-105"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# == changelog-tagged_hash&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-106"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ steps.set-tag-sha.outputs.tag-sha }}"&lt;/span&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-107"&gt;&lt;/a&gt;
&lt;a name="rest_code_f891ca1163b8490f81c4702d71e4a56a-108"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# あとは deploy する (省略)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="case2-push-tag-protected-branch"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id24"&gt;Case2: 直接 push する、 tag は手動トリガー時に入力できる (ちょっとだけ protected branch)&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id5"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id25"&gt;条件&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;private repository&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog push 対象のブランチに、 Branch protection rules の適用あり&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Require pull request reviews before merging: OFF&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Require status checks to pass before merging: ON&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Include administrators: OFF&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id26"&gt;workflow&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Case1 と同じ&lt;/p&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_624db9a2f80e497b908c2bb1a1e7e574-1"&gt;&lt;/a&gt;&lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_624db9a2f80e497b908c2bb1a1e7e574-2"&gt;&lt;/a&gt;  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_624db9a2f80e497b908c2bb1a1e7e574-3"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_624db9a2f80e497b908c2bb1a1e7e574-4"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# ここだけ変える&lt;/span&gt;
&lt;a name="rest_code_624db9a2f80e497b908c2bb1a1e7e574-5"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_624db9a2f80e497b908c2bb1a1e7e574-6"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# 管理者権限を持つユーザーで repo scope の PAT を作成し、&lt;/span&gt;
&lt;a name="rest_code_624db9a2f80e497b908c2bb1a1e7e574-7"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# GitHub Actions の secrets に登録しておく&lt;/span&gt;
&lt;a name="rest_code_624db9a2f80e497b908c2bb1a1e7e574-8"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.REPO_SCOPED_PAT }}&lt;/span&gt;
&lt;/pre&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token"&gt;個人アクセストークンを使用する&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/actions/reference/encrypted-secrets"&gt;暗号化されたシークレット&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="id9"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id27"&gt;ちなみに&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Branch protection rules のうち、以下のいずれかもしくは両方が &lt;code class="docutils literal"&gt;ON&lt;/code&gt; の場合は NG です。
workflow は fail します (changelog の push に失敗する) 。&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;Require pull request reviews before merging&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;自分のローカルから push するときは、これ ON でも Include administrators が OFF なら push できるんだけれども、
なにか、PAT の権限足すといけるのかもしれない (けれどあまり強権限持たせたくない..)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;それに、管理者だからって、自分の頭で気をつけるんじゃなくて GitHub に助けて (チェックして) もらいたい...&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Include administrators&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="case3-protected-branch-pr-tag-auto-bump-changelog-tag"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id28"&gt;Case3: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがずれる)&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id10"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id29"&gt;条件&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;private repository&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog push 対象のブランチに、 Branch protection rules の適用あり&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Require pull request reviews before merging: ON&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Require status checks to pass before merging: ON (今回の場合は、以下の3つを指定)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ci (自分のところで用意している CI)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;push イベントで起動 (branch は特に絞り込んでいません)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://github.com/marketplace/task-list-completed"&gt;task-list-completed&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://github.com/marketplace/actions/wip"&gt;WIP&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Include administrators: ON&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;リポジトリ内のプルリクエストの自動マージを許可: ON&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/github/administering-a-repository/configuring-pull-request-merges/managing-auto-merge-for-pull-requests-in-your-repository"&gt;リポジトリ内のプルリクエストの自動マージを管理する&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/github/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request"&gt;プルリクエストを自動的にマージする&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id13"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id30"&gt;workflow&lt;/a&gt;&lt;/h3&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;ブランチを選択して、 &lt;code class="docutils literal"&gt;Run workflow&lt;/code&gt; (手動トリガー)&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;タグ version の bump up は自動でやってくれるので、通常の実行時はタグ名を指定しない&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;デフォルトが &lt;code class="docutils literal"&gt;Patch&lt;/code&gt; になっているので、 &lt;code class="docutils literal"&gt;Minor&lt;/code&gt; or &lt;code class="docutils literal"&gt;Major&lt;/code&gt; の version を bump up したいときは、 &lt;code class="docutils literal"&gt;custom_tag&lt;/code&gt; を指定する&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ちょっとまだどんな風に version up していくか見えていないので&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を生成&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ワークフローをトリガーしたコミットにタグ打ち (タグのバージョンは自動 bump up)&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;changelog の PR が merge されるのをワークフロー中で待てないので、&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;あきらめて「ワークフローをトリガーしたコミット」にタグを打つ。&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog のコミットは、「タグを打ったコミット」より後の別のコミットになる。&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を PR&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog の PR の自動マージを有効化&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を PR を自動 approve&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;deploy&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-1"&gt;&lt;/a&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy (Case3)&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-2"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-3"&gt;&lt;/a&gt;&lt;span class="nt"&gt;on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-4"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;workflow_dispatch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-5"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;inputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-6"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;custom_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-7"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;description&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'メジャー/マイナーバージョンをインクリメントしたいときのみ指定してください&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;(e.g.&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;1.2.0)'&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-8"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-9"&gt;&lt;/a&gt;&lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-10"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;AWS_REGION&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ap-northeast-1&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-11"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# (以下省略)&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-12"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-13"&gt;&lt;/a&gt;&lt;span class="nt"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-14"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-15"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bash&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-16"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-17"&gt;&lt;/a&gt;&lt;span class="nt"&gt;jobs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-18"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-19"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;changelog&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-20"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG and create new tag&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-21"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-22"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;outputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-23"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# changelog job の outputs として version を bump したタグ名設定&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-24"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;new_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.create-tag.outputs.new_tag }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-25"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-26"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-27"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-28"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-29"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-30"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Build services&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-31"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-32"&gt;&lt;/a&gt;          &lt;span class="no"&gt;cp example.env .env&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-33"&gt;&lt;/a&gt;          &lt;span class="no"&gt;docker-compose build --parallel&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-34"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-35"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;1&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-36"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-37"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-38"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose run -u 0 --rm djangoapp towncrier --yes&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-39"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-40"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Stop and remove containers, networks and volumes&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-41"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose down -v&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-42"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;always()&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-43"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-44"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Bump version and push tag&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-45"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# changelog の PR が merge されるのをワークフロー中で待てないので、&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-46"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# あきらめて「ワークフローをトリガーしたコミット」にタグを打つ。&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-47"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# changelog のコミットは、「タグを打ったコミット」より後の別のコミットになる。&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-48"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;create-tag&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-49"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;mathieudutour/github-tag-action@v5.6&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-50"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# main 以外のブランチで実行した場合は `v1.2.3-{branch_name}.0` のようなタグがつくため、&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-51"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# main ブランチの bump には影響しない。&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-52"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ※ custom_tag に、 main ブランチのタグと同じ形式のタグ名を指定すると影響する&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-53"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-54"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# secrets.GITHUB_TOKEN は github.token と同義だそうです&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-55"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;github_token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-56"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 手動トリガー時に custom_tag を受け取った場合は、&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-57"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 受け取ったタグ名でタグを打つ&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-58"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;custom_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.event.inputs.custom_tag }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-59"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-60"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Create Pull Request&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-61"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;cpr&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-62"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;peter-evans/create-pull-request@v3&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-63"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-64"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;TAG_MAME&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.create-tag.outputs.new_tag }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-65"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-66"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.PR_CHANGELOG_PAT }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-67"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;branch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'deploy/${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-68"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;commit-message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Updated&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;CHANGELOG&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-69"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;title&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Update&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;CHANGELOG&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-70"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# どのコミットにタグを打ったかわからなくならないようにメモ↓&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-71"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;body&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Commit&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;SHA:&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;github.sha&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-72"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-73"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Enable Pull Request Automerge&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-74"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;steps.cpr.outputs.pull-request-operation == 'created'&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-75"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;peter-evans/enable-pull-request-automerge@v1&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-76"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-77"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# repo scope の PAT を作成し、&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-78"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# GitHub Actions の secrets に登録しておく&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-79"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.PR_CHANGELOG_PAT }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-80"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;pull-request-number&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.cpr.outputs.pull-request-number }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-81"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;merge-method&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;squash&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-82"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-83"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Auto approve Pull Request&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-84"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;steps.cpr.outputs.pull-request-operation == 'created'&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-85"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;juliangruber/approve-pull-request-action@v1&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-86"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-87"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;github-token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-88"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;number&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.cpr.outputs.pull-request-number }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-89"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-90"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;deploy&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-91"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-92"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-93"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;needs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-94"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;changelog&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-95"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-96"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-97"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-98"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-99"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-100"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# changelog job で タグを打ったコミットをチェックアウトする&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-101"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# とはいえ、「ワークフローをトリガーしたコミット == タグを打ったコミット」なので、&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-102"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# 正直付けなくて良い&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-103"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;fetch-depth&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;0&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-104"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;ref&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ needs.changelog.outputs.new_tag }}&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-105"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-106"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Set tagged sha&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-107"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set-tag-sha&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-108"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# [確認用] チェックアウトしたブランチの最新の commit を取得&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-109"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-110"&gt;&lt;/a&gt;          &lt;span class="no"&gt;TAGGED_SHA=$(git log -1 --format='%H')&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-111"&gt;&lt;/a&gt;          &lt;span class="no"&gt;echo $TAGGED_SHA&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-112"&gt;&lt;/a&gt;          &lt;span class="no"&gt;echo "::set-output name=tag-sha::$TAGGED_SHA"&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-113"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-114"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-ref&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-115"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.ref }}"&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-116"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-sha&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-117"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーしたときの SHA&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-118"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.sha }}"&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-119"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo tag-sha&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-120"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# チェックアウトしたブランチの最新の commit の SHA&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-121"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# == changelog job で tag を打った SHA&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-122"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# == github-sha&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-123"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ steps.set-tag-sha.outputs.tag-sha }}"&lt;/span&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-124"&gt;&lt;/a&gt;
&lt;a name="rest_code_5692ccc23b2647d29c1f20243a1507cb-125"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# あとは deploy する (省略)&lt;/span&gt;
&lt;/pre&gt;&lt;div class="section" id="note"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id31"&gt;Note&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Create Pull Request, Enable Pull Request Automerge, Auto approve Pull Request の &lt;code class="docutils literal"&gt;token&lt;/code&gt;, &lt;code class="docutils literal"&gt;&lt;span class="pre"&gt;github-token&lt;/span&gt;&lt;/code&gt; は、
以下のとおり指定しないとうまくいかない (&lt;cite&gt;Can not approve your own pull request&lt;/cite&gt; になっちゃう)&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;Create Pull Request: &lt;code class="docutils literal"&gt;secrets.PR_CHANGELOG_PAT&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Enable Pull Request Automerge: &lt;code class="docutils literal"&gt;secrets.PR_CHANGELOG_PAT&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Auto approve Pull Request: &lt;code class="docutils literal"&gt;secrets.GITHUB_TOKEN&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;※ &lt;a class="reference external" href="https://github.com/peter-evans/enable-pull-request-automerge#example"&gt;https://github.com/peter-evans/enable-pull-request-automerge#example&lt;/a&gt; に書いてある順番&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;例えば、1 は &lt;code class="docutils literal"&gt;secrets.GITHUB_TOKEN&lt;/code&gt; も指定可能ですが、そうすると、&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;PR つくるひと -&amp;gt; 2. PR の自動マージ有効化するひと -&amp;gt; 3. PR を approve するひと =&amp;gt; 1 と 3 がいっしょになっちゃう!!&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="case4-protected-branch-pr-tag-auto-bump-changelog-tag"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id32"&gt;Case4: protected branch に PR する、 tag は auto bump (changelog と tag のコミットがいっしょ!)&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id14"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id33"&gt;条件&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Case3 と同じ&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id15"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id34"&gt;workflow&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;workflow は二本用意します&lt;/p&gt;
&lt;div class="section" id="changelog-next-tag"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id35"&gt;1. changelog 生成, next tag 払い出し&lt;/a&gt;&lt;/h4&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;ブランチを選択して、 &lt;code class="docutils literal"&gt;Run workflow&lt;/code&gt; (手動トリガー)&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;タグ version の bump up は自動でやってくれるので、通常の実行時はタグ名を指定しない&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;デフォルトが &lt;code class="docutils literal"&gt;Patch&lt;/code&gt; になっているので、 &lt;code class="docutils literal"&gt;Minor&lt;/code&gt; or &lt;code class="docutils literal"&gt;Major&lt;/code&gt; の version を bump up したいときは、 &lt;code class="docutils literal"&gt;custom_tag&lt;/code&gt; を指定する&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;デフォルトは変えられます&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を生成&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;bump up したタグ名 (&lt;code class="docutils literal"&gt;next tag&lt;/code&gt;) 払い出し&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;タグ打ちはまだしない (&lt;code class="docutils literal"&gt;dry_run: true&lt;/code&gt;)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を PR&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;code class="docutils literal"&gt;deploy&lt;/code&gt; ラベルをつける&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;body に 3 で払い出した &lt;code class="docutils literal"&gt;next tag&lt;/code&gt; を書いておく&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog の PR の自動マージを有効化&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog を PR を自動 approve =&amp;gt; Automerge される&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# Branch protection rules が適用されているブランチであれば、&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-2"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# main 以外のブランチでも実行できます&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-3"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-4"&gt;&lt;/a&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy dev (Case4-1. changelog)&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-5"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-6"&gt;&lt;/a&gt;&lt;span class="nt"&gt;on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-7"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;workflow_dispatch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-8"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;inputs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-9"&gt;&lt;/a&gt;      &lt;span class="nt"&gt;custom_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-10"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;description&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'メジャー/マイナーバージョンをインクリメントしたいときのみ指定してください&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;(e.g.&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;1.2.0)'&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-11"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-12"&gt;&lt;/a&gt;&lt;span class="nt"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-13"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-14"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bash&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-15"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-16"&gt;&lt;/a&gt;&lt;span class="nt"&gt;jobs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-17"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-18"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;changelog&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-19"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-20"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-21"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-22"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-23"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-24"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-25"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-26"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Build services&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-27"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-28"&gt;&lt;/a&gt;          &lt;span class="no"&gt;cp example.env .env&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-29"&gt;&lt;/a&gt;          &lt;span class="no"&gt;docker-compose build --parallel&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-30"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-31"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;1&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-32"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-33"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Update CHANGELOG&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-34"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose run -u 0 --rm djangoapp towncrier --yes&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-35"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-36"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Stop and remove containers, networks and volumes&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-37"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;docker-compose down -v&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-38"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;always()&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-39"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-40"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Bump tag version&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-41"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# bump up したタグ名を払い出す&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-42"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# main 以外のブランチで実行した場合は `v1.2.3-{branch_name}.0` のようなタグがつくため、&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-43"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;#  main ブランチの bump には影響しない。&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-44"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;#  ※ custom_tag に、 main ブランチのタグと同じ形式のタグ名を指定すると影響します&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-45"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bump-tag&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-46"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;mathieudutour/github-tag-action@v5.6&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-47"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-48"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;github_token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-49"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;custom_tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.event.inputs.custom_tag }}&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-50"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# タグ打ちはまだしない&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-51"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;dry_run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-52"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-53"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Create Pull Request&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-54"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;cpr&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-55"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;peter-evans/create-pull-request@v3&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-56"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-57"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;TAG_MAME&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.bump-tag.outputs.new_tag }}&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-58"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-59"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# FIXME: repo scoped の PAT が必要&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-60"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.PR_CHANGELOG_PAT }}&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-61"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;branch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'deploy/${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-62"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;commit-message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Updated&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;CHANGELOG&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-63"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;title&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Update&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;CHANGELOG&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;${{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;env.TAG_MAME&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}'&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-64"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# `deploy` label を付けておく&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-65"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;labels&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;deploy, automerge&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-66"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# deploy workflow でタグ打ちするので、 next tag を body に書いておく&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-67"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;body&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ env.TAG_MAME }}&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-68"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-69"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Enable Pull Request Automerge&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-70"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;steps.cpr.outputs.pull-request-operation == 'created'&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-71"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;peter-evans/enable-pull-request-automerge@v1&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-72"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-73"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.PR_CHANGELOG_PAT }}&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-74"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;pull-request-number&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.cpr.outputs.pull-request-number }}&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-75"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;merge-method&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;squash&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-76"&gt;&lt;/a&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-77"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Auto approve Pull Request&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-78"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;steps.cpr.outputs.pull-request-operation == 'created'&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-79"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;juliangruber/approve-pull-request-action@v1&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-80"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;with&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-81"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;github-token&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;a name="rest_code_86ac4ba85b954f1dbdf3e457e93d7e65-82"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;number&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ steps.cpr.outputs.pull-request-number }}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="tag-deploy"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id36"&gt;2. tag 打ちして deploy&lt;/a&gt;&lt;/h4&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;PR の close イベントで起動&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;以下の条件に合致する場合に deploy job を実行する&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;ワークフローをトリガーした PR が merge 済み、かつ、&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ワークフローをトリガーした PR の labels に &lt;code class="docutils literal"&gt;deploy&lt;/code&gt; が含まれる&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;changelog のコミットにタグ打ち&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;タグ名には、 PR の body から取得した next tag を使用する&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;deploy&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class="code yaml"&gt;&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-1"&gt;&lt;/a&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deploy dev (Case4-2. deploy)&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-2"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-3"&gt;&lt;/a&gt;&lt;span class="nt"&gt;on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-4"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;pull_request&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-5"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;types&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;closed&lt;/span&gt;&lt;span class="p p-Indicator"&gt;]&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-6"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-7"&gt;&lt;/a&gt;&lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-8"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;AWS_REGION&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ap-northeast-1&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-9"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;# (以下省略)&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-10"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-11"&gt;&lt;/a&gt;&lt;span class="nt"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-12"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-13"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;bash&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-14"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-15"&gt;&lt;/a&gt;&lt;span class="nt"&gt;jobs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-16"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-17"&gt;&lt;/a&gt;  &lt;span class="nt"&gt;deploy&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-18"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Tag and Deploy&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-19"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;runs-on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ubuntu-latest&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-20"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# PR が merge 済み、かつ、`deploy` label 付きの場合だけ実行&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-21"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# ほかのトピックブランチが merge -&amp;gt; close されたときには、 Skip されるよ&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-22"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;if&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;github.event.pull_request.merged == true &amp;amp;&amp;amp; contains(github.event.pull_request.labels.*.name, 'deploy')&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-23"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-24"&gt;&lt;/a&gt;    &lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-25"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Checkout&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-26"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;uses&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;actions/checkout@v2&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-27"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーした PR の マージブランチの直近のマージコミット&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-28"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# がチェックアウトされる&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-29"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-30"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-ref&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-31"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーした PR のマージブランチ&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-32"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# 例えば、PR のブランチが main から生えていたら、 `main` 、&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-33"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;#  ブランチA から生えていたら `branchA`&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-34"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.ref }}"&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-35"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-sha&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-36"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ワークフローをトリガーした PR の マージブランチの直近のマージコミット&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-37"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# == changelog の commit&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-38"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# (タイミングによっては違っちゃうこともあるかもしれない、頻度は低いが可能性としてはありえそう)&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-39"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.sha }}"&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-40"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Echo github-head-sha&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-41"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# PR のブランチで changelog を commit したときの commit&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-42"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;echo "${{ github.event.pull_request.head.sha }}"&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-43"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-44"&gt;&lt;/a&gt;      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Push tag&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-45"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-46"&gt;&lt;/a&gt;          &lt;span class="c1"&gt;# ワークフローをトリガーした PR の body から取得した next tag&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-47"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;TAG_MAME&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.event.pull_request.body }}&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-48"&gt;&lt;/a&gt;          &lt;span class="nt"&gt;COMMIT&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;${{ github.sha }}&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-49"&gt;&lt;/a&gt;        &lt;span class="nt"&gt;run&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;|&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-50"&gt;&lt;/a&gt;          &lt;span class="no"&gt;git tag $TAG_MAME $COMMIT&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-51"&gt;&lt;/a&gt;          &lt;span class="no"&gt;git push origin $TAG_MAME&lt;/span&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-52"&gt;&lt;/a&gt;
&lt;a name="rest_code_41c6c50029d54833b797bf95f96e9622-53"&gt;&lt;/a&gt;      &lt;span class="c1"&gt;# あとは deploy する (省略)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id16"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="https://32imuf.com/github/actions/changelog-tag-deploy/#id37"&gt;その他&lt;/a&gt;&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;GitHub Actions はスケジュール実行もできる。
&lt;code class="docutils literal"&gt;next tag&lt;/code&gt; がデフォルトの挙動通りで良いシーンでは、夜間に定期 deploy などしても。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://docs.github.com/ja/actions/reference/events-that-trigger-workflows#scheduled-events"&gt;スケジュールしたイベント&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;</description><category>github</category><guid>https://32imuf.com/github/actions/changelog-tag-deploy/</guid><pubDate>Sun, 19 Sep 2021 15:00:00 GMT</pubDate></item><item><title>GitHub に新しいリポジトリを作成して、pushする</title><link>https://32imuf.com/github/how-to-create-new-repository/</link><dc:creator>fumi23</dc:creator><description>&lt;div class="section" id="github-push"&gt;
&lt;h2&gt;GitHub に新しいリポジトリを作成して、pushする&lt;/h2&gt;
&lt;ol class="arabic"&gt;
&lt;li&gt;&lt;p&gt;GitHub の右上の &lt;code class="docutils literal"&gt;+&lt;/code&gt; ボタンから、 &lt;code class="docutils literal"&gt;New repository&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;リポジトリ名を入力して、作成&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;こうするといいよ、というページが表示されるので、それに従う&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre class="code console"&gt;&lt;a name="rest_code_7a0f477ce0c242c7a732c8ba99ad539c-1"&gt;&lt;/a&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git remote add origin git@github.com:fumi232323/miya.git
&lt;a name="rest_code_7a0f477ce0c242c7a732c8ba99ad539c-2"&gt;&lt;/a&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git push -u origin master
&lt;/pre&gt;&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><category>github</category><guid>https://32imuf.com/github/how-to-create-new-repository/</guid><pubDate>Sun, 09 Sep 2018 15:00:00 GMT</pubDate></item><item><title>GitHub Pages にカスタムドメインを設定する</title><link>https://32imuf.com/github/github-pages-custom-domain-setting/</link><dc:creator>fumi23</dc:creator><description>&lt;div&gt;&lt;div class="section" id="id1"&gt;
&lt;h2&gt;手順&lt;/h2&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;ドメインを購入する&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://help.github.com/articles/setting-up-an-apex-domain/#configuring-a-records-with-your-dns-provider"&gt;Configuring A records with your DNS provider&lt;/a&gt; をする&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://help.github.com/articles/adding-or-removing-a-custom-domain-for-your-github-pages-site/"&gt;Adding or removing a custom domain for your GitHub Pages site&lt;/a&gt; をする&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;カスタムドメインの良いところ&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;どこに行ってもURL が変わらないので、なくならない&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;&lt;/div&gt;</description><category>github</category><guid>https://32imuf.com/github/github-pages-custom-domain-setting/</guid><pubDate>Sat, 30 Jun 2018 15:00:00 GMT</pubDate></item></channel></rss>