<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Django REST framework のメモ/ふみのて</title>
<link rel="shortcut icon" href="../assets/icons/favicon.ico">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Griffy">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link rel="stylesheet" href="../assets/css/style.css?20191110">
</head>
<body>
    <div class="container">
      <div class="header"><header class="item item-header"><h1>
    <a href="../">
      <img class="logo" src="../assets/images/inuu.png" alt="犬"></a>
  </h1>
  <iframe src="../tags/" class="tags"></iframe>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-django-rest-framework"><time class="date" datetime="2019-07-16 00:00:00+09:00">
      2019-07-16 Tue
    </time><div class="title">Django REST framework のメモ</div>
    <div class="category">
      <a href="../tags/django-rest-framework/">
          django-rest-framework
      </a>
    </div>
    <div class="text">
      <div>
<details><summary>目次</summary><div class="contents topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id2" id="id8">ガイド/リファレンスなど</a></p></li>
<li>
<p><a class="reference internal" href="#serializers" id="id9">Serializers</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id10">シリアライズとデシリアライズ</a></p></li>
<li>
<p><a class="reference internal" href="#serializer-fields-required" id="id11">Serializer fields の required 挙動まとめ</a></p>
<ul>
<li><p><a class="reference internal" href="#deserialize" id="id12">deserialize 時</a></p></li>
<li><p><a class="reference internal" href="#serialize" id="id13">serialize 時</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#modelserializer" id="id14">ModelSerializer メモ</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#id4" id="id15">ちょっと動かしたい</a></p>
<ul>
<li><p><a class="reference internal" href="#id5" id="id16">コマンドでアクセスする場合</a></p></li>
<li><p><a class="reference internal" href="#browsable-api" id="id17">Browsable API</a></p></li>
<li><p><a class="reference internal" href="#browsable-api-html-form" id="id18">Browsable API で HTML form タブが出せる</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#id6" id="id19">便利なライブラリ</a></p>
<ul>
<li><p><a class="reference internal" href="#django-rest-framework-json-camelcase" id="id20">Django REST Framework JSON CamelCase</a></p></li>
<li>
<p><a class="reference internal" href="#django-cors-headers" id="id21">django-cors-headers</a></p>
<ul>
<li><p><a class="reference internal" href="#cors" id="id22">CORS</a></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#requests-responses" id="id23">Requests/Responses</a></p>
<ul>
<li><p><a class="reference internal" href="#drf-request" id="id24">DRF の Request</a></p></li>
<li><p><a class="reference internal" href="#drf-response" id="id25">DRF の Response</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#routers" id="id26">Routers</a></p>
<ul>
<li><p><a class="reference internal" href="#router" id="id27">Router</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#views" id="id28">Views</a></p>
<ul>
<li><p><a class="reference internal" href="#api" id="id29">API ビュー</a></p></li>
<li><p><a class="reference internal" href="#apiview" id="id30">クラスベース (APIView) で記述するのがおすすめ</a></p></li>
</ul>
</li>
</ul>
</div>
</details><div class="section" id="id2">
<h2><a class="toc-backref" href="#id8">ガイド/リファレンスなど</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.django-rest-framework.org/">Django REST framework</a></p></li>
<li><p><a class="reference external" href="http://note.crohaco.net/2018/django-rest-framework-view/">くろのて &gt; [Django REST Framework] View の使い方をまとめてみた</a></p></li>
<li><p><a class="reference external" href="http://note.crohaco.net/2018/django-rest-framework-serializer/">くろのて &gt; [Django REST Framework] Serializer の 使い方 をまとめてみた</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/kimihiro_n/items/86e0a9e619720e57ecd8">Django REST Frameworkを使って爆速でAPIを実装する</a></p></li>
</ul>
</div>
<div class="section" id="serializers">
<h2><a class="toc-backref" href="#id9">Serializers</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id10">シリアライズとデシリアライズ</a></h3>
<ul>
<li>
<p>デシリアライズ (入って来るほう)</p>
<pre class="code python"><a name="rest_code_d447e120362f451daedd46e3cfd0a671-1"></a><span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
<a name="rest_code_d447e120362f451daedd46e3cfd0a671-2"></a><span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span>
</pre>
</li>
<li>
<p>シリアライズ (出て行くほう)</p>
<pre class="code python"><a name="rest_code_873dcfb4f4214e6b9247a9125101dbb8-1"></a><span class="n">serializer</span> <span class="o">=</span> <span class="n">CommentSerializer</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
<a name="rest_code_873dcfb4f4214e6b9247a9125101dbb8-2"></a><span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
</pre>
</li>
</ul>
</div>
<div class="section" id="serializer-fields-required">
<h3><a class="toc-backref" href="#id11">Serializer fields の required 挙動まとめ</a></h3>
<p><a class="reference external" href="https://www.django-rest-framework.org/api-guide/fields/#required">https://www.django-rest-framework.org/api-guide/fields/#required</a></p>
<ul class="simple">
<li><p>デフォルトは <code class="docutils literal">required=True</code></p></li>
</ul>
<div class="section" id="deserialize">
<h4><a class="toc-backref" href="#id12">deserialize 時</a></h4>
<p><code class="docutils literal">required=True</code>:</p>
<ul class="simple">
<li><p>キーなしは当然エラー</p></li>
<li><p>キーがないとだめ</p></li>
</ul>
<p><code class="docutils literal">required=False</code>:</p>
<ul class="simple">
<li><p>キーなしは OK</p></li>
<li><p>キーあると、 <code class="docutils literal">None</code> はエラー (必須エラー)</p></li>
<li><p>キーある、かつ、 Datetime フィールドとか int フィールドだと <code class="docutils literal">''</code> はエラー (たぶん型違いエラー)</p></li>
</ul>
</div>
<div class="section" id="serialize">
<h4><a class="toc-backref" href="#id13">serialize 時</a></h4>
<p><code class="docutils literal">required=False</code>:</p>
<ul>
<li>
<p>シリアライザに項目は渡すが中身が <code class="docutils literal">None</code> (or <code class="docutils literal">''</code> とか) の場合 =&gt; キーはあるが中身は <code class="docutils literal">None</code></p>
<pre class="code python"><a name="rest_code_2a6a1c4950134347aaec16efb0084d12-1"></a><span class="p">{</span><span class="s1">'updatedAt'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">'entries'</span><span class="p">:</span> <span class="p">[]}</span>  <span class="c1"># updatedAt = None で渡した</span>
</pre>
</li>
<li>
<p>シリアライザに項目ごと渡さない場合 =&gt; キーが消える</p>
<pre class="code python"><a name="rest_code_31c6530c4e914c0c8604b948281ade06-1"></a><span class="p">{</span><span class="s1">'entries'</span><span class="p">:</span> <span class="p">[]}</span>  <span class="c1"># updatedAt を渡さなかったので、キーがない</span>
</pre>
</li>
</ul>
</div>
</div>
<div class="section" id="modelserializer">
<h3><a class="toc-backref" href="#id14">ModelSerializer メモ</a></h3>
<pre class="code python"><a name="rest_code_02593875c7d2414abe356f02d2f765ec-1"></a><span class="k">class</span> <span class="nc">EntrySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-2"></a>    <span class="sd">"""エントリー"""</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-3"></a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-4"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">Entry</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-5"></a>        <span class="c1"># 除外したいフィールド</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-6"></a>        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'author'</span><span class="p">]</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-7"></a>        <span class="c1"># 読み取り専用指定 https://www.django-rest-framework.org/api-guide/serializers/#specifying-read-only-fields</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-8"></a>        <span class="c1"># AutoField はデフォルトで読み取り専用</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-9"></a>        <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">[</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-10"></a>            <span class="s1">'created_at'</span><span class="p">,</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-11"></a>            <span class="s1">'created_by'</span><span class="p">,</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-12"></a>            <span class="s1">'created_by_id'</span><span class="p">,</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-13"></a>            <span class="s1">'updated_at'</span><span class="p">,</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-14"></a>            <span class="s1">'updated_by'</span><span class="p">,</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-15"></a>            <span class="s1">'updated_by_id'</span><span class="p">,</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-16"></a>        <span class="p">]</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-17"></a>        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-18"></a>            <span class="c1"># モデル上は必須フィールドだけれど、シリアライザでは Not必須にしたい場合は、required を上書きする</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-19"></a>            <span class="s1">'display_order'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'required'</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
<a name="rest_code_02593875c7d2414abe356f02d2f765ec-20"></a>        <span class="p">}</span>
</pre>
</div>
</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id15">ちょっと動かしたい</a></h2>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id16">コマンドでアクセスする場合</a></h3>
<pre class="code bash"><a name="rest_code_1540b53ce62340b185f3c5ce18e7f2cf-1"></a><span class="c1"># curl の場合</span>
<a name="rest_code_1540b53ce62340b185f3c5ce18e7f2cf-2"></a>$ curl -H <span class="s1">'Accept: application/json; indent=4'</span> -u &lt;username&gt;:&lt;password&gt; http://127.0.0.1:xxxx/users/
<a name="rest_code_1540b53ce62340b185f3c5ce18e7f2cf-3"></a>
<a name="rest_code_1540b53ce62340b185f3c5ce18e7f2cf-4"></a><span class="c1"># HTTPie の場合</span>
<a name="rest_code_1540b53ce62340b185f3c5ce18e7f2cf-5"></a><span class="c1"># https://httpie.org/doc</span>
<a name="rest_code_1540b53ce62340b185f3c5ce18e7f2cf-6"></a>$ http -a &lt;username&gt;:&lt;password&gt; http://127.0.0.1:8989/users/
</pre>
</div>
<div class="section" id="browsable-api">
<h3><a class="toc-backref" href="#id17">Browsable API</a></h3>
<ul class="simple">
<li><p>rest_framework.response.Response を返すと Browsable API で見られるようだ!</p></li>
</ul>
</div>
<div class="section" id="browsable-api-html-form">
<h3><a class="toc-backref" href="#id18">Browsable API で HTML form タブが出せる</a></h3>
<table class="colwidths-auto"><tbody>
<tr>
<th class="stub"><p>viewsets.ModelViewSet</p></th>
<td><p>継承するだけで出る</p></td>
</tr>
<tr>
<th class="stub"><p>APIView</p></th>
<td><p><code class="docutils literal">serializer_class = SnippetSerializer</code> を指定すると出る</p></td>
</tr>
<tr>
<th class="stub"><p>Generic view</p></th>
<td>
<p><code class="docutils literal">serializer_class = SnippetSerializer</code> を指定すると出る</p>
<ul class="simple">
<li><p>というか、指定しないとどの serializer と対応してるかわからないからどのみち指定することになる</p></li>
</ul>
</td>
</tr>
</tbody></table>
<ul class="simple">
<li><p>see: <a class="reference external" href="https://stackoverflow.com/questions/14616489/django-rest-framework-autogenerate-form-in-browsable-api">https://stackoverflow.com/questions/14616489/django-rest-framework-autogenerate-form-in-browsable-api</a></p></li>
</ul>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id19">便利なライブラリ</a></h2>
<div class="section" id="django-rest-framework-json-camelcase">
<h3><a class="toc-backref" href="#id20">Django REST Framework JSON CamelCase</a></h3>
<p><a class="reference external" href="https://pypi.org/project/djangorestframework-camel-case/">https://pypi.org/project/djangorestframework-camel-case/</a></p>
<ul class="simple">
<li><p>Camel case JSON support for Django REST framework.</p></li>
<li><p>render と parser があって、キャメルケース &lt;=&gt; スネークケース 変換してくれる</p></li>
</ul>
</div>
<div class="section" id="django-cors-headers">
<h3><a class="toc-backref" href="#id21">django-cors-headers</a></h3>
<p><a class="reference external" href="https://pypi.org/project/django-cors-headers/">https://pypi.org/project/django-cors-headers/</a></p>
<p><a class="reference external" href="https://github.com/ottoyiu/django-cors-headers">django-cors-headers</a></p>
<ul class="simple">
<li><p>A Django App that adds Cross-Origin Resource Sharing (CORS) headers to responses. This allows in-browser requests to your Django application from other origins.</p></li>
<li>
<p>レスポンスヘッダーに CORS に必要なヘッダーを足してくれる</p>
<ul>
<li><p>allow の origin からのアクセスだったら、 <code class="docutils literal"><span class="pre">Access-Control-Allow-Origin</span></code>  ヘッダーには origin が設定されて返る</p></li>
<li><p>allow じゃない origin からのアクセスだったら <code class="docutils literal"><span class="pre">Access-Control-Allow-Origin</span></code> ヘッダー自体が返らない</p></li>
<li><p>そういう実装になっている</p></li>
<li><p>理由は、「これは OK だよ」と教えちゃうと、悪いひとが偽装したりするから (きっと)</p></li>
</ul>
</li>
</ul>
<div class="section" id="cors">
<h4><a class="toc-backref" href="#id22">CORS</a></h4>
<p>オリジン間リソース共有 (Cross-Origin Resource Sharing)</p>
<ul class="simple">
<li>
<p>くわしくはここを見よ</p>
<ul>
<li><p><a class="reference external" href="https://github.com/adamchainz/django-cors-headers#about-cors">https://github.com/adamchainz/django-cors-headers#about-cors</a></p></li>
<li><p><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS</a></p></li>
<li><p><a class="reference external" href="http://note.crohaco.net/2019/http-cors-preflight/">くろのて &gt; CORS とか Preflight とかよくわかんないよな</a></p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="requests-responses">
<h2><a class="toc-backref" href="#id23">Requests/Responses</a></h2>
<div class="section" id="drf-request">
<h3><a class="toc-backref" href="#id24">DRF の Request</a></h3>
<dl class="field-list simple">
<dt>request.POST</dt>
<dd>
<p>Only handles form data. Only works for 'POST' method.</p>
</dd>
<dt>request.data</dt>
<dd>
<p>Handles arbitrary data. Works for 'POST', 'PUT' and 'PATCH' methods.</p>
<ul class="simple">
<li><p>json request をはじめとして他の形式も処理できる</p></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="drf-response">
<h3><a class="toc-backref" href="#id25">DRF の Response</a></h3>
<table class="colwidths-auto"><tbody><tr>
<th class="stub"><p>return Response(data)</p></th>
<td>
<p>Renders to content type as requested by the client.</p>
<ul class="simple">
<li><p>RESTフレームワークがレスポンスを正しいコンテンツタイプに変換してくれる</p></li>
<li><p>レスポンスが単一のコンテンツタイプに固定されていない</p></li>
</ul>
</td>
</tr></tbody></table>
</div>
</div>
<div class="section" id="routers">
<h2><a class="toc-backref" href="#id26">Routers</a></h2>
<div class="section" id="router">
<h3><a class="toc-backref" href="#id27">Router</a></h3>
<ul class="simple">
<li><p>Router で登録できるのは ViewSet だけ</p></li>
<li><p>DefaultRouter: Router のルート画面にアクセスしたときに API のリンク一覧を見せてくれる</p></li>
</ul>
</div>
</div>
<div class="section" id="views">
<h2><a class="toc-backref" href="#id28">Views</a></h2>
<div class="section" id="api">
<h3><a class="toc-backref" href="#id29">API ビュー</a></h3>
<p>RESTフレームワークには、APIビューを書くために使用できる2つのラッパーがあります。</p>
<ul class="simple">
<li><p><code class="docutils literal">@api_view</code>: 関数ベースのビューを扱うためのデコレータ。</p></li>
<li><p><code class="docutils literal">APIView</code>: クラスベースのビューを操作するためのクラス。</p></li>
</ul>
</div>
<div class="section" id="apiview">
<h3><a class="toc-backref" href="#id30">クラスベース (APIView) で記述するのがおすすめ</a></h3>
<ul class="simple">
<li>
<p>特定のモデルに紐付かないような処理は クラスベースで記述するのがおすすめと言えるでしょう。 (くろのて)</p>
<ul>
<li><p>クエリが複雑すぎて queryset じゃ処理しきれないとかで SQLAlchemy で処理した結果を返したい という場合などに APIView を使っています。 (くろのて)</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>
</html>
