<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Django: 認証システム/ふみのて</title>
<link rel="shortcut icon" href="../../assets/icons/favicon.ico">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Griffy">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link rel="stylesheet" href="../../assets/css/style.css?20191110">
</head>
<body>
    <div class="container">
      <div class="header"><header class="item item-header"><h1>
    <a href="../../">
      <img class="logo" src="../../assets/images/inuu.png" alt="犬"></a>
  </h1>
  <iframe src="../../tags/" class="tags"></iframe>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-django"><time class="date" datetime="2019-12-01 00:00:00+09:00">
      2019-12-01 Sun
    </time><div class="title">Django: 認証システム</div>
    <div class="category">
      <a href="../../tags/django/">
          django
      </a>
    </div>
    <div class="text">
      <div>
<details><summary>目次</summary><div class="contents topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li>
<p><a class="reference internal" href="#django-contrib-auth" id="id8">django.contrib.auth: 認証システム</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id9">リファレンスなど</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id10">説明</a></p></li>
</ul>
</li>
<li>
<p><a class="reference internal" href="#django-allauth" id="id11">django-allauth</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id12">リファレンスなど</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id13">概要</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id14">主な機能</a></p></li>
<li><p><a class="reference internal" href="#github" id="id15">GitHub とソーシャル連携してみる</a></p></li>
</ul>
</li>
</ul>
</div>
</details><div class="section" id="django-contrib-auth">
<h2><a class="toc-backref" href="#id8">django.contrib.auth: 認証システム</a></h2>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id9">リファレンスなど</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.djangoproject.com/ja/2.2/topics/auth/">https://docs.djangoproject.com/ja/2.2/topics/auth/</a></p></li>
<li><p><a class="reference external" href="https://booth.pm/ja/items/1030026">現場で使える Django の教科書《実践編》</a> 2章</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id10">説明</a></h3>
<p>Djangoの認証は、認証機能と権限機能の両方を共に提供しています。そして、一般的に、これらの機能を合わせて認証システムと呼びます。</p>
<ul>
<li><p>ユーザー登録/ユーザー情報変更とかはない感じ</p></li>
<li><p>テンプレートは用意されていないので、使用したいビューのテンプレートを自分で作る</p></li>
<li>
<p>設定ディレクトリの <code class="docutils literal">urls.py</code> に <code class="docutils literal">django.contrib.auth.urls</code> の include を追加すると、 以下の URL パターンが設定される</p>
<p><a class="reference external" href="https://docs.djangoproject.com/ja/2.2/topics/auth/default/#module-django.contrib.auth.views">https://docs.djangoproject.com/ja/2.2/topics/auth/default/#module-django.contrib.auth.views</a></p>
<pre class="code python"><a name="rest_code_d77eb4ac968041da88bc506306724eae-1"></a><span class="c1"># これを追加すると、↓が全部使える!! しゅごい!</span>
<a name="rest_code_d77eb4ac968041da88bc506306724eae-2"></a><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
<a name="rest_code_d77eb4ac968041da88bc506306724eae-3"></a>    <span class="n">path</span><span class="p">(</span><span class="s1">'accounts/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'django.contrib.auth.urls'</span><span class="p">)),</span>
<a name="rest_code_d77eb4ac968041da88bc506306724eae-4"></a><span class="p">]</span>
</pre>
<table class="colwidths-auto">
<thead><tr>
<th class="head"><p>機能</p></th>
<th class="head"><p>URL パターン</p></th>
<th class="head"><p>ビュー</p></th>
<th class="head"><p>フォーム</p></th>
</tr></thead>
<tbody>
<tr>
<td><p>ログイン</p></td>
<td><p>accounts/login/ [name='login']</p></td>
<td><p>LoginView</p></td>
<td><p>AuthenticationForm</p></td>
</tr>
<tr>
<td><p>ログアウト</p></td>
<td><p>accounts/logout/ [name='logout']</p></td>
<td><p>LogoutView</p></td>
<td><p>-</p></td>
</tr>
<tr>
<td><p>パスワード変更</p></td>
<td><p>accounts/password_change/ [name='password_change']</p></td>
<td><p>PasswordChangeView</p></td>
<td><p>PasswordChangeForm</p></td>
</tr>
<tr>
<td><p>パスワード変更完了</p></td>
<td><p>accounts/password_change/done/ [name='password_change_done']</p></td>
<td><p>PasswordChangeDoneView</p></td>
<td><p>-</p></td>
</tr>
<tr>
<td><p>パスワード再設定 メール送信</p></td>
<td><p>accounts/password_reset/ [name='password_reset']</p></td>
<td><p>PasswordResetView</p></td>
<td><p>PasswordResetForm</p></td>
</tr>
<tr>
<td><p>パスワード再設定 メール送信完了</p></td>
<td><p>accounts/password_reset/done/ [name='password_reset_done']</p></td>
<td><p>PasswordResetDoneView</p></td>
<td><p>-</p></td>
</tr>
<tr>
<td><p>パスワード再設定</p></td>
<td><p>accounts/reset/&lt;uidb64&gt;/&lt;token&gt;/ [name='password_reset_confirm']</p></td>
<td><p>PasswordResetConfirmView</p></td>
<td><p>SetPasswordForm</p></td>
</tr>
<tr>
<td><p>パスワード再設定 完了</p></td>
<td><p>accounts/reset/done/ [name='password_reset_complete']</p></td>
<td><p>PasswordResetCompleteView</p></td>
<td><p>-</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="django-allauth">
<h2><a class="toc-backref" href="#id11">django-allauth</a></h2>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id12">リファレンスなど</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://django-allauth.readthedocs.io/en/latest/">https://django-allauth.readthedocs.io/en/latest/</a></p></li>
<li><p><a class="reference external" href="https://booth.pm/ja/items/1030026">現場で使える Django の教科書《実践編》</a> 2章</p></li>
</ul>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id13">概要</a></h3>
<p>Django 認証システムにもっと便利になるやつを追加できる</p>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id14">主な機能</a></h3>
<ul class="simple">
<li><p>ログイン</p></li>
<li><p>ログアウト</p></li>
<li><p>パスワード変更</p></li>
<li><p>パスワード再設定</p></li>
<li><p>ユーザー登録</p></li>
<li><p>ユーザー登録時にメールを送信して登録確認</p></li>
<li><p>メールアドレスとパスワードでログイン</p></li>
<li><p>ログイン失敗回数制限</p></li>
<li>
<p>ソーシャル連携認証</p>
<ul>
<li><p><a class="reference external" href="https://python-social-auth-docs.readthedocs.io/en/latest/">https://python-social-auth-docs.readthedocs.io/en/latest/</a> こういうのもある</p></li>
</ul>
</li>
<li><p>テンプレートも用意してくれている</p></li>
</ul>
</div>
<div class="section" id="github">
<h3><a class="toc-backref" href="#id15">GitHub とソーシャル連携してみる</a></h3>
<p><a class="reference external" href="https://django-allauth.readthedocs.io/en/latest/providers.html#github">https://django-allauth.readthedocs.io/en/latest/providers.html#github</a></p>
<ul>
<li>
<p><a class="reference external" href="https://github.com/settings/developers">https://github.com/settings/developers</a> &gt; <code class="docutils literal">OAuth Apps</code>  &gt; <code class="docutils literal">Register a new OAuth application</code> で値を登録</p>
<p>e.g.
</p>
<div class="figure">
<img alt="/images/django/authentication/register-OAuth-application.png" src="../../images/django/authentication/register-OAuth-application.png">
</div>
<ul class="simple">
<li>
<p>Authorization callback URL: サービスプロバイダが認可コードを返した後に Web アプリ側にリダイレクトするための URL</p>
<ul>
<li><p>django-allauth を使う場合はこの値がサービスプロバイダによって異なる</p></li>
<li><p>サービスプロバイダごとに異なるビュー関数が用意されているため</p></li>
</ul>
</li>
<li><p>設定値は後から Update できるよ</p></li>
</ul>
</li>
<li>
<p>登録できたら <code class="docutils literal">Client ID</code> と <code class="docutils literal">Client Secret</code> を書き留めておく</p>
<dl class="field-list simple">
<dt>Client ID</dt>
<dd>
<p>e19df88ba3b567180252</p>
</dd>
<dt>Client Secret</dt>
<dd>
<p>e68ba4640f182b7ef5739fe2600bedb03b00c100</p>
</dd>
</dl>
</li>
<li>
<p>Django アプリを起動</p>
<pre class="code bash"><a name="rest_code_d17f8090df2d438582b5211eff767b13-1"></a><span class="c1"># django-allauth をインストールする</span>
<a name="rest_code_d17f8090df2d438582b5211eff767b13-2"></a>$ pip3 install django-allauth
<a name="rest_code_d17f8090df2d438582b5211eff767b13-3"></a>
<a name="rest_code_d17f8090df2d438582b5211eff767b13-4"></a><span class="c1"># Django アプリを起動する</span>
<a name="rest_code_d17f8090df2d438582b5211eff767b13-5"></a>$ python3 manage.py migrate
<a name="rest_code_d17f8090df2d438582b5211eff767b13-6"></a>$ python3 manage.py createsuperuser
<a name="rest_code_d17f8090df2d438582b5211eff767b13-7"></a>$ python3 manage.py runserver <span class="m">0</span>.0.0.0:8181
<a name="rest_code_d17f8090df2d438582b5211eff767b13-8"></a>
<a name="rest_code_d17f8090df2d438582b5211eff767b13-9"></a>* http://localhost:8181/admin/ へログイン
<a name="rest_code_d17f8090df2d438582b5211eff767b13-10"></a>* http://localhost:8181/admin/sites/site/ にレコードが1件あることを確認
<a name="rest_code_d17f8090df2d438582b5211eff767b13-11"></a>* http://localhost:8181/admin/socialaccount/socialapp/ に GitHub で登録した <span class="sb">``</span>Client ID<span class="sb">``</span> と <span class="sb">``</span>Client Secret<span class="sb">``</span> を設定
</pre>
</li>
<li>
<p>動作確認する</p>
<ul>
<li><p>admin サイトからログアウト</p></li>
<li><p>GitHub もログアウト</p></li>
<li><p><a class="reference external" href="http://localhost:8181/accounts/login/">http://localhost:8181/accounts/login/</a> へアクセス</p></li>
<li>
<p>GitHub リンク押下</p>
<p></p>
<div class="figure">
<img alt="/images/django/authentication/login.png" src="../../images/django/authentication/login.png">
</div>
<div class="figure">
<img alt="/images/django/authentication/sign-in-to-github.png" src="../../images/django/authentication/sign-in-to-github.png">
</div>
<div class="figure">
<img alt="/images/django/authentication/authorize-fuminote.png" src="../../images/django/authentication/authorize-fuminote.png">
</div>
</li>
<li>
<p>ログインできた</p>
<ul class="simple">
<li><p>今今 callback URL がエラーになる =&gt; たぶんメールを設定していないせい?っぽい?</p></li>
<li><p>あとでやってみる</p></li>
</ul>
<p></p>
<div class="figure">
<img alt="/images/django/authentication/home.png" src="../../images/django/authentication/home.png">
</div>
</li>
</ul>
</li>
<li>
<p><a class="reference external" href="http://localhost:8181/accounts/social/connections/">http://localhost:8181/accounts/social/connections/</a> でソーシャル連携解除できる</p>
<p></p>
<div class="figure">
<img alt="/images/django/authentication/social-connections.png" src="../../images/django/authentication/social-connections.png">
</div>
</li>
<li>
<p>settings</p>
<p></p>
<div class="code-block ">
<div class="code-block-label">settings.py</div>
<div class="highlight"><pre><span></span><span class="sd">"""</span>
<span class="sd">Django settings for fufu project.</span>

<span class="sd">Generated by 'django-admin startproject' using Django 2.2.7.</span>

<span class="sd">For more information on this file, see</span>
<span class="sd">https://docs.djangoproject.com/en/2.2/topics/settings/</span>

<span class="sd">For the full list of settings and their values, see</span>
<span class="sd">https://docs.djangoproject.com/en/2.2/ref/settings/</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Build paths inside the project like this: os.path.join(BASE_DIR, ...)</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>


<span class="c1"># Quick-start development settings - unsuitable for production</span>
<span class="c1"># See https://docs.djangoproject.com/en/2.2/howto/deployment/checklist/</span>

<span class="c1"># SECURITY WARNING: keep the secret key used in production secret!</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s1">'o=uce-pwytvkyjsg8vv12#5zvh765-w!ph==vxs#_(^nw(in$='</span>

<span class="c1"># SECURITY WARNING: don't run with debug turned on in production!</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'*'</span><span class="p">]</span>

<span class="c1"># Application definition</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="c1"># django-allauth ######</span>
    <span class="s1">'django.contrib.sites'</span><span class="p">,</span>  <span class="c1"># django-allauth では sites フレームワーク必須</span>
    <span class="s1">'allauth'</span><span class="p">,</span>
    <span class="s1">'allauth.account'</span><span class="p">,</span>
    <span class="s1">'allauth.socialaccount'</span><span class="p">,</span>
    <span class="s1">'allauth.socialaccount.providers.github'</span><span class="p">,</span>  <span class="c1"># GitHub とソーシャル連携</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.middleware.security.SecurityMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.common.CommonMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="s1">'fufu.urls'</span>

<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">'BACKEND'</span><span class="p">:</span> <span class="s1">'django.template.backends.django.DjangoTemplates'</span><span class="p">,</span>
        <span class="s1">'DIRS'</span><span class="p">:</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">'templates'</span><span class="p">)]</span>
        <span class="p">,</span>
        <span class="s1">'APP_DIRS'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s1">'OPTIONS'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'context_processors'</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">'django.template.context_processors.debug'</span><span class="p">,</span>
                <span class="s1">'django.template.context_processors.request'</span><span class="p">,</span>
                <span class="s1">'django.contrib.auth.context_processors.auth'</span><span class="p">,</span>
                <span class="s1">'django.contrib.messages.context_processors.messages'</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">WSGI_APPLICATION</span> <span class="o">=</span> <span class="s1">'fufu.wsgi.application'</span>


<span class="c1"># Database</span>
<span class="c1"># https://docs.djangoproject.com/en/2.2/ref/settings/#databases</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'ENGINE'</span><span class="p">:</span> <span class="s1">'django.db.backends.sqlite3'</span><span class="p">,</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">'db.sqlite3'</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1"># Password validation</span>
<span class="c1"># https://docs.djangoproject.com/en/2.2/ref/settings/#auth-password-validators</span>

<span class="n">AUTH_PASSWORD_VALIDATORS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="s1">'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="s1">'django.contrib.auth.password_validation.MinimumLengthValidator'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="s1">'django.contrib.auth.password_validation.CommonPasswordValidator'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="s1">'django.contrib.auth.password_validation.NumericPasswordValidator'</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>


<span class="c1"># Internationalization</span>
<span class="c1"># https://docs.djangoproject.com/en/2.2/topics/i18n/</span>

<span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s1">'ja'</span>

<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s1">'Asia/Tokyo'</span>

<span class="n">USE_I18N</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">USE_L10N</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">USE_TZ</span> <span class="o">=</span> <span class="bp">True</span>


<span class="c1"># Static files (CSS, JavaScript, Images)</span>
<span class="c1"># https://docs.djangoproject.com/en/2.2/howto/static-files/</span>

<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s1">'/static/'</span>

<span class="c1">##################</span>
<span class="c1"># Authentication #</span>
<span class="c1">##################</span>

<span class="c1"># メールアドレスとパスワードで認証</span>
<span class="n">AUTHENTICATION_BACKENDS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c1"># デフォルト, これを残しておくと管理画面はユーザー名/パスワードで認証できる</span>
    <span class="s1">'django.contrib.auth.backends.ModelBackend'</span><span class="p">,</span>
    <span class="s1">'allauth.account.auth_backends.AuthenticationBackend'</span><span class="p">,</span>  <span class="c1"># 追加</span>
<span class="p">)</span>
<span class="c1"># 認証⽅式を 「メールアドレスとパスワード」 に変更</span>
<span class="n">ACCOUNT_AUTHENTICATION_METHOD</span> <span class="o">=</span> <span class="s1">'email'</span>
<span class="c1"># ユーザー名は使⽤しない</span>
<span class="n">ACCOUNT_USERNAME_REQUIRED</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">SITE_ID</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">LOGIN_REDIRECT_URL</span> <span class="o">=</span> <span class="s1">'home'</span>
<span class="n">ACCOUNT_LOGOUT_REDIRECT_URL</span> <span class="o">=</span> <span class="s1">'/accounts/login/'</span>

<span class="c1"># ログアウトリンクログアウトさせたい場合 True</span>
<span class="c1"># (デフォルトはログアウト画面経由で POST リクエスト)</span>
<span class="n">ACCOUNT_LOGOUT_ON_GET</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># ユーザー登録時にメールアドレス確認を行う</span>
<span class="n">ACCOUNT_EMAIL_VARIFICATION</span> <span class="o">=</span> <span class="s1">'mandatory'</span>
<span class="c1"># ユーザー登録時にメールアドレス確認を行わない</span>
<span class="c1"># ACCOUNT_EMAIL_VARIFICATION = 'none'</span>
<span class="c1"># ユーザー登録画面でにEmailを必須項目にする</span>
<span class="n">ACCOUNT_EMAIL_REQUIRED</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>
</html>
