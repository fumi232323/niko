<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Django なんでもメモ/ふみのて</title>
<link rel="shortcut icon" href="../../assets/icons/favicon.ico">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Griffy">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link rel="stylesheet" href="../../assets/css/style.css?20190615">
</head>
<body>
    <div class="container">
      <div class="header"><header class="item item-header"><h1>
    <a href="../../">
      <img class="logo" src="../../assets/images/inuu.png" alt="犬"></a>
  </h1>
  <iframe src="../../tags/" class="tags"></iframe>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-django"><time class="date" datetime="2019-06-18 00:00:00+09:00">
      2019-06-18 Tue
    </time><div class="title">Django なんでもメモ</div>
    <div class="category">
      <a href="../../tags/django/">
          django
      </a>
    </div>
    <div class="text">
      <div>
<details><summary>目次</summary><div class="contents topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li>
<a class="reference internal" href="#time-zones" id="id11">Time zones</a><ul>
<li><a class="reference internal" href="#id2" id="id12">リファレンス</a></li>
<li><a class="reference internal" href="#id3" id="id13">タイムゾーンサポート</a></li>
<li><a class="reference internal" href="#naive-aware" id="id14">naive と aware</a></li>
<li><a class="reference internal" href="#django" id="id15">タイムゾーンサポートが有効なときの Django の日時の取り扱い方</a></li>
<li><a class="reference internal" href="#id4" id="id16">現在日時の取得方法</a></li>
<li><a class="reference internal" href="#id5" id="id17">デフォルトタイムゾーンとカレントタイムゾーン</a></li>
<li><a class="reference internal" href="#naive-django" id="id18">naive な日時をデータベースに保存しようとすると、Django は警告を出す</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id19">マイグレーションを間違えたときのリカバリ方法</a></li>
<li>
<a class="reference internal" href="#id7" id="id20">こんなのある</a><ul>
<li><a class="reference internal" href="#multivaluedict" id="id21">MultiValueDict</a></li>
<li><a class="reference internal" href="#querydict" id="id22">QueryDict オブジェクト</a></li>
</ul>
</li>
<li>
<a class="reference internal" href="#id9" id="id23">便利さん</a><ul>
<li><a class="reference internal" href="#id10" id="id24">django に便利コマンド追加してくれるさん</a></li>
</ul>
</li>
</ul>
</div>
</details><div class="section" id="time-zones">
<h2><a class="toc-backref" href="#id11">Time zones</a></h2>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id12">リファレンス</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://docs.djangoproject.com/ja/2.2/topics/i18n/timezones/">https://docs.djangoproject.com/ja/2.2/topics/i18n/timezones/</a></li>
</ul>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id13">タイムゾーンサポート</a></h3>
<ul class="simple">
<li>
<tt class="docutils literal">settings.py</tt> で設定する<ul>
<li>
<tt class="docutils literal">USE_TZ = True</tt>: タイムゾーンサポートが有効</li>
<li>
<tt class="docutils literal">USE_TZ = False</tt>: タイムゾーンサポートが無効 (default)</li>
</ul>
</li>
<li>
<tt class="docutils literal"><span class="pre">django-admin</span> startproject</tt> によって生成されるデフォルトの <tt class="docutils literal">settings.py</tt> ファイル は、 <tt class="docutils literal">USE_TZ = True</tt>
</li>
<li>タイムゾーンのサポートは <tt class="docutils literal">pytz</tt> を使用する。Django をインストールしたときに一緒にインストールされている。</li>
</ul>
</div>
<div class="section" id="naive-aware">
<h3><a class="toc-backref" href="#id14">naive と aware</a></h3>
<ul class="simple">
<li>aware: タイムゾーンあり<ul>
<li>Python の <tt class="docutils literal">datetime.datetime</tt> のオブジェクトには、タイムゾーン情報を保持するために使える tzinfo 属性があり、これは <tt class="docutils literal">datetime.tzinfo</tt> のサブクラスのインスタンスで表されます。</li>
<li>この属性がセットされオフセットを示すとき、datetime オブジェクトは aware となります。それ以外の場合は naive となります。</li>
</ul>
</li>
<li>naive: タイムゾーンなし</li>
</ul>
</div>
<div class="section" id="django">
<h3><a class="toc-backref" href="#id15">タイムゾーンサポートが有効なときの Django の日時の取り扱い方</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name">
<col class="field-body">
<tbody valign="top">
<tr class="field">
<th class="field-name">データベース:</th>
<td class="field-body">内部的に aware なタイムゾーンオブジェクトを使用して、 UTC で保持</td>
</tr>
<tr class="field">
<th class="field-name">フォーム:</th>
<td class="field-body">入力された日時をカレントタイムゾーンで変換し、 cleaned_data 内で aware な datetime オブジェクトを返す</td>
</tr>
<tr class="field">
<th class="field-name">テンプレート:</th>
<td class="field-body">レンダリングする際に aware な datetime オブジェクトをカレントタイムゾーンに変換する</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id16">現在日時の取得方法</a></h3>
<blockquote>
<pre class="code python"><a name="rest_code_de9b9b99a089424ca33987538ba11517-1"></a><span class="c1"># タイムゾーンサポートが有効</span>
<a name="rest_code_de9b9b99a089424ca33987538ba11517-2"></a><span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<a name="rest_code_de9b9b99a089424ca33987538ba11517-3"></a><span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a name="rest_code_de9b9b99a089424ca33987538ba11517-4"></a>
<a name="rest_code_de9b9b99a089424ca33987538ba11517-5"></a><span class="c1"># タイムゾーンサポートが無効</span>
<a name="rest_code_de9b9b99a089424ca33987538ba11517-6"></a><span class="kn">import</span> <span class="nn">datetime</span>
<a name="rest_code_de9b9b99a089424ca33987538ba11517-7"></a><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</pre>
</blockquote>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id17">デフォルトタイムゾーンとカレントタイムゾーン</a></h3>
<ul class="simple">
<li>デフォルトタイムゾーン: <tt class="docutils literal">settings.TIME_ZONE</tt> に定義されたタイムゾーン</li>
<li>カレントタイムゾーン: レンダリングに使われるタイムゾーン</li>
</ul>
</div>
<div class="section" id="naive-django">
<h3><a class="toc-backref" href="#id18">naive な日時をデータベースに保存しようとすると、Django は警告を出す</a></h3>
<pre class="code python"><a name="rest_code_eb62c54cac82497780d7aeebcf44eb93-1"></a><span class="ne">RuntimeWarning</span><span class="p">:</span> <span class="n">DateTimeField</span> <span class="n">ModelName</span><span class="o">.</span><span class="n">field_name</span> <span class="n">received</span> <span class="n">a</span> <span class="n">naive</span>
<a name="rest_code_eb62c54cac82497780d7aeebcf44eb93-2"></a><span class="n">datetime</span> <span class="p">(</span><span class="mi">2012</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">01</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">)</span> <span class="k">while</span> <span class="n">time</span> <span class="n">zone</span> <span class="n">support</span> <span class="ow">is</span> <span class="n">active</span><span class="o">.</span>
</pre>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id19">マイグレーションを間違えたときのリカバリ方法</a></h2>
<ol class="arabic">
<li>
<p class="first">DjangoのDBシェルでローカルDBにつなぐ</p>
<blockquote>
<pre class="code console"><a name="rest_code_7d97cbebf5314d8382c439866c201abb-1"></a><span class="gp">$</span> python manage.py dbshell --settings<span class="o">=</span>settings.local
</pre>
</blockquote>
</li>
<li>
<p class="first">django_migrations テーブルから該当アプリのレコードを削除する</p>
<blockquote>
<pre class="code sql"><a name="rest_code_b14bbc67b72342a38938e405813e17d1-1"></a><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">django_migrations</span> <span class="k">WHERE</span> <span class="n">app</span> <span class="k">like</span> <span class="s1">'%{application_name}%'</span><span class="p">;</span>
<a name="rest_code_b14bbc67b72342a38938e405813e17d1-2"></a><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">django_migrations</span> <span class="k">WHERE</span> <span class="n">id</span><span class="o">=</span><span class="err">{該当の</span><span class="n">ID</span><span class="err">}</span><span class="p">;</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">該当テーブルやカラムも DROP する</p>
<blockquote>
<pre class="code sql"><a name="rest_code_01529d78608f474eac827c7a660fd83e-1"></a><span class="k">DROP</span> <span class="k">TABLE</span> <span class="err">{</span><span class="k">table_name</span><span class="err">}</span><span class="p">;</span>
<a name="rest_code_01529d78608f474eac827c7a660fd83e-2"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="err">{</span><span class="k">table_name</span><span class="err">}</span> <span class="k">DROP</span> <span class="k">COLUMN</span> <span class="err">{</span><span class="k">column_name</span><span class="err">}</span><span class="p">;</span>
</pre>
</blockquote>
</li>
<li>
<p class="first">該当のマイグレーションファイルも削除しておく</p>
</li>
<li>
<p class="first">もう一回最初からマイグレーションする</p>
<blockquote>
<pre class="code console"><a name="rest_code_1ac982f7ec3649308749fb219e8628c7-1"></a><span class="gp">$</span> python manage.py makemigrations <span class="o">{</span>application_name<span class="o">}</span> --settings<span class="o">=</span>settings.local
<a name="rest_code_1ac982f7ec3649308749fb219e8628c7-2"></a><span class="gp">$</span> python manage.py migrate <span class="o">{</span>application_name<span class="o">}</span> --settings<span class="o">=</span>settings.local
</pre>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id20">こんなのある</a></h2>
<div class="section" id="multivaluedict">
<h3><a class="toc-backref" href="#id21">MultiValueDict</a></h3>
<p>なにがうれしいのかさっぱりわからない =&gt; <cite>MultiValueDict を継承してる QueryDict とか見るとユースケースはなんとなく想像つくと思います</cite> と教えて頂いた。</p>
<ul>
<li>
<p class="first"><a class="reference external" href="https://docs.djangoproject.com/ja/2.1/_modules/django/utils/datastructures/">https://docs.djangoproject.com/ja/2.1/_modules/django/utils/datastructures/</a></p>
<pre class="literal-block">
A subclass of dictionary customized to handle multiple values for the same key.
</pre>
</li>
<li>
<p class="first">よく見たら、こういうところが便利だと思った ↓</p>
<pre class="code python"><a name="rest_code_b4663b791aa54d9eb9633e351568b73c-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">django.utils.datastructures</span> <span class="kn">import</span> <span class="n">MultiValueDict</span>
<a name="rest_code_b4663b791aa54d9eb9633e351568b73c-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">MultiValueDict</span><span class="p">({</span><span class="s1">'name'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Adrian'</span><span class="p">,</span> <span class="s1">'Simon'</span><span class="p">],</span> <span class="s1">'position'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Developer'</span><span class="p">]})</span>
<a name="rest_code_b4663b791aa54d9eb9633e351568b73c-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'name'</span><span class="p">:</span> <span class="s1">'Momo'</span><span class="p">})</span>
<a name="rest_code_b4663b791aa54d9eb9633e351568b73c-4"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">d</span>
<a name="rest_code_b4663b791aa54d9eb9633e351568b73c-5"></a><span class="o">&lt;</span><span class="n">MultiValueDict</span><span class="p">:</span> <span class="p">{</span><span class="s1">'position'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Developer'</span><span class="p">],</span> <span class="s1">'name'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Adrian'</span><span class="p">,</span> <span class="s1">'Simon'</span><span class="p">,</span> <span class="s1">'Momo'</span><span class="p">]}</span><span class="o">&gt;</span>
<a name="rest_code_b4663b791aa54d9eb9633e351568b73c-6"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'name'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Adrian'</span><span class="p">,</span> <span class="s1">'Simon'</span><span class="p">],</span> <span class="s1">'position'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Developer'</span><span class="p">]}</span>
<a name="rest_code_b4663b791aa54d9eb9633e351568b73c-7"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'name'</span><span class="p">:</span> <span class="s1">'Momo'</span><span class="p">})</span>
<a name="rest_code_b4663b791aa54d9eb9633e351568b73c-8"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span>
<a name="rest_code_b4663b791aa54d9eb9633e351568b73c-9"></a><span class="p">{</span><span class="s1">'position'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Developer'</span><span class="p">],</span> <span class="s1">'name'</span><span class="p">:</span> <span class="s1">'Momo'</span><span class="p">}</span>
</pre>
</li>
</ul>
</div>
<div class="section" id="querydict">
<h3><a class="toc-backref" href="#id22">QueryDict オブジェクト</a></h3>
<p><cite>In an HttpRequest object, the GET and POST attributes are instances of django.http.QueryDict</cite> だそうです。</p>
<blockquote>
<ul>
<li>
<p class="first"><a class="reference external" href="https://docs.djangoproject.com/ja/2.1/ref/request-response/#querydict-objects">QueryDict オブジェクト</a></p>
<pre class="literal-block">
In an HttpRequest object, the GET and POST attributes are instances of django.http.QueryDict, a dictionary-like class customized to deal with multiple values for the same key. This is necessary because some HTML form elements, notably &lt;select multiple&gt;, pass multiple values for the same key.
</pre>
</li>
</ul>
</blockquote>
</div>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id23">便利さん</a></h2>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id24">django に便利コマンド追加してくれるさん</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://django-extensions.readthedocs.io/en/latest/">django-extensions</a></li>
</ul>
</div>
</div>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>
</html>
